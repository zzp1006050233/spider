{"url_object_id": "627fba360f907b35e30cde7e75e233df", "title": "软件复杂性正在杀死我们", "url": "http://blog.jobbole.com/113820/", "created_date": "2018/04/14", "front_image_url": ["http://ww3.sinaimg.cn/mw690/7cc829d3gw1ezy0oepjyrj21hc0u0wk6.jpg"], "praise_nums": "1", "comments_nums": 0, "fav_nums": 0, "tags": "业界", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/wx138099575\">风木</a> 翻译，<a href=\"http://www.jobbole.com/members/hanxiaomax\">艾凌风</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://www.simplethread.com/software-complexity-killing-us/\">Justin Etheredge</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p>代码量少了不代表软件的复杂度降低了，而是编程语言的表达力更强了。太多开发人员痴迷于框架，过度追求软件灵活性、可组合性等等，而忘记自己是不是真的需要这些。</p>\n<hr>\n<p><img class=\"alignnone\" src=\"http://ww3.sinaimg.cn/mw690/7cc829d3gw1ezy0oepjyrj21hc0u0wk6.jpg\" width=\"690\" height=\"388\"></p>\n<p>在有软件之前，只有黑暗。自从时代的黎明到来后，一直存在一个不变的事实：企业想要构建价格更低、运行更快的软件。</p>\n<p>当然，这是可以理解并且值得称赞的目标——尤其是你曾经花费时间跟软件开发人员打过交道。每个工程师都应该全心支持此目标，并且在当前环境的约束下，应该始终努力尽可能有效率地创造产品。</p>\n<p>然而，事实上，我们经常做不到这一点。并非故意为之，只是随着时间流逝，在构建软件时会因为意料之外的复杂性而陷入困境，因此自我训练以寻找边界案例、差距分析以及所有可能起源于同一个需求要点的隐藏故障。</p>\n<p>我们被大量的复杂度以及设计优雅解决方案的精神执念所迷惑：另一层抽象！干起来！分离相关量！继承构成！这也是可以理解的，但是在这个过程中，我们经常忽略正在被解决的业务问题，忘记管理复杂度是软件开发人员<strong>次重要</strong>的责任。</p>\n<p><strong>为什么会造成现在这样的局面？</strong></p>\n<h3>软件在某些方面上已经变得更加简单了</h3>\n<p>在过去的几十年里，软件产业非常成功地降低了编写大多数软件所需要的自定义代码量。</p>\n<p>这种减少大部分是通过使编程语言更有表现性来实现的。像 Python、Ruby 或 JavaScript 这些语言可以用<strong>不到 </strong>C 语言<strong>三分之一的代码</strong>来实现相似的功能。使用 C 语言取代汇编语言编写程序也同样带来了类似的优势。可以预见，在未来，语言设计不大可能带来如同过去几十年一样的改进。</p>\n<p>然而也有很多其他不需要让语言更具有表现力的方法，可以精简构建软件的代码总量。截止到现在，在过去的二十年里，我们最大的收获是开源软件（OSS）。如果没有个人和公司将资金投入到他们为社区免费赠予的软件中，没有这么多的代价和努力，那么我们今天所构建的大部分软件将不会实现。</p>\n<p>这些项目使我们能够站在巨人的肩膀上解决问题，利用工具让我们更专注于解决业务问题，而不是花时间建设基础设施。</p>\n<p>也就是说，业务是复杂的。可笑的复杂，而且只会更多，开源软件非常适合生成用以构建系统的框架和工具，但在很大程度上为了获得关注，又必须解决大量人员共享的问题。因此，大多数开源项目要么是相对通用的，要么是处于非常受欢迎的领域。因此，这些工具中的大部分都是建立系统的绝佳平台，但最终我们仍然需要在日益复杂且要求苛刻的系统中构建所有业务逻辑和接口。</p>\n<p>所以我们剩下的是一个看起来像这样的栈（对于 web 应用程序）…</p>\n<blockquote><p>&lt;Our Code/我们的代码&gt;<br>\n&lt;Libraries/库&gt;<br>\n&lt;Web Framework/Web 框架&gt;<br>\n&lt;Web Server/Web 服务器&gt;<br>\n&lt;Data Stores/数据存储&gt;<br>\n&lt;Operating System/操作系统&gt;</p></blockquote>\n<p>“Our Code”部分最终变得非常复杂，因为它反映了业务及其流程。如果我们有自定义的业务逻辑和自定义流程，那么我们只需编写组建应用程序的接口、工作流程和逻辑即可。当然，我们可以尝试用不同的方式来记录该逻辑（记住业务规则引擎？），但最终，没有其他人会为您的业务编写业务逻辑。实际上似乎没有办法解决这个问题……至少是在机器人到来并将我们从工作中解救出来之前。</p>\n<h3>不喜欢代码，那么低代码（Low-Code）如何？</h3>\n<p>如果我们必须开发应用程序的接口、工作流程和逻辑，这听起来像是难住我们了，对吗？ 在某种程度上，是的，但我们仍有几个选择。</p>\n<p>对于大多数开发者来说，软件等于代码，现实并非如此。 开发软件有许多方法，其中一种是使用可视化工具。 在网络普及之前，视觉开发和 RAD 工具在市场上占有更大的地位。 诸如 PowerBuilder、visual Foxpro、Delphi、VB 和 Access 等工具都具有可视化设计功能，允许开发人员在不输入任何代码的情况下创建界面。</p>\n<p>这些工具涵盖了需要编写的代码，但总的来说，你可以直观地设计应用程序，然后编写大量代码来实现应用程序的逻辑。 在很多情况下，你仍然用编程操作接口，因为使用这些工具构建的接口通常是静态的。 但是，对于大量应用程序，这些工具通过舍弃其他性能获得了巨大的生产力，主要是以灵活性为代价。</p>\n<p>自从网络兴起后，这些工具可能已经不再流行，但公司对它们的渴望并没有降低，尤其是因为势不可挡的软件需求仍然持续不断。 整个行业最新趋势是“低代码”系统。 低代码开发工具是最新一代拖放式软件开发工具的现代术语。 这些工具和其他工具之间最大的区别在于，它们主要基于 Web（和移动端），并且通常被托管于云平台。</p>\n<p>许多公司正活跃于这些平台上。Salesforce（App Cloud）、Outsystems、Mendix 以及 Kony 等厂商承诺能够比“传统”应用程序开发快许多倍。 虽然他们的很多说法可能很夸张，但也有一定的可信度。依赖类似上述平台的所有弊端，可能的确导致某些类型的程序比使用 .NET 或 Java 的传统程序开发更快。</p>\n<h3>那么，问题是什么呢？</h3>\n<p>的确有几个问题。 首先，有经验的开发人员经常讨厌这些工具。 大多数严肃的开发人员™ 喜欢使用真实代码™ 编写真正的软件™。 我知道这听起来像我正在迎合一群呜咽的婴儿（也许我有点儿），但如果你传递的核心价值是技术，那么采用顶尖开发人员不喜欢使用的工具并非是个好主意。</p>\n<p>其次，像我这样的人看着这些被封装的平台，说“不，不要在这里构建应用程序”。这是合情合理的忧虑，也是最让我困扰的事情。</p>\n<p>如果你 10 年前用 PHP 搭建了一个应用程序，那么这个应用程序可能会显老，但它现在仍然可以嗡嗡作响。 语言和生态系统都是开源的，并由社区维护的。 你需要保持应用程序持续更新，却不必担心供应商断定不再值得花时间支持。</p>\n<blockquote><p>像我这样的人看着这些被封装的平台，说“不，不要在这里构建应用程序”。这是合情合理的忧虑，也是最让我困扰的事情。</p></blockquote>\n<p>如果你 10 年前选择了有自己平台的供应商，那么如果他们关闭工具或频繁更改工具（<a href=\"https://techcrunch.com/2017/01/30/facebooks-parse-developer-platform-is-shutting-down-today/\">还记得 Parse 么？</a>），你可能会被迫重写程序。或者更糟，你的系统会停滞在一个停止更新、不再支持服务的平台上。</p>\n<p>有很多理由去警惕这类平台，但对许多企业来说，以更少的付出来搭建软件太具诱惑以至于不忍拒绝。 软件的复杂性仍在持续，不幸的是软件工程师帮不上任何忙。</p>\n<h3>什么需要改变？</h3>\n<p>有高效的平台，可以让我们用真实代码™ 构建真正的软件™，但不幸的是，软件行业太过担心于跟随科技巨头地领导，以至于没有意识到他们的工具并没有对项目添加任何价值。</p>\n<p>我无法告诉你有多少次，曾遇到开发人员跟我说，相比于仅仅渲染 HTML，构建单一页面应用程序（SPA）类似的东西并不会增加开销。我曾听开发人员说过，所有应用都应该基于 NoSQL 数据库来开发，而关系数据库逐渐没落了。也曾听开发人员质疑为什么应用程序不是用 CQRS 和事件溯源编写的。</p>\n<p>正是这种思维过程和常规的开销导致公司认为软件开发过于昂贵。 你可能会说，“但事件溯源如此优雅！在微服务之上搭建 SPA 如此整洁！”当然，它可能是，但对你这种正在写十个微服务的人来说不是这样的。这种额外的复杂性往往是<strong>不必要的</strong>。</p>\n<p>作为从业人员，我们需要找到各种方法来简化搭建软件的过程，并且不忽视业务的合理复杂性。 我们需要承认，并非每个应用程序都需要与 Gmail 相同层次的界面复杂性和运营扩展性。 有很多应用程序需要经过深思熟虑的界面、复杂的逻辑、坚实的体系结构、流畅的工作流程等。但不需要微服务、AI、chatbots、NoSQL、Redux、Kafka、Containers 或任何类似的工具。</p>\n<p>如今很多开发人员似乎对技术能力非常着迷，以至于他们不能退后一步，问问自己是否真的需要这些。</p>\n<p>就像 MasterChef 上的人一样，他们以分子美食家的身份入场兜售自己。 他们将原料分成不同的组成部分，使用科学配对口味的方法，然后用大量的二氧化碳和液氮来制作你见过的最有创意的食物。 然后他们会在一两集之后被踢开，因为他们忘记了大多数烹饪的核心原则，即食物需要口感好。 他们似乎真的很惊讶于没有人喜欢他们发酵的茴香和芒果精华珍珠加上抹了鳀鱼沫的鳕鱼肉。</p>\n<p>对灵活性、可组合性和机敏性的痴迷正在给我们带来巨大的痛苦，并迫使公司远离我们所喜爱的平台和工具。 并不是说我上面列出的那些工具不会增加价值，尽管大公司在大规模操作系统时会遇到典型问题，工具也仅是为了解决真正的痛点而产生的。</p>\n<p>我所说的是，我们需要回到简单化的方向，并开始以更简单的方式创造事物，而不是仅仅一直讨论简单性。 也许我们可以依靠更多的<strong>集成</strong>技术栈来提供开箱即用的模式和工具，以便软件开发人员能够更高效地创建软件。</p>\n<blockquote><p>我们将把越来越多的业务添加到“低代码”平台和其他通过简化、移除起初写过的代码来降低软件成本的工具中。</p></blockquote>\n<p>我们需要停止假装二十行的程序是一些需要认真手工缝制的独特挂毯。</p>\n<h3>聚焦简单性</h3>\n<p>写完之后，我仿佛听到一百万位开发人员磨刀的声音，但我相信如果我们继续坚持如下方向：想写所有东西、配置一切、编写所有内容、无论多大规模的问题都使用相同的堆栈，那么我们将把越来越多的业务添加到“低代码”平台和其他通过简化、移除起初写过的代码来降低软件成本的工具中。</p>\n<p>我们对业务日益复杂的回答不会增加开发过程的复杂性 – 无论它看起来多么优雅。</p>\n<p>我们必须设法通过简化开发流程来管理复杂性。 因为管理复杂性是次重要的责任，我们必须始终记住软件开发人员最重要的责任：通过使用软件来实现价值。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113820\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113820votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113820\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/wx138099575\">风木</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/wx138099575\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2018/03/e496dcafc16ff266b061f892352783db.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            简介还没来得及写 :）        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/wx138099575\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/wx138099575/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/wx138099575/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 10</a> · <a title=\"微博主页\" target=\"_blank\" href=\"https://weibo.com/6426355449/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo&amp;is_all=1\"><i class=\"fa fa-weibo\"></i></a>         </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/1ee8b23b2be55de42dc12bc7e4b5d4a4385a1ff4.jpg"}{"url_object_id": "a0e861fe08356d9eabe96fbd21c0753d", "title": "使用 Graylog 和 Prometheus 监视 Kubernetes 集群", "url": "http://blog.jobbole.com/113875/", "created_date": "2018/04/13", "front_image_url": ["https://dn-linuxcn.qbox.me/data/attachment/album/201804/10/182842hu1toaq9hhh9uiou.png"], "praise_nums": "1", "comments_nums": 2, "fav_nums": 2, "tags": "IT技术,集群", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://insights.ubuntu.com/2018/01/16/monitor-your-kubernetes-cluster/\">Kevin Monroe</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-9534-1.html\">Linux中国/qhwdw</a>   </div><p>这篇文章最初发表在 <a href=\"https://medium.com/@kwmonroe/monitor-your-kubernetes-cluster-a856d2603ec3\">Kevin Monroe 的博客</a> 上。</p>\n<p>监视日志和指标状态是集群管理员的重点工作。它的好处很明显：指标能帮你设置一个合理的性能目标，而日志分析可以发现影响你工作负载的问题。然而，困难的是如何找到一个与大量运行的应用程序一起工作的监视解决方案。</p>\n<p>在本文中，我将使用 <a href=\"https://www.graylog.org/\">Graylog</a> （用于日志）和 <a href=\"https://prometheus.io/\">Prometheus</a> （用于指标）去打造一个 Kubernetes 集群的监视解决方案。当然了，这不仅是将三个东西连接起来那么简单，实现上，最终结果看起来应该如题图所示：</p>\n<p><img src=\"https://dn-linuxcn.qbox.me/data/attachment/album/201804/10/182842hu1toaq9hhh9uiou.png\" alt=\"\"></p>\n<p>正如你所了解的，Kubernetes 不是一件东西 —— 它由主控节点、工作节点、网络连接、配置管理等等组成。同样，Graylog 是一个配角（apache2、mongodb、等等），Prometheus 也一样（telegraf、grafana 等等）。在部署中连接这些点看起来似乎有些让人恐惧，但是使用合适的工具将不会那么困难。</p>\n<p>我将使用 <a href=\"https://conjure-up.io/\">conjure-up</a> 和 <a href=\"https://jujucharms.com/canonical-kubernetes\">Canonical 版本的 Kubernetes</a> (CDK) 去探索 Kubernetes。我发现 <code>conjure-up</code> 接口对部署大型软件很有帮助，但是我知道一些人可能不喜欢 GUI、TUI 以及其它用户界面。对于这些人，我将用命令行再去部署一遍。</p>\n<p>在开始之前需要注意的一点是，Graylog 和 Prometheus 是部署在 Kubernetes 外侧而不是集群上。像 Kubernetes 仪表盘和 Heapster 是运行的集群的非常好的信息来源，但是我的目标是为日志/指标提供一个分析机制，而不管集群运行与否。</p>\n<h3 id=\"toc_1\">开始探索</h3>\n<p>如果你的系统上没有 <code>conjure-up</code>，首先要做的第一件事情是，请先安装它，在 Linux 上，这很简单：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c16a061933489\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsudo snap install conjure-up --classic\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c16a061933489-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c16a061933489-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c16a061933489-1\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-e\">snap </span><span class=\"crayon-e\">install </span><span class=\"crayon-v\">conjure</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">up</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-i\">classic</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c16a061933489-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>对于 macOS 用户也提供了 brew 包：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c174426231029\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbrew install conjure-up\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c174426231029-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c174426231029-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c174426231029-1\"><span class=\"crayon-e\">brew </span><span class=\"crayon-e\">install </span><span class=\"crayon-v\">conjure</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">up</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c174426231029-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>你需要最新的 2.5.2 版，它的好处是添加了 CDK spell，因此，如果你的系统上已经安装了旧的版本，请使用 <code>sudo snap refresh conjure-up</code> 或者 <code>brew update &amp;&amp; brew upgrade conjure-up</code> 去更新它。</p>\n<p>安装完成后，运行它：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c179016295724\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nconjure-up\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c179016295724-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c179016295724-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c179016295724-1\"><span class=\"crayon-v\">conjure</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">up</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c179016295724-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2018/04/0a84a2dc6e19e9e92a195dbe6c5eb6b1.png\" alt=\"\"></p>\n<p>你将发现有一个 spell 列表。选择 CDK 然后按下回车。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2018/04/5c2e2762a0bb2a81dd5939d4a657c69d.png\" alt=\"\"></p>\n<p>这个时候，你将看到 CDK spell 可用的附加组件。我们感兴趣的是 Graylog 和 Prometheus，因此选择这两个，然后点击 “Continue”。</p>\n<p>它将引导你选择各种云，以决定你的集群部署的地方。之后，你将看到一些部署的后续步骤，接下来是回顾屏幕，让你再次确认部署内容：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2018/04/e8a7154940f22e1ee5c1035698a2fab3.png\" alt=\"\"></p>\n<p>除了典型的 K8s 相关的应用程序（etcd、flannel、load-balancer、master 以及 workers）之外，你将看到我们选择的日志和指标相关的额外应用程序。</p>\n<p>Graylog 栈包含如下：</p>\n<ul>\n<li>apache2：graylog web 界面的反向代理</li>\n<li>elasticsearch：日志使用的文档数据库</li>\n<li>filebeat：从 K8s master/workers 转发日志到 graylog</li>\n<li>graylog：为日志收集器提供一个 api，以及提供一个日志分析界面</li>\n<li>mongodb：保存 graylog 元数据的数据库</li>\n</ul>\n<p>Prometheus 栈包含如下：</p>\n<ul>\n<li>grafana：指标相关的仪表板的 web 界面</li>\n<li>prometheus：指标收集器以及时序数据库</li>\n<li>telegraf：发送主机的指标到 prometheus 中</li>\n</ul>\n<p>你可以在回顾屏幕上微调部署，但是默认组件是必选 的。点击 “Deploy all Remaining Applications” 继续。</p>\n<p>部署工作将花费一些时间，它将部署你的机器和配置你的云。完成后，<code>conjure-up</code> 将展示一个摘要屏幕，它包含一些链接，你可以用你的终端去浏览各种感兴趣的内容：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2018/04/77927d348a0c12ef4855bd1116947ef5.png\" alt=\"\"></p>\n<h4 id=\"toc_2\">浏览日志</h4>\n<p>现在，Graylog 已经部署和配置完成，我们可以看一下采集到的一些数据。默认情况下，filebeat 应用程序将从 Kubernetes 的 master 和 worker 中转发系统日志（ <code>/var/log/*.log</code> ）和容器日志（<code>/var/log/containers/*.log</code>）到 graylog 中。</p>\n<p>记住如下的 apache2 的地址和 graylog 的 admin 密码：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c17e005425297\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\njuju status --format yaml apache2/0 | grep public-address\r\n public-address: &lt;your-apache2-ip&gt;\r\njuju run-action --wait graylog/0 show-admin-password\r\n admin-password: &lt;your-graylog-password&gt;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c17e005425297-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c17e005425297-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c17e005425297-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c17e005425297-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c17e005425297-1\"><span class=\"crayon-e\">juju </span><span class=\"crayon-v\">status</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">format </span><span class=\"crayon-e\">yaml </span><span class=\"crayon-v\">apache2</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grep </span><span class=\"crayon-m\">public</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">address</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c17e005425297-2\"><span class=\"crayon-e\"> </span><span class=\"crayon-m\">public</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">address</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">your</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">apache2</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">ip</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c17e005425297-3\"><span class=\"crayon-e\">juju </span><span class=\"crayon-v\">run</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">action</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">wait </span><span class=\"crayon-v\">graylog</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">show</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">admin</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">password</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c17e005425297-4\"><span class=\"crayon-e\"> </span><span class=\"crayon-v\">admin</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">password</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">your</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">graylog</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">password</span><span class=\"crayon-o\">&gt;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0013 seconds] -->\r\n<p>在浏览器中输入 <code>http://&lt;your-apache2-ip&gt;</code> ，然后以管理员用户名（admin）和密码（&lt;your-graylog-password&gt;）登入。</p>\n<p><strong>注意：</strong> 如果这个界面不可用，请等待大约 5 分钟时间，以便于配置的反向代理生效。</p>\n<p>登入后，顶部的 “Sources” 选项卡可以看到从 K8s 的 master 和 workers 中收集日志的概述：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2018/04/8e0dc56257a324ee2f0f33426b3c105e.png\" alt=\"\"></p>\n<p>通过点击 “System / Inputs” 选项卡深入这些日志，选择 “Show received messages” 查看 filebeat 的输入：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2018/04/6b187118ff50bc41d040ef954b607ffe.png\" alt=\"\"></p>\n<p>在这里，你可以应用各种过滤或者设置 Graylog 仪表板去帮助识别大多数比较重要的事件。查看 <a href=\"http://docs.graylog.org/en/2.3/pages/dashboards.html\">Graylog Dashboard</a> 文档，可以了解如何定制你的视图的详细资料。</p>\n<h4 id=\"toc_3\">浏览指标</h4>\n<p>我们的部署通过 grafana 仪表板提供了两种类型的指标：系统指标，包括像 K8s master 和 worker 的 CPU /内存/磁盘使用情况，以及集群指标，包括像从 K8s cAdvisor 端点上收集的容器级指标。</p>\n<p>记住如下的 grafana 的地址和 admin 密码：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c182852217761\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\njuju status --format yaml grafana/0 | grep public-address\r\n public-address: &lt;your-grafana-ip&gt;\r\njuju run-action --wait grafana/0 get-admin-password\r\n password: &lt;your-grafana-password&gt;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c182852217761-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c182852217761-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c182852217761-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c182852217761-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c182852217761-1\"><span class=\"crayon-e\">juju </span><span class=\"crayon-v\">status</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">format </span><span class=\"crayon-e\">yaml </span><span class=\"crayon-v\">grafana</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">grep </span><span class=\"crayon-m\">public</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">address</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c182852217761-2\"><span class=\"crayon-e\"> </span><span class=\"crayon-m\">public</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">address</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">your</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">grafana</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">ip</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c182852217761-3\"><span class=\"crayon-e\">juju </span><span class=\"crayon-v\">run</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">action</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">wait </span><span class=\"crayon-v\">grafana</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">admin</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">password</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c182852217761-4\"><span class=\"crayon-e\"> </span><span class=\"crayon-v\">password</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">your</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">grafana</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">password</span><span class=\"crayon-o\">&gt;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0013 seconds] -->\r\n<p>在浏览器中输入 <code>http://&lt;your-grafana-ip&gt;:3000</code>，输入管理员用户（admin）和密码（&lt;your-grafana-password&gt;）登入。成功登入后，点击 “Home” 下拉框，选取 “Kubernetes Metrics (via Prometheus)” 去查看集群指标仪表板：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2018/04/76a0a9d93a75c76c8033b51957615741.png\" alt=\"\"></p>\n<p>我们也可以通过下拉框切换到 “Node Metrics (via Telegraf) ” 去查看 K8s 主机的系统指标。</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2018/04/a708ae229aeffef775184db190b97c95.png\" alt=\"\"></p>\n<h3 id=\"toc_4\">另一种方法</h3>\n<p>正如在文章开始的介绍中提到的，我喜欢用 <code>conjure-up</code> 的向导去完成像 Kubernetes 这种复杂软件的部署。现在，我们来看一下 <code>conjure-up</code> 的另一种方法，你可能希望去看到实现相同结果的一些命令行的方法。还有其它的可能已经部署了前面的 CDK，并想去扩展使用上述的 Graylog/Prometheus 组件。不管什么原因你既然看到这了，既来之则安之，继续向下看吧。</p>\n<p>支持 <code>conjure-up</code> 的工具是 <a href=\"https://jujucharms.com/\">Juju</a>。CDK spell 所做的一切，都可以使用 <code>juju</code> 命令行来完成。我们来看一下，如何一步步完成这些工作。</p>\n<h4 id=\"toc_5\">从 Scratch 中启动</h4>\n<p>如果你使用的是 Linux，安装 Juju 很简单，命令如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c186764401277\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsudo snap install juju --classic\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c186764401277-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c186764401277-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c186764401277-1\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-e\">snap </span><span class=\"crayon-e\">install </span><span class=\"crayon-v\">juju</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-i\">classic</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c186764401277-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>对于 macOS，Juju 也可以从 brew 中安装：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c18a461730205\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nbrew install juju\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c18a461730205-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c18a461730205-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c18a461730205-1\"><span class=\"crayon-e\">brew </span><span class=\"crayon-e\">install </span><span class=\"crayon-i\">juju</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c18a461730205-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>现在为你选择的云配置一个控制器。你或许会被提示请求一个凭据（用户名密码）：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c18d019618441\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\njuju bootstrap\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c18d019618441-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c18d019618441-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c18d019618441-1\"><span class=\"crayon-e\">juju </span><span class=\"crayon-i\">bootstrap</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c18d019618441-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n<p>我们接下来需要基于 CDK 捆绑部署：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c190373263162\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\njuju deploy canonical-kubernetes\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c190373263162-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c190373263162-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c190373263162-1\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">deploy </span><span class=\"crayon-v\">canonical</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">kubernetes</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c190373263162-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p></p>\n<h4 id=\"toc_6\">从 CDK 开始</h4>\n<p>使用我们部署的 Kubernetes 集群，我们需要去添加 Graylog 和 Prometheus 所需要的全部应用程序：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c194647909309\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n## deploy graylog-related applications\r\njuju deploy xenial/apache2\r\njuju deploy xenial/elasticsearch\r\njuju deploy xenial/filebeat\r\njuju deploy xenial/graylog\r\njuju deploy xenial/mongodb\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c194647909309-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c194647909309-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c194647909309-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c194647909309-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c194647909309-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c194647909309-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c194647909309-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c194647909309-1\"><span class=\"crayon-p\">## deploy graylog-related applications</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c194647909309-2\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">deploy </span><span class=\"crayon-v\">xenial</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">apache2</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c194647909309-3\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">deploy </span><span class=\"crayon-v\">xenial</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">elasticsearch</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c194647909309-4\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">deploy </span><span class=\"crayon-v\">xenial</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">filebeat</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c194647909309-5\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">deploy </span><span class=\"crayon-v\">xenial</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">graylog</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c194647909309-6\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">deploy </span><span class=\"crayon-v\">xenial</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">mongodb</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c194647909309-7\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c197354056061\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n## deploy prometheus-related applications\r\njuju deploy xenial/grafana\r\njuju deploy xenial/prometheus\r\njuju deploy xenial/telegraf\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c197354056061-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c197354056061-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c197354056061-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c197354056061-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c197354056061-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c197354056061-1\"><span class=\"crayon-p\">## deploy prometheus-related applications</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c197354056061-2\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">deploy </span><span class=\"crayon-v\">xenial</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">grafana</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c197354056061-3\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">deploy </span><span class=\"crayon-v\">xenial</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">prometheus</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c197354056061-4\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">deploy </span><span class=\"crayon-v\">xenial</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">telegraf</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c197354056061-5\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>现在软件已经部署完毕，将它们连接到一起，以便于它们之间可以相互通讯：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c19a446081024\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n## relate graylog applications\r\njuju relate apache2:reverseproxy graylog:website\r\njuju relate graylog:elasticsearch elasticsearch:client\r\njuju relate graylog:mongodb mongodb:database\r\njuju relate filebeat:beats-host kubernetes-master:juju-info\r\njuju relate filebeat:beats-host kubernetes-worker:jujuu-info\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c19a446081024-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c19a446081024-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c19a446081024-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c19a446081024-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c19a446081024-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c19a446081024-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c19a446081024-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c19a446081024-1\"><span class=\"crayon-p\">## relate graylog applications</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c19a446081024-2\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">relate </span><span class=\"crayon-v\">apache2</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">reverseproxy </span><span class=\"crayon-v\">graylog</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">website</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c19a446081024-3\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">relate </span><span class=\"crayon-v\">graylog</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">elasticsearch </span><span class=\"crayon-v\">elasticsearch</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">client</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c19a446081024-4\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">relate </span><span class=\"crayon-v\">graylog</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">mongodb </span><span class=\"crayon-v\">mongodb</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">database</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c19a446081024-5\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">relate </span><span class=\"crayon-v\">filebeat</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">beats</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">host </span><span class=\"crayon-v\">kubernetes</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">master</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">juju</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">info</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c19a446081024-6\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">relate </span><span class=\"crayon-v\">filebeat</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">beats</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">host </span><span class=\"crayon-v\">kubernetes</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">worker</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">jujuu</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">info</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c19a446081024-7\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0014 seconds] -->\r\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c19d434711004\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n## relate prometheus applications\r\njuju relate prometheus:grafana-source grafana:grafana-source\r\njuju relate telegraf:prometheus-client prometheus:target\r\njuju relate kubernetes-master:juju-info telegraf:juju-info\r\njuju relate kubernetes-worker:juju-info telegraf:juju-info\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c19d434711004-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c19d434711004-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c19d434711004-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c19d434711004-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c19d434711004-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c19d434711004-6\">6</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c19d434711004-1\"><span class=\"crayon-p\">## relate prometheus applications</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c19d434711004-2\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">relate </span><span class=\"crayon-v\">prometheus</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">grafana</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">source </span><span class=\"crayon-v\">grafana</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">grafana</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">source</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c19d434711004-3\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">relate </span><span class=\"crayon-v\">telegraf</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">prometheus</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">client </span><span class=\"crayon-v\">prometheus</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">target</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c19d434711004-4\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">relate </span><span class=\"crayon-v\">kubernetes</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">master</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">juju</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">info </span><span class=\"crayon-v\">telegraf</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">juju</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">info</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c19d434711004-5\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">relate </span><span class=\"crayon-v\">kubernetes</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">worker</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">juju</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">info </span><span class=\"crayon-v\">telegraf</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">juju</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">info</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c19d434711004-6\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0014 seconds] -->\r\n<p>这个时候，所有的应用程序已经可以相互之间进行通讯了，但是我们还需要多做一点配置（比如，配置 apache2 反向代理、告诉 prometheus 如何从 K8s 中取数、导入到 grafana 仪表板等等）：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c1a1960746651\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n## configure graylog applications\r\njuju config apache2 enable_modules=\"headers proxy_html proxy_http\"\r\njuju config apache2 vhost_http_template=\"$(base64 &lt;vhost-tmpl&gt;)\"\r\njuju config elasticsearch firewall_enabled=\"false\"\r\njuju config filebeat \\\r\n logpath=\"/var/log/*.log /var/log/containers/*.log\"\r\njuju config filebeat logstash_hosts=&lt;graylog-ip&gt;\":5044\"\r\njuju config graylog elasticsearch_cluster_name=\"&lt;es-cluster&gt;\"\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c1a1960746651-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c1a1960746651-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c1a1960746651-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c1a1960746651-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c1a1960746651-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c1a1960746651-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c1a1960746651-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c1a1960746651-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c1a1960746651-9\">9</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c1a1960746651-1\"><span class=\"crayon-p\">## configure graylog applications</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c1a1960746651-2\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">config </span><span class=\"crayon-e\">apache2 </span><span class=\"crayon-v\">enable_modules</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"headers proxy_html proxy_http\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c1a1960746651-3\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">config </span><span class=\"crayon-e\">apache2 </span><span class=\"crayon-v\">vhost_http_template</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"$(base64 &lt;vhost-tmpl&gt;)\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c1a1960746651-4\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">config </span><span class=\"crayon-e\">elasticsearch </span><span class=\"crayon-v\">firewall_enabled</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"false\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c1a1960746651-5\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">config </span><span class=\"crayon-i\">filebeat</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c1a1960746651-6\"><span class=\"crayon-h\"> </span><span class=\"crayon-v\">logpath</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"/var/log/*.log /var/log/containers/*.log\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c1a1960746651-7\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">config </span><span class=\"crayon-e\">filebeat </span><span class=\"crayon-v\">logstash_hosts</span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">graylog</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">ip</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-s\">\":5044\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c1a1960746651-8\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">config </span><span class=\"crayon-e\">graylog </span><span class=\"crayon-v\">elasticsearch_cluster_name</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"&lt;es-cluster&gt;\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c1a1960746651-9\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0013 seconds] -->\r\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c1a4776937571\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n## configure prometheus applications\r\njuju config prometheus scrape-jobs=\"&lt;scraper-yaml&gt;\"\r\njuju run-action --wait grafana/0 import-dashboard \\\r\n dashboard=\"$(base64 &lt;dashboard-json&gt;)\"\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c1a4776937571-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c1a4776937571-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c1a4776937571-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c1a4776937571-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c1a4776937571-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c1a4776937571-1\"><span class=\"crayon-p\">## configure prometheus applications</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c1a4776937571-2\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">config </span><span class=\"crayon-e\">prometheus </span><span class=\"crayon-v\">scrape</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">jobs</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"&lt;scraper-yaml&gt;\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c1a4776937571-3\"><span class=\"crayon-e\">juju </span><span class=\"crayon-v\">run</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">action</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">wait </span><span class=\"crayon-v\">grafana</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">import</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">dashboard</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c1a4776937571-4\"><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dashboard</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"$(base64 &lt;dashboard-json&gt;)\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c1a4776937571-5\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>以上的步骤需要根据你的部署来指定一些值。你可以用与 <code>conjure-up</code> 相同的方法得到这些：</p>\n<ul>\n<li><code>&lt;vhost-tmpl&gt;</code>： 从 github 获取我们的示例 <a href=\"https://raw.githubusercontent.com/conjure-up/spells/master/canonical-kubernetes/addons/graylog/steps/01_install-graylog/graylog-vhost.tmpl\">模板</a></li>\n<li><code>&lt;graylog-ip&gt;</code>： <code>juju run --unit graylog/0 'unit-get private-address'</code></li>\n<li><code>&lt;es-cluster&gt;</code>： <code>juju config elasticsearch cluster-name</code></li>\n<li><code>&lt;scraper-yaml&gt;</code>： 从 github 获取我们的示例 <a href=\"https://raw.githubusercontent.com/conjure-up/spells/master/canonical-kubernetes/addons/prometheus/steps/01_install-prometheus/prometheus-scrape-k8s.yaml\">scraper</a> ；<code>[K8S_PASSWORD][20]</code> 和 <code>[K8S_API_ENDPOINT][21]</code> <a href=\"https://github.com/conjure-up/spells/blob/master/canonical-kubernetes/addons/prometheus/steps/01_install-prometheus/after-deploy#L25\">substitute</a> 的正确值</li>\n<li><code>&lt;dashboard-json&gt;</code>： 从 github 获取我们的 <a href=\"https://raw.githubusercontent.com/conjure-up/spells/master/canonical-kubernetes/addons/prometheus/steps/01_install-prometheus/grafana-telegraf.json\">主机</a> 和 <a href=\"https://raw.githubusercontent.com/conjure-up/spells/master/canonical-kubernetes/addons/prometheus/steps/01_install-prometheus/grafana-k8s.json\">k8s</a> 仪表板</li>\n</ul>\n<p>最后，发布 apache2 和 grafana 应用程序，以便于可以通过它们的 web 界面访问：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad404c49c1a9876526228\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n## expose relevant endpoints\r\njuju expose apache2\r\njuju expose grafana\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c1a9876526228-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c1a9876526228-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad404c49c1a9876526228-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad404c49c1a9876526228-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad404c49c1a9876526228-1\"><span class=\"crayon-p\">## expose relevant endpoints</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c1a9876526228-2\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">expose </span><span class=\"crayon-e\">apache2</span></div><div class=\"crayon-line\" id=\"crayon-5ad404c49c1a9876526228-3\"><span class=\"crayon-e\">juju </span><span class=\"crayon-e\">expose </span><span class=\"crayon-i\">grafana</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad404c49c1a9876526228-4\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>现在我们已经完成了所有的部署、配置、和发布工作，你可以使用与上面的<strong>浏览日志</strong>和<strong>浏览指标</strong>部分相同的方法去查看它们。</p>\n<h3 id=\"toc_7\">总结</h3>\n<p>我的目标是向你展示如何去部署一个 Kubernetes 集群，很方便地去监视它的日志和指标。无论你是喜欢向导的方式还是命令行的方式，我希望你清楚地看到部署一个监视系统并不复杂。关键是要搞清楚所有部分是如何工作的，并将它们连接到一起工作，通过断开/修复/重复的方式，直到它们每一个都能正常工作。</p>\n<p>这里有一些像 conjure-up 和 Juju 一样非常好的工具。充分发挥这个生态系统贡献者的专长让管理大型软件变得更容易。从一套可靠的应用程序开始，按需定制，然后投入到工作中！</p>\n<p>大胆去尝试吧，然后告诉我你用的如何。你可以在 Freenode IRC 的 <strong>#conjure-up</strong> 和 <strong>#juju</strong> 中找到像我这样的爱好者。感谢阅读！</p>\n<h3 id=\"toc_8\">关于作者</h3>\n<p>Kevin 在 2014 年加入 Canonical 公司，他专注于复杂软件建模。他在 Juju 大型软件团队中找到了自己的位置，他的任务是将大数据和机器学习应用程序转化成可重复的（可靠的）解决方案。</p>\n<p> </p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113875\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113875votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113875\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 2 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 2 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/8163b569212cff9b9756ab2724d7a551f380e188.jpg"}{"url_object_id": "c4047562c0b4ecb3f07bd8265ef26273", "title": "命令行乐趣：嘲讽输错 Bash 命令的用户", "url": "http://blog.jobbole.com/113854/", "created_date": "2018/04/13", "front_image_url": ["https://dn-linuxcn.qbox.me/data/attachment/album/201803/30/102653o0g177wl8dug2kw2.jpg"], "praise_nums": "1", "comments_nums": 1, "fav_nums": 0, "tags": "IT技术,Linux", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://www.cyberciti.biz/howto/insult-linux-unix-bash-user-when-typing-wrong-command/\">Vivek Gite</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-9497-1.html\">Linux中国/ChenYi</a>   </div><p class=\"article_img\"><img src=\"https://dn-linuxcn.qbox.me/data/attachment/album/201803/30/102653o0g177wl8dug2kw2.jpg\"></p>\n<p>你可以通过配置 <code>sudo</code> 命令去嘲讽输入错误密码的用户。但是现在，当用户在 shell 输错命令时，也能嘲讽他了（滥用？）。</p>\n<h3 id=\"toc_1\">你好 bash-insulter</h3>\n<p>来自 Github 页面：</p>\n<blockquote><p>当用户键入错误命令，随机嘲讽。它使用了一个 bash4.x. 版本的全新内置错误处理函数，叫 <code>command_not_found_handle</code>。</p></blockquote>\n<h3 id=\"toc_2\">安装</h3>\n<p>键入下列 git 命令克隆一个仓库：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ff920adf6633721215\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ngit clone https://github.com/hkbakke/bash-insulter.git bash-insulter</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920adf6633721215-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ff920adf6633721215-1\"><span class=\"crayon-e\">git </span><span class=\"crayon-r\">clone</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">https</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//github.com/hkbakke/bash-insulter.git bash-insulter</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>示例输出：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ff920adff177647554\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nCloning into 'bash-insulter'...\r\nremote: Counting objects: 52, done.\r\nremote: Compressing objects: 100% (49/49), done.\r\nremote: Total 52 (delta 12), reused 12 (delta 2), pack-reused 0\r\nUnpacking objects: 100% (52/52), done.</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920adff177647554-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920adff177647554-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920adff177647554-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920adff177647554-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920adff177647554-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ff920adff177647554-1\"><span class=\"crayon-e\">Cloning </span><span class=\"crayon-i\">into</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'bash-insulter'</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920adff177647554-2\"><span class=\"crayon-v\">remote</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Counting </span><span class=\"crayon-v\">objects</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">52</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">done</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920adff177647554-3\"><span class=\"crayon-v\">remote</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Compressing </span><span class=\"crayon-v\">objects</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">100</span><span class=\"crayon-o\">%</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">49</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">49</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">done</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920adff177647554-4\"><span class=\"crayon-v\">remote</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Total</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">52</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">delta</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">12</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">reused</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">12</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">delta</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">pack</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">reused</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920adff177647554-5\"><span class=\"crayon-e\">Unpacking </span><span class=\"crayon-v\">objects</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">100</span><span class=\"crayon-o\">%</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">52</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">52</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">done</span><span class=\"crayon-sy\">.</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0018 seconds] -->\r\n<p>用文本编辑器，比如说使用 <code>vi</code>，编辑你的 <code>~/.bashrc</code> 或者 <code>/etc/bash.bashrc</code> 文件：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ff920ae03988363409\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ vi ~/.bashrc</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae03988363409-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae03988363409-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vi</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">bashrc</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>在其后追加这一行（具体了解请查看 <a class=\"ext\" href=\"https://bash.cyberciti.biz/guide/If..else..fi\" target=\"_blank\" rel=\"external nofollow\">if..else..fi 声明</a><span class=\"sup\">[1]</span> 和 <a class=\"ext\" href=\"https://bash.cyberciti.biz/guide/Source_command\" target=\"_blank\" rel=\"external nofollow\">source 命令</a><span class=\"sup\">[2]</span>）：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ff920ae07493781122\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nif [ -f $HOME/bash-insulter/src/bash.command-not-found ]; then\r\n    source $HOME/bash-insulter/src/bash.command-not-found\r\nfi</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae07493781122-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae07493781122-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae07493781122-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae07493781122-1\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">f</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">HOME</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bash</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">insulter</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">src</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bash</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">command</span><span class=\"crayon-o\">-</span><span class=\"crayon-st\">not</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">found</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">then</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae07493781122-2\"><span class=\"crayon-h\">    </span><span class=\"crayon-i\">source</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">HOME</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bash</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">insulter</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">src</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bash</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">command</span><span class=\"crayon-o\">-</span><span class=\"crayon-st\">not</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">found</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae07493781122-3\"><span class=\"crayon-v\">fi</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0012 seconds] -->\r\n<p>保存并关闭文件。重新登录，如果不想退出账号也可以手动运行它：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ff920ae0a686206934\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ . $HOME/bash-insulter/src/bash.command-not-found</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae0a686206934-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae0a686206934-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">HOME</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bash</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">insulter</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">src</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bash</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">command</span><span class=\"crayon-o\">-</span><span class=\"crayon-st\">not</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">found</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p></p>\n<h3 id=\"toc_3\">如何使用它？</h3>\n<p>尝试键入一些无效命令：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ff920ae0d148945162\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ ifconfigs\r\n$ dates</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae0d148945162-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae0d148945162-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae0d148945162-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">ifconfigs</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae0d148945162-2\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dates</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>示例输出:</p>\n<p style=\"text-align: center\"><a class=\"ext\" href=\"https://www.cyberciti.biz/media/new/cms/2017/11/bash-insulter-Insults-the-user-when-typing-wrong-command.jpg\" target=\"_blank\" rel=\"external nofollow\"><img class=\"aligncenter\" src=\"https://dn-linuxcn.qbox.me/data/attachment/album/201803/30/102702uazyc5tf7qmhcccy.jpg\" alt=\"一个有趣的 bash 钩子功能，嘲讽输入了错误命令的你。\"></a><span class=\"sup\"><em>一个有趣的 bash 钩子功能，嘲讽输入了错误命令的你。</em>[3]</span></p>\n<h3 id=\"toc_4\">自定义</h3>\n<p>你需要编辑 <code>$HOME/bash-insulter/src/bash.command-not-found</code>：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ff920ae11921958592\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ vi $HOME/bash-insulter/src/bash.command-not-found</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae11921958592-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae11921958592-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">vi</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">HOME</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bash</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">insulter</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">src</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bash</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">command</span><span class=\"crayon-o\">-</span><span class=\"crayon-st\">not</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">found</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>示例代码：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ff920ae14013033798\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncommand_not_found_handle () {\r\n    local INSULTS=(\r\n        \"Boooo!\"\r\n        \"Don't you know anything?\"\r\n        \"RTFM!\"\r\n        \"Hahaha, n00b!\"\r\n        \"Wow! That was impressively wrong!\"\r\n        \"What are you doing??\"\r\n        \"Pathetic\"\r\n        \"...and this is the best you can do??\"\r\n        \"The worst one today!\"\r\n        \"n00b alert!\"\r\n        \"Your application for reduced salary has been sent!\"\r\n        \"lol\"\r\n        \"u suk\"\r\n        \"lol... plz\"\r\n        \"plz uninstall\"\r\n        \"And the Darwin Award goes to.... ${USER}!\"\r\n        \"ERROR_INCOMPETENT_USER\"\r\n        \"Incompetence is also competence\"\r\n        \"Bad.\"\r\n        \"Fake it till you make it!\"\r\n        \"What is this...? Amateur hour!?\"\r\n        \"Come on! You can do it!\"\r\n        \"Nice try.\"\r\n        \"What if... you type an actual command the next time!\"\r\n        \"What if I told you... it is possible to type valid commands.\"\r\n        \"Y u no speak computer???\"\r\n        \"This is not Windows\"\r\n        \"Perhaps you should leave the command line alone...\"\r\n        \"Please step away from the keyboard!\"\r\n        \"error code: 1D10T\"\r\n        \"ACHTUNG! ALLES TURISTEN UND NONTEKNISCHEN LOOKENPEEPERS! DAS KOMPUTERMASCHINE IST NICHT FÜR DER GEFINGERPOKEN UND MITTENGRABEN! ODERWISE IST EASY TO SCHNAPPEN DER SPRINGENWERK, BLOWENFUSEN UND POPPENCORKEN MIT SPITZENSPARKEN. IST NICHT FÜR GEWERKEN BEI DUMMKOPFEN. DER RUBBERNECKEN SIGHTSEEREN KEEPEN DAS COTTONPICKEN HÄNDER IN DAS POCKETS MUSS. ZO RELAXEN UND WATSCHEN DER BLINKENLICHTEN.\"\r\n        \"Pro tip: type a valid command!\"\r\n    )\r\n\r\n    # 设置“随机”种子发生器 \r\n    RANDOM=$(date +%s%N)\r\n    VALUE=$((${RANDOM}%2))\r\n\r\n    if [[ ${VALUE} -lt 1 ]]; then\r\n        printf \"\\n  $(tput bold)$(tput setaf 1)$(shuf -n 1 -e \"${INSULTS[@]}\")$(tput sgr0)\\n\\n\"\r\n    fi\r\n\r\n    echo \"-bash: $1: command not found\"\r\n\r\n    # 无效命令，常规返回已存在的代码\r\n    return 127\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae14013033798-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae14013033798-49\">49</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-1\"><span class=\"crayon-e\">command_not_found_handle</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-2\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">local </span><span class=\"crayon-v\">INSULTS</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-3\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Boooo!\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-4\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Don't you know anything?\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"RTFM!\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Hahaha, n00b!\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Wow! That was impressively wrong!\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"What are you doing??\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Pathetic\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"...and this is the best you can do??\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"The worst one today!\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"n00b alert!\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Your application for reduced salary has been sent!\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"lol\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"u suk\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"lol... plz\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"plz uninstall\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"And the Darwin Award goes to.... ${USER}!\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"ERROR_INCOMPETENT_USER\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Incompetence is also competence\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Bad.\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Fake it till you make it!\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"What is this...? Amateur hour!?\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Come on! You can do it!\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Nice try.\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"What if... you type an actual command the next time!\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"What if I told you... it is possible to type valid commands.\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Y u no speak computer???\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-29\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"This is not Windows\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-30\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Perhaps you should leave the command line alone...\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-31\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Please step away from the keyboard!\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-32\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"error code: 1D10T\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"ACHTUNG! ALLES TURISTEN UND NONTEKNISCHEN LOOKENPEEPERS! DAS KOMPUTERMASCHINE IST NICHT FÜR DER GEFINGERPOKEN UND MITTENGRABEN! ODERWISE IST EASY TO SCHNAPPEN DER SPRINGENWERK, BLOWENFUSEN UND POPPENCORKEN MIT SPITZENSPARKEN. IST NICHT FÜR GEWERKEN BEI DUMMKOPFEN. DER RUBBERNECKEN SIGHTSEEREN KEEPEN DAS COTTONPICKEN HÄNDER IN DAS POCKETS MUSS. ZO RELAXEN UND WATSCHEN DER BLINKENLICHTEN.\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-34\"><span class=\"crayon-h\">        </span><span class=\"crayon-s\">\"Pro tip: type a valid command!\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-35\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-36\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-37\"><span class=\"crayon-h\">    </span><span class=\"crayon-p\"># 设置“随机”种子发生器 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-38\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">RANDOM</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">date</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">s</span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">N</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-39\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">VALUE</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">RANDOM</span><span class=\"crayon-sy\">}</span><span class=\"crayon-o\">%</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-40\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-41\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">[</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">VALUE</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">lt</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">then</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-42\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">printf</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"\\n  $(tput bold)$(tput setaf 1)$(shuf -n 1 -e \"</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">INSULTS</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">@</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">}</span><span class=\"crayon-s\">\")$(tput sgr0)\\n\\n\"</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-43\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">fi</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-44\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-45\"><span class=\"crayon-e\">    </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"-bash: $1: command not found\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-46\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-47\"><span class=\"crayon-h\">    </span><span class=\"crayon-p\"># 无效命令，常规返回已存在的代码</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae14013033798-48\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">127</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae14013033798-49\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0038 seconds] -->\r\n<p></p>\n<h3 id=\"toc_5\">赠品：sudo 嘲讽</h3>\n<p>编辑 <code>sudoers</code> 文件：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ff920ae19367306290\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ sudo visudo</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae19367306290-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae19367306290-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">visudo</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n<p>追加下面这一行：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ff920ae1c739701726\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nDefaults insults</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae1c739701726-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae1c739701726-1\"><span class=\"crayon-e\">Defaults </span><span class=\"crayon-v\">insults</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n<p>或者像下面尾行增加一句嘲讽语：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ff920ae1f912838127\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nDefaults !lecture,tty_tickets,!fqdn,insults</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae1f912838127-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae1f912838127-1\"><span class=\"crayon-v\">Defaults</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">lecture</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">tty_tickets</span><span class=\"crayon-sy\">,</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">fqdn</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">insults</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>这是我的文件：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ff920ae22637285883\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-mixed-highlight\" title=\"含多种语言\"></span><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nDefaults    env_reset\r\nDefaults    mail_badpass\r\nDefaults    secure_path = \"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin\"\r\n## If set, sudo will insult users when they enter an incorrect password. ##\r\nDefaults    insults\r\n\r\n# Host alias specification\r\n\r\n# User alias specification\r\n\r\n# Cmnd alias specification\r\n\r\n# User privilege specification\r\nroot ALL = (ALL:ALL) ALL\r\n\r\n# Members of the admin group may gain root privileges\r\n% admin ALL = (ALL) ALL   \r\n\r\n# Allow members of group sudo to execute any command\r\n% sudo ALL = (ALL:ALL) ALL   \r\n\r\n# See sudoers(5) for more information on \"#include\" directives:\r\n\r\n#includedir /etc/sudoers.d</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae22637285883-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae22637285883-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae22637285883-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae22637285883-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae22637285883-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae22637285883-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae22637285883-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae22637285883-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae22637285883-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae22637285883-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae22637285883-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae22637285883-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae22637285883-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae22637285883-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae22637285883-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae22637285883-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae22637285883-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae22637285883-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae22637285883-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae22637285883-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae22637285883-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae22637285883-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae22637285883-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae22637285883-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae22637285883-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae22637285883-26\">26</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae22637285883-1\"><span class=\"crayon-e\">Defaults    </span><span class=\"crayon-e\">env_reset</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae22637285883-2\"><span class=\"crayon-e\">Defaults    </span><span class=\"crayon-e\">mail_badpass</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae22637285883-3\"><span class=\"crayon-e\">Defaults    </span><span class=\"crayon-v\">secure_path</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae22637285883-4\"><span class=\"crayon-p\">## If set, sudo will insult users when they enter an incorrect password. ##</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae22637285883-5\"><span class=\"crayon-e\">Defaults    </span><span class=\"crayon-v\">insults</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae22637285883-6\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae22637285883-7\"><span class=\"crayon-p\"># Host alias specification</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae22637285883-8\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae22637285883-9\"><span class=\"crayon-p\"># User alias specification</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae22637285883-10\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae22637285883-11\"><span class=\"crayon-p\"># Cmnd alias specification</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae22637285883-12\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae22637285883-13\"><span class=\"crayon-p\"># User privilege specification</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae22637285883-14\"><span class=\"crayon-e\">root </span><span class=\"crayon-v\">ALL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ALL</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">ALL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ALL</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae22637285883-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae22637285883-16\"><span class=\"crayon-p\"># Members of the admin group may gain root privileges</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae22637285883-17\"><span class=\"crayon-ta\">%</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">admin</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ALL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ALL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">ALL</span><span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae22637285883-18\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae22637285883-19\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae22637285883-20\"><span class=\"crayon-p\"># Allow members of group sudo to execute any command</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae22637285883-21\"><span class=\"crayon-ta\">%</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">sudo</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ALL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ALL</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">ALL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">ALL</span><span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae22637285883-22\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae22637285883-23\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae22637285883-24\"><span class=\"crayon-p\"># See sudoers(5) for more information on \"#include\" directives:</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae22637285883-25\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae22637285883-26\"><span class=\"crayon-p\">#includedir /etc/sudoers.d</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0052 seconds] -->\r\n<p>试一试：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ff920ae26102833595\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ sudo -k # 清除缓存，从头开始\r\n$ sudo ls /root/\r\n$ sudo -i</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae26102833595-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ff920ae26102833595-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae26102833595-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae26102833595-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sudo</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">k</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\"># 清除缓存，从头开始</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ff920ae26102833595-2\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">ls</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">root</span><span class=\"crayon-o\">/</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae26102833595-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sudo</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">i</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>样例对话：</p>\n<p style=\"text-align: center\"><a class=\"ext\" href=\"https://www.cyberciti.biz/media/new/cms/2017/11/sudo-insults.jpg\" target=\"_blank\" rel=\"external nofollow\"><img class=\"aligncenter\" src=\"https://dn-linuxcn.qbox.me/data/attachment/album/201803/30/102702kp19pqb2egl8hlw2.jpg\" alt=\"当输入错误密码时，你会被一个有趣的的 sudo 嘲讽语戏弄。\"></a><span class=\"sup\"><em>当输入错误密码时，你会被一个有趣的的 sudo 嘲讽语戏弄。</em>[4]</span></p>\n<h3 id=\"toc_6\">赠品：你好 sl</h3>\n<p><a class=\"ext\" href=\"https://www.cyberciti.biz/tips/displays-animations-when-accidentally-you-type-sl-instead-of-ls.html\" target=\"_blank\" rel=\"external nofollow\">sl 或是 UNIX 经典捣蛋软件</a><span class=\"sup\">[5]</span> 游戏。当你错误的把 <code>ls</code> 输入成 <code>sl</code>，将会有一辆蒸汽机车穿过你的屏幕。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ff920ae2a582867805\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ sl</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ff920ae2a582867805-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ff920ae2a582867805-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sl</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n<p></p>\n<p style=\"text-align: center\"><a class=\"ext\" href=\"https://www.cyberciti.biz/tips/displays-animations-when-accidentally-you-type-sl-instead-of-ls.html\" target=\"_blank\" rel=\"external nofollow\"><img class=\"aligncenter\" src=\"https://dn-linuxcn.qbox.me/data/attachment/album/201803/30/102703s739gw183ll5454a.png\" alt=\"Linux / UNIX 桌面乐趣: 蒸汽机车\"></a><span class=\"sup\"><em>Linux / UNIX 桌面乐趣: 蒸汽机车</em>[6]</span></p>\n<p style=\"text-align: left\">[1]: https://bash.cyberciti.biz/guide/If..else..fi<br>\n[2]: https://bash.cyberciti.biz/guide/Source_command<br>\n[3]: https://www.cyberciti.biz/media/new/cms/2017/11/bash-insulter-Insults-the-user-when-typing-wrong-command.jpg<br>\n[4]: https://www.cyberciti.biz/media/new/cms/2017/11/sudo-insults.jpg<br>\n[5]: https://www.cyberciti.biz/tips/displays-animations-when-accidentally-you-type-sl-instead-of-ls.html<br>\n[6]: https://www.cyberciti.biz/tips/displays-animations-when-accidentally-you-type-sl-instead-of-ls.html<br>\n[7]: https://www.cyberciti.biz<br>\n[8]: https://github.com/CYLeft<br>\n[9]: https://github.com/wxy<br>\n[10]: https://github.com/LCTT/TranslateProject<br>\n[11]: https://linux.cn/article-9497-1.html?pr</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113854\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113854votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113854\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 1 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/521831f2ac1c9590fa6ac824e27690afeb69956d.jpg"}{"url_object_id": "3de2dfc429d04bf285e94ece0ab02d8d", "title": "15 分钟参透比特币和区块链", "url": "http://blog.jobbole.com/111954/", "created_date": "2018/04/10", "front_image_url": ["http://wx3.sinaimg.cn/mw690/7cc829d3gy1fq7lkjvcdmj20sd0g445z.jpg"], "praise_nums": "3", "comments_nums": 2, "fav_nums": 2, "tags": "IT技术,区块链,比特币", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"https://mp.weixin.qq.com/s/JEkjYdvRw2x3PzxKDR7FQQ\">来自 ChenJunXuan 的投稿</a>   </div><div>\n<blockquote><p>区块链就是比特币世界这个村子的账本，谁挖到矿，谁就有权在这个账本翻开新的一页，并在新的一页记下“X年X日，本村某某挖矿得到比特币一枚，并得到奖励的手续费若干”。</p></blockquote>\n<p><img class=\"alignnone\" src=\"http://wx3.sinaimg.cn/mw690/7cc829d3gy1fq7lkjvcdmj20sd0g445z.jpg\" width=\"690\" height=\"392\"></p>\n<p>比特币又火了。为什么要说又呢？因为比特币在 2013 年已经火过一次了。这次与 2013 年相同的是，比特币的价格一路飙升，让人咂舌。与 2013 年不同的是，这次人们不仅仅关注比特币的价格，也开始关注比特币背后的技术——<strong>区块链</strong>。</p>\n<p>一夜之间，区块链从舞台背后站到了聚光灯下，成为了人们追捧的热点。物流、医药、版权…好像哪都可以凭借区块链脱胎换骨。那么，这么神奇的技术，到底是怎么回事？</p>\n<p>本文就以最通俗的语言，不涉及任何高等数学和计算机知识，来介绍一下比特币和区块链系统。</p>\n<p>说到区块链就不得不说比特币，比特币是区块链技术最好的载体，所以本文就以比特币为例来介绍区块链。</p>\n<p>比特币很牛，牛在两个特点：<strong>去中心化、</strong><strong>电子货币</strong>。</p>\n<p>别小瞧这两点，这两点同时存在可不是一件容易事儿。</p>\n<p>首先来说说去中心化，通常去中心化的货币一般都要追溯到很久以前了，远古时代人们自发地使用贝壳、石子做为雏形货币进行交易，这时候的货币可以看作是去中心化的货币——无需中央银行来组织发行、确认交易合法性。</p>\n<p>但是使用这类货币的弊端也不必我多说，货币供给不稳定，取决于每年的贝类产量；货币质量不一，有的大有的小，有的是花蛤有的是文蛤；交易很繁琐，大宗交易动不动就要好几车的贝壳，这么多货币运来运去还容易被抢劫。</p>\n<p>于是货币进化，信用货币时代到来，货币成了银行账户里的数字，上面的问题都解决了，但是我们必须需要银行来控制货币的发行、防伪，来进行交易结算，我们的财产权全掌握在了银行的手中。银行喜欢动不动搞点QE放点水，我们银行卡里的钱越来越贬值。</p>\n<p><strong>这时候，我们就希望能有一种货币，既能像使用贝壳一样无需银行插手，又能符合当前信息时代对货币功能的需求。于是，集这两种特点于一身的比特币诞生了。</strong></p>\n<h2>比特币的基本原理</h2>\n<p>做为一种货币，通常就要满足几个特点：得有人<strong>发行</strong>它，得能<strong>持有</strong>它，人与人之间可以互相<strong>交换</strong>它。</p>\n<h3>持有</h3>\n<p>持有比特币非常简单，只要有一个<strong>收款地址</strong>，就可以持有比特币并接受比特币。所持有的比特币数量只是这个地址下的一个数字。</p>\n<p>有人会问，这不跟银行账户一样么，确实很像，但实质又很不一样。银行系统是一个中心化的系统，账户的余额是由银行说了算的，哪天银行系统出错余额变成0，那你就真的从ATM机里取不出钱。</p>\n<p>比特币不使用这种权威的中心机构，又需要一个稳定的记账系统，所以解决办法是每一个“矿工”都把比特币世界发生过的所有交易记录存在自己的硬盘上。有了全部的交易记录，推算每个人有多少余额也就很容易了。这个被保存在所有人电脑里的交易记录，学名就是<strong>区块链</strong>。黑客可以黑掉一些人保存的区块链，但是他做不到黑掉全世界大部分人，只要有大部分仍保存着正确的区块链，那么整个系统就可以通过纠错重新恢复正常。</p>\n<blockquote><p>就像打麻将时，我们有时候用记账方式来记录每回合的应收应付，比特币世界也通过记账来交易，每发生一笔交易都会公之于众，然后大家把这笔交易记录在自己的小账本上，这样每家有多少钱，大家在自己的小账本上都能查清楚。只不过当记账由4个人变成全比特币世界的村民时，这就需要一个稍微复杂点的系统了。</p></blockquote>\n<h3>发行</h3>\n<p>再来看看发行。我们先看纸币是怎么发行的，很简单，央行开动印刷机，一瞬间出现大把“毛爷爷”。而做为一种去中心化的电子货币，比特币是没有央行的，那怎么发行呢？</p>\n<p>比特币规定，人们可以去解答一个困难的问题，谁最先答出来，谁就可以发行一块比特币，也就是我们所谓的“挖矿”。</p>\n<p>这个困难的问题是什么呢？是哈希(hashing)的问题。哈希是一个函数<strong>F</strong>，对输入<strong>X</strong>进行一些运算来得到<strong>哈希值</strong><strong>Y</strong>。就是咱们高中学过的<strong>Y = F(X)</strong>。比特币让你解答的问题就是，告诉你哈希值<strong>Y</strong>和<strong>F</strong>，求<strong>X</strong>。</p>\n<p>这时候你会说了，这不就是个反函数的事么。抱歉，哈希函数这个函数比较特殊，找不到合适的反函数，要想求出<strong>X</strong>，唯一的方法就是一个一个数来试，把每一个数都代入到<strong>F</strong>里，看看结果是不是<strong>Y</strong>，如果恰好蒙对了，那也就把这个问题解答出来了。</p>\n<p>所以说所谓的货币发行、挖矿，实际上就是一帮人在用最好的计算机来撞大运蒙这个数。当一名矿工蒙对<strong>X</strong>后，也就是挖到矿后，他就获得了在原有的区块链末端创造一个新的<strong>交易区块</strong>的权利，在这个新创建的交易区块上，这位矿工可以附带一个由<strong>比特币世界</strong>作为付款人，收款人是任何人交易，这样，他就通过这个交易，创造并发行了一枚比特币。</p>\n<p>区块链就是由一串交易区块组成的。我们来看看交易区块上包含什么。</p>\n<p>一个交易区块会显示谁是它的父区块，包含本区块上的交易记录，以及本区块的哈希值。</p>\n<p> </p>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/7cc829d3gy1fq7ljddkbdj20ht06ydil.jpg\" width=\"641\" height=\"250\"></p>\n<p>这样，随着矿工们不断挖矿创建新的交易区块，一个接一个的区块就串成了一串，成为了名副其实的区块链！在比特币世界中，由于某些原因，区块链会发生分叉（为什么会分叉下文会提到），因而比特币世界规定：唯一合法的区块链是当前最长的区块链。</p>\n<blockquote><p>区块链就是比特币世界这个村子的账本，谁挖到矿，谁就有权在这个账本翻开新的一页，并在新的一页记下“X年X日，本村某某挖矿得到比特币一枚，并得到奖励的手续费若干”。这个账本很特殊，并不是由村支书管理，而是所有的村民人手一本，谁挖到矿以后，都可以自己翻页记账，并让全村人按照同样的方式做，以保证全村所有人的账本一致。当全村人的账本出现不一致时，规定谁家的账本最长就听谁的。</p></blockquote>\n<h3>发行</h3>\n<p>比特币的关键点在于交易。对于一个去中心化的电子货币系统，交易是很有风险的。想象一下，你和另一个人的电子货币交易就类似于打欠条，而且这个欠条没有第三方公证人。如果其中一方突然翻脸，欠条的有效性是很难保障的。</p>\n<p>由于不能使用类似银行结算中心的第三方公证人（使用了就是中心化系统了），所以比特币干脆就让全世界人做为公证人。</p>\n<p>所有比特币的交易都不能偷偷摸摸进行，都需要将这笔交易通过互联网广播到全世界。如果C想给B 0.5个比特币，会向全世界广播“C给了B 0.5个比特币！”，这时所有挖矿的矿工们，会把这条交易记录加到他们正在挖的这个交易区块中。</p>\n<p>他们为什么要加呢？因为当矿工挖出矿时，除了规定奖励的一枚比特币外，每加多一条交易记录，还会额外再多给一点点手续费。蚊子肉也是肉，辛勤的矿工们没有不喜欢的。</p>\n<p>在把交易记录加到区块的过程中，矿工们首先会验证一下这笔交易合不合法，也就是查查村里的账本，当C名下货币不足0.5个时，这条交易记录就会被拒绝加入到区块中。</p>\n<p>加入到区块中并不代表交易已经成功，只有当包含这个交易记录的区块的随机数X被某位矿工发现，并创造了新的交易区块链接在当前区块后，才能被认为是合法交易，这条交易记录也就成为被验证的交易。</p>\n<p>B可能会问了，那也就是说C发了给我钱的广播后，我还不能马上确定我是不是收到钱了啊？</p>\n<blockquote><p>没错，C发广播，只相当于C站在村口朝全村人喊了一句 “我给B 五毛钱！”，只有当全村的人都听见，把这件事都记在了个自账本上，并且记下这件事的那页被矿工翻过去以后，B的户头上多了五毛钱这件事才真正得到了全村村民的认可。由于参与比特币挖矿的矿工众多，通常每笔交易所需的验证时间是非常短的，不会给交易带来延迟感。</p></blockquote>\n<p>由此比特币的发行和交易首尾相连扣在了一起。交易通过发布广播的形式进行，矿工们听到广播后把交易写在交易区块中；矿工们通过挖矿来确认历史交易的完成，并由此创建新的区块，延长区块链，发行新的比特币。</p>\n<section>\n<section class=\"\">\n<h2>区块链的分叉</h2>\n</section>\n</section>\n<p>之前提到了<strong>区块链的分叉</strong>。为什么区块链会发生分叉呢？原因就在于<strong>去中心化</strong>。</p>\n<p>没有中心，大家都各自维护账本，因此受困于网络的延时、交流的不充分，难免有出现分歧的时候。</p>\n<p>举两个例子，一个是在挖矿时容易出现的问题：矿工B蒙对了随机数，挖矿成功，延长了区块链，注意，此时矿工B延长的区块链仅仅是自己的，其他人还都不知道这件事。当然，矿工B马上向全世界发布挖矿成功的消息，让大家按照他的方式延长区块链。</p>\n<p>但是这时，另一位矿工C也蒙对了随机数，他或者因为网速延迟还没听到B的广播，或者听到广播但不甘心，存心想破坏规则，于是他也把自己的区块链延长了，并开始向全世界发广播。</p>\n<p>因为网速的延迟，并不是所有人都先听到B的广播，此时就会出现一部分人按照B的指示更新区块链，一部分人按照C的指示更新区块链，而且因为网速的延迟，大家没办法确定到底是B还是C先发布的广播，从而引起区块链分叉。</p>\n<blockquote><p>就好比村里两位矿工B和C分别住在村东和村西，B和C差不多在同一时间挖矿成功，把自家账本翻页，在新的一页写下属于自己的宣言“X年X月，本村B(C)挖矿得到比特币一枚”，并开始向全村大喊让全村人翻页并写下这句话。由于他们分别住在村子的两头，结果村东头的人先听到B大喊于是按找B的话记账，村西头的人先听到C大喊于是按照C的话记账，导致全村的账本此时出现了两个版本。</p></blockquote>\n<p>第二种情况是<strong>双重交易</strong>，B与C进行交易，发布广播宣布付给C一枚比特币，但是B同时还跟D勾搭，几乎同时又发布广播宣布付给D一枚比特币，更糟糕的是，B宣布付出的是同一枚。</p>\n<p>跟第一种情况一样，由于网速问题，一部分矿工先听到B与C交易的广播，并将这条交易记录计入到当前交易区块中，后听到B与D的交易，并判定不合法，拒不添加到交易区块。而另一部分矿工正相反，只把B与D的交易添加到交易区块中。</p>\n<p>这两种情况并不是罕见的，由于比特币世界由全世界各地的人参与，有的地区用的是100M光宽带，有的地方用的是56K拨号上网，网速千差万别，而且又有很多人心怀不轨，存心作恶，因此区块链分叉几乎时时刻刻都在发生。此时，比特币世界的最高原则就起作用了：<strong>唯一合法的区块链是当前最长的区块链。</strong></p>\n<p>可是就上面两种分叉的情况来看，此时分叉的两个区块链一样长啊？没关系，这两条都合法，也都不合法，咱们搁置争议，继续开挖，看谁挖得快，谁先再蒙对新的X，让自己的区块链再进一步，谁的区块链就变成最长，也就成了唯一合法的了。这么一听，怎么感觉这个区块链系统这么随意，有些不靠谱的样子啊，如果大家都不守规则，随意分叉，世界岂不乱套。</p>\n<p>别急，接下来咱们通过分析会发现，最终区块链肯定会恢复成稳定的一条。</p>\n<p>让我们回到第一个情况矿工B和矿工C分歧问题中，假设B的链条再进一步，成为了最长链条，这条链条也就成为比特币世界认定的合法链条。此时C有两个选择，一是放弃努力，乖乖的扔掉自己的区块链，使用B的。另一种选择是不甘心失败，扔坚持自己的区块链，希望自己能很快继续追平B并反超。</p>\n<p>选择前者是大家都开心的，比特币世界的区块链从此统一，选择后者实际上继续让区块链保持分叉状态。那么从理性角度，C应该如何做呢？实际上C此时应该果断放弃自己的链条。</p>\n<p>我们可以分析一下，当B和C的链条分叉时，此时比特币世界存在4种矿工、两种势力，B和拥护B的吃瓜矿工，C和拥护C的吃瓜矿工。此时B势力与C势力大体相当，所以大家各挖各的。</p>\n<p>当B势力先一步延长了B的链条后，此时C势力就会发生分化，绝大部分拥护C的吃瓜群众只要听到B链条延长的消息，马上会转投到B链条上，因为此时B链条更长，在更长的链条上继续挖矿显然更有前途。势力马上发生逆转，C会尴尬地发现，全世界都在与他为敌（哭）。所以C不得不放弃。</p>\n<p>当然，假设是C的势力先延长了区块链，那么情形正好相反，全世界的矿工都会马上投入C的怀抱。尽管可能确实是B先挖到的矿，但此时B也不得不选择放弃自己的那条已经无人问津的区块链。按照这种理性的假设，全世界大部分矿工都会安分守己的选择在最长的链条上工作，所以偶尔的分叉也不是什么大不了的事。</p>\n<p>当然仍存在一种极端情况，即B或C一个人的算力超过全世界算力的50%，这时候他们凭借一己之力就有可能反超。但是事实上，由于全世界都在参与，很难有人或组织有这么强的算力，其次即使C有这么强的算力，他老老实实地在最长链条上挖矿就好了，也没必要硬刚全世界，非要显示霸权只会让全世界都不陪他玩了，最后比特币失去价值，C损失更大。</p>\n<p>上面所说的第二种分叉情况的解决办法与第一种情况同理，坚持“唯一合法的区块链是当前最长的区块链”原则不动摇，最终合法的一条区块链只会记录B与C交易或B与D交易的其中一个，具体原因读者可以自己想一想。</p>\n<p> </p>\n<p>讲了这么多，大家可以发现，比特币凭借区块链的巧妙设计，使得交易与发行以一种非常稳定的状态进行，而保持稳定的核心力量是什么呢？就是无数矿工提供的算力。</p>\n<p>只要矿工够多，算力够大，验证速度够快，比特币的交易就可以快速地被验证，不小心出现的区块链分叉状态可以很快结束，保证整个系统稳定运行。所以挖矿可不光只是费电，这些电能实际上转化成为维持整个系统稳定的能量！</p>\n<p>这也告诉我们为什么比特币可以一个币价值数万，而有些新发行的各种币一文不值，因为比特币做为历史最长、受众最广的电子货币，也拥有数量最多、分布最广泛的矿工和算力，是最稳定的电子货币。</p>\n<p>而新发行的货币矿工数量很少，参与的算力低，根本起不到稳定整个系统的作用，算力低也意味着每笔交易的验证时间会变长，从而降低货币的可用性，所以这样的新兴货币一文不值。</p>\n<p>好了，关于比特币以及比特币系统所用到的区块链技术就介绍到这里，如有大牛对文中内容有异议，欢迎拍砖探讨！</p>\n<p> </p>\n<p><strong>参考文献：</strong></p>\n<p>Satoshi《Bitcoin: A Peer-to-Peer Electronic Cash System》</p>\n</div>\n<p> </p>\n<p><strong>关于作者：</strong></p>\n<p>ChenJunXuan / CC，17 年硕士毕业于上海交大，目前在阿里达摩院做计算机视觉方向/智能医学影像相关的算法开发，喜欢 Python。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"111954\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"111954votetotal\">3</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"111954\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 2 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 2 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/6ee5b64dfb633d1d06e3478d949e5f0b666c3d17.jpg"}{"url_object_id": "c9d9c3009f6783bc6fdee771e14f8aa2", "title": "机器学习如何发现你喜欢的音乐", "url": "http://blog.jobbole.com/113821/", "created_date": "2018/04/13", "front_image_url": ["http://wx2.sinaimg.cn/large/7cc829d3gy1fq7l3ts6p3j20ps0ocq78.jpg"], "praise_nums": "1", "comments_nums": 0, "fav_nums": 0, "tags": "IT技术", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/1789912317\">XiaofengYue_DXY</a> 翻译，<a href=\"http://www.jobbole.com/members/hanxiaomax\">艾凌风</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://hackernoon.com/spotifys-discover-weekly-how-machine-learning-finds-your-new-music-19a41ab76efe\">Sophia Ciocca</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><h2>机器学习如何发现你喜欢的音乐：音乐个性化推荐背后的科学原理</h2>\n<p>本周一，正如其它每个周一，一亿多 Spotify 用户每人都收到了一个崭新的歌单。这个叫做每周发现的歌单内混合了用户从未听过但是可能会喜欢的 30首歌曲。效果堪称神奇。</p>\n<p>我自己是 Spotify 的超级粉丝，对每周发现尤其喜爱。为什么呢？因为我觉得它懂我。它比我生命中的任何人都更清楚我的音乐品味。我很高兴每周它都能满足我的需求，一如既往地推荐一些我自己永远都不会找到或知道会喜欢的歌曲。</p>\n<p>对于那些两耳不闻窗外事的人们，请允许我介绍一下我的虚拟好友：</p>\n<p><img id=\"pic\" class=\"M_cur_zoom_out aligncenter\" src=\"http://wx2.sinaimg.cn/large/7cc829d3gy1fq7l3ts6p3j20ps0ocq78.jpg\"></p>\n<p style=\"text-align: center;\">[图片说明: 我的 Spotify 每周发现歌单]</p>\n<p>没想到，在这方面我不是一个人，不光是我对每周发现如此着迷 – 整个用户群体都趋之若鹜。这股热潮使得 Spotify 重新调整了它的重心，并在基于算法的歌单上投入了更多的资源。</p>\n<p><img class=\"aligncenter\" src=\"http://wx4.sinaimg.cn/mw690/7cc829d3gy1fq7l3uppwxj20dy0bwabh.jpg\" width=\"502\" height=\"428\"></p>\n<blockquote><p>Dave Howitz: @Spotfiy 每周发现的歌单对我的了解程度简直毛骨悚然，熟悉到就像一个曾经与我有过一起濒死体验的前女友一样。</p>\n<p>Amanda Whitbred: 现在 @Spotify 的每周发现对我已经了解到如果它现在求婚，我也会说同意的地步了。</p></blockquote>\n<p>自「每周发现」在 2015 年第一次上线以来，我就迫切想知道它是怎么运作的（而且由于我是 Spotify 公司的迷妹，我喜欢假装在那里工作并研究他们的产品）。 经过三周的疯狂Google，我终于满怀感恩地获取了一些幕后的知识。</p>\n<p>所以 Spotify 到底是如何成功做到给每人每周挑选 30 首歌曲的？我们先来仔细看下其它的音乐服务是如何做音乐推荐，以及 Spotify 是如何更胜一筹的。</p>\n<p> </p>\n<h3>在线音乐甄选服务简史</h3>\n<p><span style=\"font-weight: normal;\"><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fq7l3vdopfj20iu07n756.jpg\" width=\"678\" height=\"275\"></span></p>\n<p><span style=\"font-weight: normal;\">早在千禧年之初，Songza 就开始使用手动甄选为用户提供歌单。手动甄选的意思就是所谓的音乐专家或者其他编辑会手动挑选一些他们自己认为不错的音乐做成歌单，然后听众可以直接拿来听。（稍后，Beats 音乐也采取了同样的策略）。手动甄选效果尚可，但是由于这种方法只是纯手工挑选，方式方法也比较简单，它并不能照顾到每个听众音乐品味的微妙差异。</span></p>\n<p>跟 Songza 一样， Pandora 也是音乐甄选服务领域的早期玩家之一。它使用了一个略为更高级的方法来代替给歌曲属性手工打标签。即大众在听音乐的时候，对每首歌曲挑选一些描述性的词语来作为标签。进而，Pandora 的程序可以直接过滤特定的标签来生成包含相似歌曲的歌单。</p>\n<p>差不多同一时间，一个隶属于麻省理工学院媒体实验室的名叫 The Echo Nest 的音乐信息机构，采用了一个完全不同的高级策略来定制音乐。The Echo Nest 使用算法来分析音频和音乐的文本内容，以完成音乐识别，个性化推荐，歌单创建和分析等。</p>\n<p>最后，是 Last.fm 另辟蹊径，采取了另一个沿用至今的策略。那就是利用协同过滤来识别用户可能喜欢的音乐。稍后本文会展开讨论更多这方面的内容。</p>\n<p>所以说既然其他的音乐甄选服务都实现了推荐功能，Spotify 究竟是怎么操作自己的神奇引擎，来实现甩出竞争对手几条街的用户品味默契度的呢？</p>\n<p> </p>\n<h3>Spotify 的三种推荐模型</h3>\n<p>事实上 Spotify 并没有使用什么单一的革命性推荐模型，而是<strong>混合了一些其他公司使用的最好的策略来创建他们自己独一无二的强大发现引擎。</strong></p>\n<p>Spotify 使用三种主要的推荐模型来创建每周发现：</p>\n<ol>\n<li><strong>协同过滤模型</strong>（即 Last.fm 最早使用的那些模型）。工作原理为分析你和<strong>其他</strong>用户的行为。</li>\n<li><strong>自然语言处理（NLP）</strong>模型 。工作原理为分析文本。</li>\n<li><strong>音频</strong>模型。工作原理为分析<strong>原始音频声道本身</strong>。</li>\n</ol>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fq7l3vwrx4j20mv0dgjw0.jpg\" width=\"690\" height=\"406\"></p>\n<p>我们来具体看下这些推荐模型是怎么工作的！</p>\n<h3>推荐模型之一：协同过滤</h3>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/7cc829d3gy1fq7l3wmkvhj218g094tah.jpg\" width=\"445\" height=\"91\"></p>\n<p>首先介绍下背景：当很多人听到协同过滤这几个词的时候，他们会立刻联想到 <strong>Netflix</strong>，因为它是第一个利用协同过滤来实现推荐模型的公司之一。其做法主要是使用用户提交的电影星级来计算推荐那些电影给其他<strong>类似的</strong>用户。</p>\n<p>自 <strong>Netflix </strong>将其成功应用以来，协同过滤开始快速流传开来。现在无论是谁想实现一个推荐模型的话，一般都会拿它作为初次尝试。</p>\n<p>与<strong>Netflix</strong>不同的是，Spotify 并没有用户对他们音乐的星级评价数据。Spotify 所用的数据是<strong>隐形反馈</strong>的，具体来说就是我们在线听歌的<strong>歌曲次数</strong>，以及其他额外信息，诸如用户是否保存歌曲到个人歌单，或者听完歌曲后是否接着访问艺术家主页等。</p>\n<p>但什么是协同过滤，到底它是如何工作的呢？下面用一段简短对话来做一个大致的介绍。</p>\n<p><img id=\"pic\" class=\"\" src=\"http://wx4.sinaimg.cn/large/7cc829d3gy1fq7l3x7gfyj20go0cytht.jpg\"></p>\n<p>啥情况? 原来这俩人里面每人都有自己的一些歌曲偏好 – 左边的人喜欢歌曲 P, Q, R 和 S; 右边的人喜欢 Q, R, S 和 T。</p>\n<p>协同过滤系统进而利用这些数据得出结论，</p>\n<blockquote><p><em>“</em><em>嗯。既然你俩都喜欢相同的歌曲 – Q</em><em>，R </em><em>和 S – </em><em>那么你们可能是类似的用户。所以你们应该会喜欢另一个人听过但是你还没有听过的歌曲。”</em></p></blockquote>\n<p>系统然后建议右边的人去体验下歌曲 P，以及左边的人去体验下歌曲 T。听起来够简单吧？</p>\n<p>但是 Spotify 具体是怎么具体应用这个概念，来计算<strong>基于百万级</strong>的用户偏好从而得出<strong>数以百万计</strong>的用户歌曲推荐呢？</p>\n<p> </p>\n<h3>…矩阵运算，用 Python 库即可实现</h3>\n<p><img class=\"alignnone\" src=\"http://wx3.sinaimg.cn/mw690/7cc829d3gy1fq7l3xy4boj20ay071t9u.jpg\" width=\"394\" height=\"253\"></p>\n<p>现实中，此处提及的矩阵是极其庞大的。<strong>每行都代表了</strong><strong> Spotify </strong><strong>的一亿四千万用户中的一员</strong>（如果你也用 Spotify，那么你也是这个矩阵中的一行），而每一列则代表了 Spotify 数据库中<strong>三亿首歌曲</strong>中的一首。</p>\n<p>然后，Python 库就开始跑这个漫长而复杂的矩阵分解公式：</p>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fq7l3yp06ej20oy01v3zg.jpg\" width=\"690\" height=\"51\"></p>\n<p>计算完成后，系统会生成两种类型的向量，在此分别命名为 X 和 Y。X 为用户向量，代表单个用户的音乐品味。Y 则为歌曲向量，代表单支歌曲的特征。</p>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fq7l3zb0mxj20mn0a8di9.jpg\" width=\"690\" height=\"312\"></p>\n<p>现在我们得到了一亿四千万个用户向量，每人一个，还有三亿歌曲向量。这些向量的具体内容只是一些单独拎出来自身并无意义的数字，但是在后面进行比较时会非常有用。</p>\n<p>为了找到那些跟我相似品味的用户，协同过滤系统会拿我的向量跟其他用户的向量作比较，最终会找到那些跟我最相似的用户。对于 Y 向量，也是同样的流程 – 你可以拿一首歌的向量与其他的歌曲向量做比较，进而找出哪些歌曲是跟你现在正在看的歌曲最相似。</p>\n<p>协同过滤确实效果不错，但是 Spotify 深知再添加另外一个引擎的话效果会更出色。这就到了自然语言处理出场的时候了。</p>\n<p> </p>\n<h3>推荐模型之二：自然语言处理</h3>\n<p>Spotify 采用的第二个推荐模型就是<strong>自然语言处理</strong>。这些模型的源数据，正如名字所示，就是一些普通的<strong>语言文字</strong> – 例如歌曲的元数据，新闻文章，博客，和互联网上的其它文本等。</p>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/7cc829d3gy1fq7l40111lj20dr09h41u.jpg\" width=\"495\" height=\"341\"></p>\n<p> </p>\n<p>自然语言处理 – 计算机理解人类语言的能力 – 本身就是一个巨大的领域，通常通过情感分析应用编程接口（API）来进行操作处理。</p>\n<p>自然语言处理背后的具体原理超出了本文的讨论范畴，但是在此本文可以提供一些粗略的描述：Spotify 会在网上不断爬取博客帖子以及其它音乐相关的文本，并找出人们对特定的艺术家和歌曲的评论 – 比如说人们对这些歌曲经常使用哪些形容词和语言, 以及哪些其他艺术家和歌曲也会和它们放在一起讨论。</p>\n<p>虽然我不知道 Spotify 如何处理他们抓取的数据，但是我可以介绍下 The Echo Nest 是如何使用它们的。他们会把数据分类成“文化向量”和“最佳评语集”。每个艺术家和歌曲都有数以千计的每日更新的最佳评语集。每个评语都有一个相关的权重，来表示其描述的重要性（简单说就是某人可能会用该评语描述某个音乐的概率）。</p>\n<p><img class=\"alignnone aligncenter\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fq7l40o7dnj20jm07qaej.jpg\" width=\"690\" height=\"272\"></p>\n<p style=\"text-align: center;\">[ “Cultural vectors”, or “top terms”, as used by the Echo Nest. Table from Brian Whitman]</p>\n<p>然后，与协同过滤类似，自然语言处理模型用这些评语和权重来创建一个歌曲的表达向量，可以用来确定两首音乐是否相似。很酷吧？</p>\n<p> </p>\n<h3>推荐模型之三：原始音频模型</h3>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fq7l41ibqgj20pn09btap.jpg\" width=\"690\" height=\"250\"></p>\n<p>首先，你可能会问这个问题：</p>\n<blockquote><p><em>但是，Sophia</em><em>，我们已经从前两种模型中获取了这么多数据！为什么还要继续分析音频本身呢？</em></p></blockquote>\n<p>额，首先要说的是，引入第三个模型会进一步提高这个已经很优秀的推荐服务的准确性。但实际上，采用这个模型还有另外一个次要目的：<strong>原始音频模型会把新歌考虑进来。</strong></p>\n<p>比如说，你的创作歌手朋友在 Spotify 上刚放上了一首新歌。可能它只有 50 次听歌记录，所以很少能有其他听众来一起协同过滤它。与此同时，它也在网上也没有留下多少痕迹，所以自然语言处理模型也不会注意到它。幸运的是，原始音频模型并不区分新歌曲和热门歌曲。所以有了它的帮忙，你朋友的歌曲也可以和流行歌曲一道出现在每周发现的歌单里面。</p>\n<p>好了，到了“如何”的部分了。我们如何才能分析这些看起来如此抽象的<strong>原始音频数据</strong>呢？</p>\n<p>…用<strong>卷积神经网络！</strong></p>\n<p>卷积神经网络同样也是支撑面部识别的技术。只不过在 Spotify 的案例中，他们被稍作修改以基于音频数据处理而不是像素点。下面是一个神经网络架构的例子：</p>\n<p><img class=\"alignnone aligncenter\" src=\"http://wx2.sinaimg.cn/mw690/7cc829d3gy1fq7l426503j20sg0gl423.jpg\" width=\"690\" height=\"402\"></p>\n<p style=\"text-align: center;\">[<em>Image credit: Sander Dieleman</em>]</p>\n<p>这个特定的神经网络有四个<strong>卷积层</strong>，具体为图中左侧的宽柱，和右边的稍微窄些的三根柱。输入是音频帧的时频表示，进而连接起来形成频谱图。</p>\n<p>音频帧会穿过这些卷积层，经过最后一个卷积层，你可以看到一个“全局临时池”层。该层在整个时间轴上汇集数据，并有效计算和统计歌曲时长内的学习特征。</p>\n<p>处理完之后，神经网络会得出其对歌曲的理解，包括估计的<strong>时间签名，音调，调式，拍子及音量</strong>等特征。下面就是 Draft Punk 的 “Around the World” 30 秒片段的数据图。</p>\n<p><img class=\"alignnone aligncenter\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fq7l43abdwj20fq0hkdk4.jpg\" width=\"566\" height=\"632\"></p>\n<p style=\"text-align: center;\">[Image Credit: <a href=\"http://docs.echonest.com.s3-website-us-east-1.amazonaws.com/_static/AnalyzeDocumentation.pdf\">Tristan Jehan &amp; David DesRoches (The Echo Nest)</a>]</p>\n<p>最终，对这些对歌曲关键特征的理解可以让 Spotify 来决定歌曲之间的相似度，以及根据用户听歌历史来判断哪些用户可能会喜欢它们。</p>\n<p>这些基本涵盖了为每周发现提供支持的推荐作业流程所依赖的三种主要模型。</p>\n<p><img id=\"pic\" class=\"aligncenter\" src=\"http://wx2.sinaimg.cn/large/7cc829d3gy1fq7l4426xrj20q70ec7ad.jpg\"></p>\n<p style=\"text-align: center;\">[ Cassandra instances]</p>\n<p>当然了，这些推荐模型也和 Spotify 其它更大的生态系统连接在一起，其中包括利用海量的数据存储以及<strong>非常多</strong>的 Hadoop 集群来做推荐服务的扩展，使得引擎得以计算巨型矩阵，无穷无尽的互联网音乐文章和大量的音频文件。</p>\n<p>我希望本文可以对你有所启发，并且像当时它对我一样能够激起你的好奇。怀着对幕后的机器学习技术的了解和感激之情，现在我将通过我自己的每周发现来寻找我喜欢的音乐。</p>\n<p>文章结束。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113821\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113821votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113821\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/1789912317\">XiaofengYue_DXY</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/1789912317\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2017/05/301e4d82055cbc30afc5d8e4ca14ea75.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            Backend Dev.        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/1789912317\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/1789912317/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/1789912317/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 10</a> · <a title=\"微博主页\" target=\"_blank\" href=\"http://weibo.com/1789912317\"><i class=\"fa fa-weibo\"></i></a> <a title=\"GitHub主页\" target=\"_blank\" href=\"https://github.com/yuexiaofeng\"><i class=\"fa fa-github\"></i></a>         </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/3b7e7bed23407111b13cf9f458c1f31bf494ba05.jpg"}{"url_object_id": "56e79f596a3a59be443b4a4f909b938a", "title": "如何实现一个基本的微信文章分类器", "url": "http://blog.jobbole.com/113691/", "created_date": "2018/04/04", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2016/09/3fb6592ac92133a71f0ae78e43683e83.jpg"], "praise_nums": "1", "comments_nums": 0, "fav_nums": 1, "tags": "IT技术,文本分类,机器学习", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文作者： <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/2653yy\">fullstackyang</a> 。未经作者许可，禁止转载！<br>欢迎加入伯乐在线 <a href=\"http://blog.jobbole.com/99322\" target=\"_blank\">专栏作者</a>。</div><p>微信公众号发布的文章和一般门户网站的新闻文本类型有所不同，通常不能用现有的文本分类器直接对这些文章进行分类，不过文本分类的原理是相通的，本文以微信公众号文章为对象，介绍朴素贝叶斯分类器的实现过程。</p>\n<p>文本分类的科学原理和数学证明在网上有很多，这里就不做赘述，本文尽量使用通熟易懂的表述方式，简明扼要地梳理一下文本分类器的各个知识点。</p>\n<p>参考了一下Github，发现少有Java 8风格的实现，所以这里的实现尽量利用Java 8的特性，相比之前优势有很多，例如stream在统计聚合等运算上比较方便，代码不仅简洁，而且更加语义化，另外在多线程并行控制上也省去不少的工作。</p>\n<p>本项目的地址：<a href=\"https://github.com/fullstackyang/article-classifier\">https://github.com/fullstacky…</a></p>\n<h1>一、文本分类器的概述</h1>\n<p>文本分类器可以看作是一个预测函数，在给定的文本时，在预定的类别集合中，判断该文本最可能属于哪个类。</p>\n<p>这里需要注意两个问题：</p>\n<ul>\n<li>在文本中含有比较多的标点符号和停用词（的，是，了等），直接使用整段文本处理肯定会产生很多不必要的计算，而且计算量也非常大，因此需要把给定的文本有效地进行表示，也就是选择一系列的特征词来代表这篇文本，这些特征词既可以比较好地反应所属文本的内容，又可以对不同文本有比较好的区分能力。</li>\n<li>在进行文本表示之后，如何对这些特征词进行预测，这就是分类器的算法设计问题了，比较常见的模型有朴素贝叶斯，基于支持向量机（SVM），K-近邻（KNN），决策树等分类算法。这里我们选择简单易懂的朴素贝叶斯算法。在机器学习中，朴素贝叶斯建模属于有监督学习，因此需要收集大量的文本作为训练语料，并标注分类结果</li>\n</ul>\n<p>综上，实现一个分类器通常分为以下几个步骤：</p>\n<ol>\n<li>收集并处理训练语料，以及最后测试用的测试语料</li>\n<li>在训练集上进行特征选择，得到一系列的特征项（词），这些特征项组成了所谓的特征空间</li>\n<li>为了表示某个特征项在不同文档中的重要程度，计算该特征项的权重，常用的计算方法有TF-IDF，本文采用的是“经典”朴素贝叶斯模型，这里不考虑特征项的权重（当然，一定要做也可以）</li>\n<li>训练模型，对于朴素贝叶斯模型来说，主要的是计算每个特征项在不同类别中的条件概率，这点下面再做解释。</li>\n<li>预测文本，模型训练完成之后可以保存到文件中，在预测时直接读入模型的数据进行计算。</li>\n</ol>\n<h1>二、准备训练语料</h1>\n<p>这里需要的语料就是微信公众号的文章，我们可以抓取搜狗微信搜索网站（<a href=\"http://weixin.sogou.com/\">http://weixin.sogou.com/</a>）首页上已经分类好的文章，直接采用其分类结果，这样也省去了标注的工作。至于如何开发爬虫去抓取文章，这里就不再讨论了。</p>\n<p><img src=\"http://www.fullstackyang.com/wp-content/uploads/2018/02/QQ20180228-161923.png\" width=\"936\" height=\"245\"></p>\n<p>“热门”这类别下的文章不具有一般性，因此不把它当作一个类别。剔除“热门”类别之后，最终我们抓取了30410篇文章，总共20个类别，每个类别的文章数并不均衡，其中最多 的是“养生堂”类别，有2569篇文章，最少的是“军事”类别，有654篇，大体符合微信上文章的分布情况。在保存时，我们保留了文章的标题，公众号名称，文章正文。</p>\n<h1>三、特征选择</h1>\n<p>如前文所述，特征选择的目的是降低特征空间的维度，避免维度灾难。简单地说，假设我们选择了2万个特征词，也就是说计算机通过学习，得到了一张有2万个词的“单词表”，以后它遇到的所有文本可以够用这张单词表中的词去表示其内容大意。这些特征词针对不同的类别有一定的区分能力，举例来说，“歼击机”可能来自“军事”，“越位”可能来自“体育”，“涨停”可能来自“财经”等等，而通常中文词汇量要比这个数字大得多，一本常见的汉语词典收录的词条数可达数十万。</p>\n<p>常见的特征选择方法有两个，信息增益法和卡方检验法。</p>\n<h2>3.1 信息增益</h2>\n<p>信息增益法的衡量标准是，这个特征项可以为分类系统带来多少信息量，所谓的信息增益就是该特征项包含的能够帮预测类别的信息量，这里所说的信息量可以用熵来衡量，计算信息增益时还需要引入条件熵的概念，公式如下</p>\n<p><img src=\"http://www.fullstackyang.com/wp-content/uploads/2018/02/IG.png\" width=\"967\" height=\"287\"></p>\n<p>可能有些见到公式就头大的小伙伴不太友好，不过这个公式虽然看起来有点复杂，其实在计算中还是比较简单的，解释一下：</p>\n<p>P(Cj)：Cj类文档在整个语料中出现的概率；</p>\n<p>P(ti)：语料中包含特征项ti的文档的概率，取反就是不包含特征项ti的文档的概率；</p>\n<p>P(Cj|ti)：文档包含特征项ti且属于Cj类的条件概率，取反就是文档不包含特征项ti且属于Cj类的条件概率</p>\n<p>上面几个概率值，都可以比较方便地从训练语料上统计得到。若还有不明白的小伙伴，推荐阅读这篇博客：<a href=\"http://www.blogjava.net/zhenandaci/archive/2009/03/24/261701.html\">文本分类入门（十一）特征选择方法之信息增益</a></p>\n<h2>3.2 卡方检验</h2>\n<p>卡方检验，基于χ2统计量(CHI)来衡量特征项ti和类别Cj之间的相关联程度，CHI统计值越高，该特征项与该类的相关性越大，如果两者相互独立，则CHI统计值接近零。计算时需要根据一张相依表（contingency table），公式也比较简单：</p>\n<p><img class=\"aligncenter\" src=\"http://www.fullstackyang.com/wp-content/uploads/2018/02/ct.png\" width=\"1061\" height=\"183\"></p>\n<p><img class=\"aligncenter\" src=\"http://www.fullstackyang.com/wp-content/uploads/2018/02/chi.png\" width=\"517\" height=\"90\"></p>\n<p>其中N就是文档总数，如果想继续讨论这个公式，推荐阅读这篇博客：<a href=\"http://www.deeplearn.me/1446.html\">特征选择（3）-卡方检验</a></p>\n<h2>3.3 算法实现</h2>\n<p>不论何种方式都需要对每个特征项进行估算，然后根据所得的数值进行筛选，通常可以设定一个阈值，低于阈值的特征项可以直接从特征空间中移除，另外也可以按照数值从高到低排序，并指定选择前N个。这里我们采用后者，总共截取前2万个特征项。</p>\n<p>特征选择实现类的代码如下，其中，不同特征选择方法需实现Strategy接口，以获得不同方法计算得到的估值，这里在截取特征项时为了避免不必要的麻烦，剔除了字符串长度为1的词。</p>\n<p>Doc对象表示一篇文档，其中包含了该文档的所属分类，以及分词结果（已经滤掉了停用词等），即Term集合；</p>\n<p>Term对象主要包含3个字段，词本身的字符串，词性（用于过滤），词频TF；</p>\n<p>Feature表示特征项，一个特征项对应一个Term对象，还包含两个hashmap，一个用来统计不同类别下该特征项出现的文档数量（categoryDocCounter），另一个用来统计不同类别下该特征项出现的频度（categoryTermCounter）（对应朴素贝叶斯两种不同模型，下文详述）</p>\n<p><strong>统计时引入FeatureCounter对象，使用stream的reduce方法进行归约。主要的思想就是把每一个文档中的Term集合，映射为Term和Feature的键值对，然后再和已有的Map进行合并，合并时如果遇到相同的Term，则调用Feature的Merge方法，该方法会将双方term的词频，以及categoryDocCounter和categoryTermCounter中的统计结果进行累加。最终将所有文档全部统计完成返回Feature集合。</strong></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ce4a7e2c0532482326\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n@AllArgsConstructor\r\npublic class FeatureSelection {\r\n\r\n    interface Strategy {\r\n        Feature estimate(Feature feature);\r\n    }\r\n\r\n    private final Strategy strategy;\r\n    private final static int FEATURE_SIZE = 20000;\r\n\r\n    public List select(List docs) {\r\n        return createFeatureSpace(docs.stream())\r\n                .stream()\r\n                .map(strategy::estimate)\r\n                .filter(f -&gt; f.getTerm().getWord().length() &gt; 1)\r\n                .sorted(comparing(Feature::getScore).reversed())\r\n                .limit(FEATURE_SIZE)\r\n                .collect(toList());\r\n    }\r\n\r\n    private Collection createFeatureSpace(Stream docs) {\r\n\r\n        @AllArgsConstructor\r\n        class FeatureCounter {\r\n            private final Map featureMap;\r\n\r\n            private FeatureCounter accumulate(Doc doc) {\r\n                Map temp = doc.getTerms().parallelStream()\r\n                        .map(t -&gt; new Feature(t, doc.getCategory()))\r\n                        .collect(toMap(Feature::getTerm, Function.identity()));\r\n                if (!featureMap.isEmpty())\r\n                    featureMap.values().forEach(f -&gt; temp.merge(f.getTerm(), f, Feature::merge));\r\n                return new FeatureCounter(temp);\r\n            }\r\n\r\n            private FeatureCounter combine(FeatureCounter featureCounter) {\r\n                Map temp = Maps.newHashMap(featureMap);\r\n                featureCounter.featureMap.values().forEach(f -&gt; temp.merge(f.getTerm(), f, Feature::merge));\r\n                return new FeatureCounter(temp);\r\n            }\r\n        }\r\n\r\n        FeatureCounter counter = docs.parallel()\r\n                .reduce(new FeatureCounter(Maps.newHashMap()),\r\n                        FeatureCounter::accumulate,\r\n                        FeatureCounter::combine);\r\n        return counter.featureMap.values();\r\n    }\r\n}\r\npublic class Feature {\r\n...\r\n    public Feature merge(Feature feature) {\r\n        if (this.term.equals(feature.getTerm())) {\r\n            this.term.setTf(this.term.getTf() + feature.getTerm().getTf());\r\n            feature.getCategoryDocCounter()\r\n                    .forEach((k, v) -&gt; categoryDocCounter.merge(k, v, (oldValue, newValue) -&gt; oldValue + newValue));\r\n            feature.getCategoryTermCounter()\r\n                    .forEach((k, v) -&gt; categoryTermCounter.merge(k, v, (oldValue, newValue) -&gt; oldValue + newValue));\r\n        }\r\n        return this;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2c0532482326-62\">62</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-1\"><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">AllArgsConstructor</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FeatureSelection</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">interface</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Strategy</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">Feature </span><span class=\"crayon-e\">estimate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">Feature </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Strategy </span><span class=\"crayon-v\">strategy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">FEATURE_SIZE</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">20000</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-10\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">List </span><span class=\"crayon-e\">select</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">List </span><span class=\"crayon-v\">docs</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">createFeatureSpace</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">docs</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">stream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-13\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">stream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-14\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">map</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">strategy</span><span class=\"crayon-o\">::</span><span class=\"crayon-v\">estimate</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-15\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">filter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">f</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">f</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTerm</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getWord</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">length</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-16\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sorted</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">comparing</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Feature</span><span class=\"crayon-o\">::</span><span class=\"crayon-v\">getScore</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">reversed</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-17\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">limit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">FEATURE_SIZE</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-18\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">collect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">toList</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-20\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Collection </span><span class=\"crayon-e\">createFeatureSpace</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">Stream </span><span class=\"crayon-v\">docs</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-22\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">AllArgsConstructor</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FeatureCounter</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-25\"><span class=\"crayon-h\">            </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Map </span><span class=\"crayon-v\">featureMap</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-26\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-27\"><span class=\"crayon-h\">            </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FeatureCounter </span><span class=\"crayon-e\">accumulate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">Doc </span><span class=\"crayon-v\">doc</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-28\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">Map </span><span class=\"crayon-v\">temp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">doc</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTerms</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">parallelStream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-29\"><span class=\"crayon-h\">                        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">map</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Feature</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">t</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">doc</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getCategory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-30\"><span class=\"crayon-h\">                        </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">collect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">toMap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Feature</span><span class=\"crayon-o\">::</span><span class=\"crayon-v\">getTerm</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">Function</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">identity</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-31\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">featureMap</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">isEmpty</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-32\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">featureMap</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">values</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">forEach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">f</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">merge</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">f</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTerm</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">f</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Feature</span><span class=\"crayon-o\">::</span><span class=\"crayon-v\">merge</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-33\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FeatureCounter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-34\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-35\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-36\"><span class=\"crayon-h\">            </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FeatureCounter </span><span class=\"crayon-e\">combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">FeatureCounter </span><span class=\"crayon-v\">featureCounter</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-37\"><span class=\"crayon-h\">                </span><span class=\"crayon-e\">Map </span><span class=\"crayon-v\">temp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Maps</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">newHashMap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">featureMap</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-38\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">featureCounter</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">featureMap</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">values</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">forEach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">f</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">merge</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">f</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTerm</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">f</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Feature</span><span class=\"crayon-o\">::</span><span class=\"crayon-v\">merge</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-39\"><span class=\"crayon-h\">                </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FeatureCounter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">temp</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-40\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-41\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-42\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-43\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">FeatureCounter </span><span class=\"crayon-v\">counter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">docs</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">parallel</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-44\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">reduce</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FeatureCounter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Maps</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">newHashMap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-45\"><span class=\"crayon-h\">                        </span><span class=\"crayon-v\">FeatureCounter</span><span class=\"crayon-o\">::</span><span class=\"crayon-v\">accumulate</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-46\"><span class=\"crayon-h\">                        </span><span class=\"crayon-v\">FeatureCounter</span><span class=\"crayon-o\">::</span><span class=\"crayon-v\">combine</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-47\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">counter</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">featureMap</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">values</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-48\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-49\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-50\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Feature</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-51\"><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-52\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Feature </span><span class=\"crayon-e\">merge</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">Feature </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-53\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">term</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">equals</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTerm</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-54\"><span class=\"crayon-h\">            </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">term</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setTf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">term</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTerm</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-55\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getCategoryDocCounter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-56\"><span class=\"crayon-h\">                    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">forEach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">v</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">categoryDocCounter</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">merge</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">v</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">oldValue</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">newValue</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">oldValue</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">newValue</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-57\"><span class=\"crayon-h\">            </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getCategoryTermCounter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-58\"><span class=\"crayon-h\">                    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">forEach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">v</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">categoryTermCounter</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">merge</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">v</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">oldValue</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">newValue</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">oldValue</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">newValue</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-59\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-60\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2c0532482326-61\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2c0532482326-62\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0121 seconds] -->\r\n<p>信息增益实现如下，在计算条件熵时，利用了stream的collect方法，将包含和不包含特征项的两种情况用一个hashmap分开再进行归约。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ce4a7e2cb473911172\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n@AllArgsConstructor\r\npublic class IGStrategy implements FeatureSelection.Strategy {\r\n\r\n    private final Collection categories;\r\n\r\n    private final int total;\r\n\r\n    public Feature estimate(Feature feature) {\r\n        double totalEntropy = calcTotalEntropy();\r\n        double conditionalEntrogy = calcConditionEntropy(feature);\r\n        feature.setScore(totalEntropy - conditionalEntrogy);\r\n        return feature;\r\n    }\r\n\r\n    private double calcTotalEntropy() {\r\n        return Calculator.entropy(categories.stream().map(c -&gt; (double) c.getDocCount() / total).collect(toList()));\r\n    }\r\n\r\n    private double calcConditionEntropy(Feature feature) {\r\n        int featureCount = feature.getFeatureCount();\r\n        double Pfeature = (double) featureCount / total;\r\n\r\n        Map&gt; Pcondition = categories.parallelStream().collect(() -&gt; new HashMap&gt;() {{\r\n                    put(true, Lists.newArrayList());\r\n                    put(false, Lists.newArrayList());\r\n                }}, (map, category) -&gt; {\r\n                    int countDocWithFeature = feature.getDocCountByCategory(category);\r\n                    //出现该特征词且属于类别key的文档数量/出现该特征词的文档总数量\r\n                    map.get(true).add((double) countDocWithFeature / featureCount);\r\n                    //未出现该特征词且属于类别key的文档数量/未出现该特征词的文档总数量\r\n                    map.get(false).add((double) (category.getDocCount() - countDocWithFeature) / (total - featureCount));\r\n                },\r\n                (map1, map2) -&gt; {\r\n                    map1.get(true).addAll(map2.get(true));\r\n                    map1.get(false).addAll(map2.get(false));\r\n                }\r\n        );\r\n        return Calculator.conditionalEntrogy(Pfeature, Pcondition.get(true), Pcondition.get(false));\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2cb473911172-40\">40</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-1\"><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">AllArgsConstructor</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IGStrategy </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">FeatureSelection</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">Strategy</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Collection </span><span class=\"crayon-v\">categories</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Feature </span><span class=\"crayon-e\">estimate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">Feature </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">double</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">totalEntropy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">calcTotalEntropy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">double</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">conditionalEntrogy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">calcConditionEntropy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setScore</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">totalEntropy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">conditionalEntrogy</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-12\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-14\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-15\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">double</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">calcTotalEntropy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Calculator</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">entropy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">categories</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">stream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">map</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">c</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">double</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getDocCount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">collect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">toList</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-18\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">double</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">calcConditionEntropy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">Feature </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">featureCount</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getFeatureCount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">double</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Pfeature</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">double</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">featureCount</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-22\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">Map</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Pcondition</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">categories</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">parallelStream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">collect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">HashMap</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-24\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">put</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Lists</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">newArrayList</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-25\"><span class=\"crayon-h\">                    </span><span class=\"crayon-e\">put</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Lists</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">newArrayList</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-26\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">map</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-27\"><span class=\"crayon-h\">                    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">countDocWithFeature</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getDocCountByCategory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-28\"><span class=\"crayon-h\">                    </span><span class=\"crayon-c\">//出现该特征词且属于类别key的文档数量/出现该特征词的文档总数量</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-29\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">map</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">add</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">double</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">countDocWithFeature</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">featureCount</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-30\"><span class=\"crayon-h\">                    </span><span class=\"crayon-c\">//未出现该特征词且属于类别key的文档数量/未出现该特征词的文档总数量</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-31\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">map</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">add</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">double</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getDocCount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">countDocWithFeature</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">total</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">featureCount</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-32\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-33\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">map1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">map2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-34\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">map1</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">addAll</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">map2</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-35\"><span class=\"crayon-h\">                    </span><span class=\"crayon-v\">map1</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">addAll</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">map2</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-36\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-37\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-38\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Calculator</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">conditionalEntrogy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Pfeature</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Pcondition</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Pcondition</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2cb473911172-39\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2cb473911172-40\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0084 seconds] -->\r\n<p>卡方检验实现如下，每个特征项要在每个类别上分别计算CHI值，最终保留其最大值</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ce4a7e2d0108907766\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n@AllArgsConstructor\r\npublic class ChiSquaredStrategy implements Strategy {\r\n\r\n    private final Collection categories;\r\n\r\n    private final int total;\r\n\r\n    @ Override\r\n    public Feature estimate(Feature feature) {\r\n\r\n        class ContingencyTable {\r\n            private final int A, B, C, D;\r\n\r\n            private ContingencyTable(Feature feature, Category category) {\r\n                A = feature.getDocCountByCategory(category);\r\n                B = feature.getFeatureCount() - A;\r\n                C = category.getDocCount() - A;\r\n                D = total - A - B - C;\r\n            }\r\n        }\r\n\r\n        Double chisquared = categories.stream()\r\n                .map(c -&gt; new ContingencyTable(feature, c))\r\n                .map(ct -&gt; Calculator.chisquare(ct.A, ct.B, ct.C, ct.D))\r\n                .max(Comparator.comparingDouble(Double::valueOf)).get();\r\n        feature.setScore(chisquared);\r\n        return feature;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2d0108907766-29\">29</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-1\"><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">AllArgsConstructor</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2d0108907766-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ChiSquaredStrategy</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Strategy</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2d0108907766-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Collection </span><span class=\"crayon-v\">categories</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2d0108907766-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2d0108907766-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">@</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Override</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-9\"><span class=\"crayon-e\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Feature </span><span class=\"crayon-e\">estimate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">Feature </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2d0108907766-10\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ContingencyTable</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2d0108907766-12\"><span class=\"crayon-h\">            </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">A</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">B</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">C</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">D</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2d0108907766-14\"><span class=\"crayon-h\">            </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ContingencyTable</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">Feature </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Category </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-15\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">A</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getDocCountByCategory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2d0108907766-16\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">B</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getFeatureCount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">A</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-17\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">C</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getDocCount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">A</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2d0108907766-18\"><span class=\"crayon-h\">                </span><span class=\"crayon-v\">D</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">A</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">B</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">C</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-19\"><span class=\"crayon-h\">            </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2d0108907766-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-21\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2d0108907766-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">Double</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">chisquared</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">categories</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">stream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-23\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">map</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">c</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ContingencyTable</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2d0108907766-24\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">map</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ct</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Calculator</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">chisquare</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ct</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">A</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ct</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">B</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ct</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">C</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ct</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">D</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-25\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Comparator</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">comparingDouble</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">Double</span><span class=\"crayon-o\">::</span><span class=\"crayon-v\">valueOf</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2d0108907766-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setScore</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">chisquared</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2d0108907766-28\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2d0108907766-29\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0050 seconds] -->\r\n<p></p>\n<h1>四、朴素贝叶斯模型</h1>\n<h2>4.1 原理简介</h2>\n<p>朴素贝叶斯模型之所以称之“朴素”，是因为其假设特征之间是相互独立的，在文本分类中，也就是说，一篇文档中出现的词都是相互独立，彼此没有关联，显然文档中出现的词都是有逻辑性的，这种假设在现实中几乎是不成立的，但是这种假设却大大简化了计算，根据贝叶斯公式，文档Doc属于类别Ci的概率为：</p>\n<p><img class=\"aligncenter\" src=\"http://www.fullstackyang.com/wp-content/uploads/2018/03/nb.png\" width=\"405\" height=\"86\"></p>\n<p>P(Ci|Doc)是所求的后验概率，我们在判定分类时，根据每个类别计算P(Ci|Doc)，最终把P(Ci|Doc)取得最大值的那个分类作为文档的类别。其中，P(Doc)对于类别Ci来说是常量，在比较大小时可以不用参与计算，而P(Ci)表示类别Ci出现的概率，我们称之为先验概率，这可以方便地从训练集中统计得出，至于P(Doc|Ci)，也就是类别的条件概率，如果没有朴素贝叶斯的假设，那么计算是非常困难的。</p>\n<p>举例来说，假设有一篇文章，内容为“王者荣耀：两款传说品质皮肤将优化，李白最新模型海报爆料”，经过特征选择，文档可以表示为Doc=(王者荣耀，传说，品质，皮肤，优化，李白，最新，模型，海报，爆料)，那么在预测时需要计算P(王者荣耀，传说，品质，皮肤，优化，李白，最新，模型，海报，爆料|Ci)，这样一个条件概率是不可计算的，因为第一个特征取值为“王者荣耀”，第二个特征取值“传说”……第十个特征取值“爆料”的文档很可能为没有，那么概率就为零，而基于朴素贝叶斯的假设，这个条件概率可以转化为：</p>\n<p>P(王者荣耀，传说，品质，皮肤，优化，李白，最新，模型，海报，爆料|Ci)=P(王者荣耀|Ci)<em>P(传说|Ci)……</em>P(爆料|Ci)</p>\n<p>于是我们就可以统计这些特征词在每个类别中出现的概率了，在这个例子中，游戏类别中“王者荣耀”这个特征项会频繁出现，因此P(王者荣耀|游戏)的条件概率要明显高于其他类别，这就是朴素贝叶斯模型的朴素之处，粗鲁的聪明。</p>\n<h2>4.2 多项式模型与伯努利模型</h2>\n<p>在具体实现中，朴素贝叶斯又可以分为两种模型，多项式模型（Multinomial）和伯努利模型（Bernoulli），另外还有高斯模型，主要用于处理连续型变量，在文本分类中不讨论。</p>\n<p>多项式模型和伯努利模型的区别在于对词频的考察，在多项式模型中文档中特征项的频度是参与计算的，这对于长文本来说是比较公平的，例如上面的例子，“王者荣耀”在游戏类的文档中频度会比较高，而伯努利模型中，所有特征词都均等地对待，只要出现就记为1，未出现就记为0，两者公式如下：</p>\n<p><img class=\"aligncenter\" src=\"http://www.fullstackyang.com/wp-content/uploads/2018/03/nb-b-m.png\" width=\"755\" height=\"238\"></p>\n<p>在伯努利模型计算公式中，N(Doc(tj)|Ci)表示Ci类文档中特征tj出现的文档数，|D|表示类别Ci的文档数，P(Ci)可以用类别Ci的文档数/文档总数来计算，</p>\n<p>在多项式模型计算公式中，TF(ti,Doc)是文档Doc中特征ti出现的频度，TF(ti,Ci)就表示类别Ci中特征ti出现的频度，|V|表示特征空间的大小，也就是特征选择之后，不同（即去掉重复之后）的特征项的总个数，而P(Ci)可以用类别Ci中特征词的总数/所有特征词的总数，所有特征词的总数也就是所有特征词的词频之和。</p>\n<p>至于分子和分母都加上一定的常量，这是为了防止数据稀疏而产生结果为零的现象，这种操作称为拉普拉斯平滑，至于背后的原理，推荐阅读这篇博客：<a href=\"https://zhuanlan.zhihu.com/p/24291822\">贝叶斯统计观点下的拉普拉斯平滑</a></p>\n<h2>4.3 算法实现</h2>\n<p>这里使用了枚举类来封装两个模型，并实现了分类器NaiveBayesClassifier和训练器NaiveBayesLearner中的两个接口，其中Pprior和Pcondition是训练器所需的方法，前者用来计算先验概率，后者用来计算不同特征项在不同类别下的条件概率；getConditionProbability是分类器所需的方法，NaiveBayesKnowledgeBase对象是模型数据的容器，它的getPconditionByWord方法就是用于查询不同特征词在不同类别下的条件概率</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ce4a7e2e4117827876\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npublic enum NaiveBayesModels implements NaiveBayesClassifier.Model, NaiveBayesLearner.Model {\r\n    Bernoulli {\r\n        @ Override\r\n        public double Pprior(int total, Category category) {\r\n            int Nc = category.getDocCount();\r\n            return Math.log((double) Nc / total);\r\n        }\r\n\r\n        @ Override\r\n        public double Pcondition(Feature feature, Category category, double smoothing) {\r\n            int Ncf = feature.getDocCountByCategory(category);\r\n            int Nc = category.getDocCount();\r\n            return Math.log((double) (1 + Ncf) / (Nc + smoothing));\r\n        }\r\n\r\n        @ Override\r\n        public List getConditionProbability(String category, List terms, final NaiveBayesKnowledgeBase knowledgeBase) {\r\n            return terms.stream().map(term -&gt; knowledgeBase.getPconditionByWord(category, term.getWord())).collect(toList());\r\n        }\r\n    },\r\n    Multinomial {\r\n        @ Override\r\n        public double Pprior(int total, Category category) {\r\n            int Nt = category.getTermCount();\r\n            return Math.log((double) Nt / total);\r\n        }\r\n\r\n        @ Override\r\n        public double Pcondition(Feature feature, Category category, double smoothing) {\r\n            int Ntf = feature.getTermCountByCategory(category);\r\n            int Nt = category.getTermCount();\r\n            return Math.log((double) (1 + Ntf) / (Nt + smoothing));\r\n        }\r\n\r\n        @ Override\r\n        public List getConditionProbability(String category, List terms, final NaiveBayesKnowledgeBase knowledgeBase) {\r\n            return terms.stream().map(term -&gt; term.getTf() * knowledgeBase.getPconditionByWord(category, term.getWord())).collect(toList());\r\n        }\r\n    };\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e4117827876-40\">40</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">enum</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">NaiveBayesModels </span><span class=\"crayon-r\">implements</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NaiveBayesClassifier</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Model</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NaiveBayesLearner</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">Model</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-2\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">Bernoulli</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-3\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">@</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Override</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-4\"><span class=\"crayon-e\">        </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">double</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Pprior</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Category </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-5\"><span class=\"crayon-h\">            </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Nc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getDocCount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-6\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Math</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">double</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Nc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-8\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">@</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Override</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-10\"><span class=\"crayon-e\">        </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">double</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Pcondition</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">Feature </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Category </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">double</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">smoothing</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-11\"><span class=\"crayon-h\">            </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Ncf</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getDocCountByCategory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-12\"><span class=\"crayon-h\">            </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Nc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getDocCount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-13\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Math</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">double</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Ncf</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Nc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">smoothing</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">@</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Override</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-17\"><span class=\"crayon-e\">        </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">List </span><span class=\"crayon-e\">getConditionProbability</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">String</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">List </span><span class=\"crayon-v\">terms</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">NaiveBayesKnowledgeBase </span><span class=\"crayon-v\">knowledgeBase</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-18\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">terms</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">stream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">map</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">term</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">knowledgeBase</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getPconditionByWord</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">term</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getWord</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">collect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">toList</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">Multinomial</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">@</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Override</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-23\"><span class=\"crayon-e\">        </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">double</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Pprior</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Category </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-24\"><span class=\"crayon-h\">            </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Nt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTermCount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-25\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Math</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">double</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Nt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-27\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-28\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">@</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Override</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-29\"><span class=\"crayon-e\">        </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">double</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Pcondition</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">Feature </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Category </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">double</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">smoothing</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-30\"><span class=\"crayon-h\">            </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Ntf</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTermCountByCategory</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-31\"><span class=\"crayon-h\">            </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Nt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTermCount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-32\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Math</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">double</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Ntf</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Nt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">smoothing</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-33\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-34\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-35\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">@</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Override</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-36\"><span class=\"crayon-e\">        </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">List </span><span class=\"crayon-e\">getConditionProbability</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">String</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">List </span><span class=\"crayon-v\">terms</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">NaiveBayesKnowledgeBase </span><span class=\"crayon-v\">knowledgeBase</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-37\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">terms</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">stream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">map</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">term</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">term</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">knowledgeBase</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getPconditionByWord</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">term</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getWord</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">collect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">toList</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-38\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e4117827876-39\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e4117827876-40\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0088 seconds] -->\r\n<p></p>\n<h2>五、训练模型</h2>\n<p>根据朴素贝叶斯模型的定义，训练模型的过程就是计算每个类的先验概率，以及每个特征项在不同类别下的条件概率，NaiveBayesKnowledgeBase对象将训练器在训练时得到的结果都保存起来，训练完成时写入文件，启动分类时从文件中读入数据交由分类器使用，那么在分类时就可以直接参与到计算过程中。</p>\n<p>训练器的实现如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ce4a7e2e9182895414\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npublic class NaiveBayesLearner {\r\n    ……\r\n    ……\r\n    public NaiveBayesLearner statistics() {\r\n        log.info(\"开始统计...\");\r\n        this.total = total();\r\n        log.info(\"total : \" + total);\r\n        this.categorySet = trainSet.getCategorySet();\r\n        featureSet.forEach(f -&gt; f.getCategoryTermCounter().forEach((category, count) -&gt; category.setTermCount(category.getTermCount() + count)));\r\n        return this;\r\n    }\r\n\r\n    public NaiveBayesKnowledgeBase build() {\r\n        this.knowledgeBase.setCategories(createCategorySummaries(categorySet));\r\n        this.knowledgeBase.setFeatures(createFeatureSummaries(featureSet, categorySet));\r\n        return knowledgeBase;\r\n    }\r\n\r\n    private Map createFeatureSummaries(final Set featureSet, final Set categorySet) {\r\n        return featureSet.parallelStream()\r\n                .map(f -&gt; knowledgeBase.createFeatureSummary(f, getPconditions(f, categorySet)))\r\n                .collect(toMap(NaiveBayesKnowledgeBase.FeatureSummary::getWord, Function.identity()));\r\n    }\r\n\r\n    private Map createCategorySummaries(final Set categorySet) {\r\n        return categorySet.stream().collect(toMap(Category::getName, c -&gt; model.Pprior(total, c)));\r\n    }\r\n\r\n    private Map getPconditions(final Feature feature, final Set categorySet) {\r\n        final double smoothing = smoothing();\r\n        return categorySet.stream()\r\n                .collect(toMap(Category::getName, c -&gt; model.Pcondition(feature, c, smoothing)));\r\n    }\r\n\r\n    private int total() {\r\n        if (model == Multinomial)\r\n            return featureSet.parallelStream().map(Feature::getTerm).mapToInt(Term::getTf).sum();//总词频数\r\n        else if (model == Bernoulli)\r\n            return trainSet.getTotalDoc();//总文档数\r\n        return 0;\r\n    }\r\n\r\n    private double smoothing() {\r\n        if (model == Multinomial)\r\n            return this.featureSet.size();\r\n        else if (model == Bernoulli)\r\n            return 2.0;\r\n        return 0.0;\r\n    }\r\n\r\n    public static void main(String[] args) {\r\n        TrainSet trainSet = new TrainSet(System.getProperty(\"user.dir\") + \"/trainset/\");\r\n\r\n        log.info(\"特征选择开始...\");\r\n        FeatureSelection featureSelection = new FeatureSelection(new ChiSquaredStrategy(trainSet.getCategorySet(), trainSet.getTotalDoc()));\r\n        List features = featureSelection.select(trainSet.getDocs());\r\n        log.info(\"特征选择完成,特征数:[\" + features.size() + \"]\");\r\n\r\n        NaiveBayesModels model = NaiveBayesModels.Multinomial;\r\n        NaiveBayesLearner learner = new NaiveBayesLearner(model, trainSet, Sets.newHashSet(features));\r\n        learner.statistics().build().write(model.getModelPath());\r\n        log.info(\"模型文件写入完成,路径:\" + model.getModelPath());\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2e9182895414-64\">64</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">NaiveBayesLearner</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-2\"><span class=\"crayon-h\">    </span>……</div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-3\"><span class=\"crayon-h\">    </span>……</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-4\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">NaiveBayesLearner </span><span class=\"crayon-e\">statistics</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-5\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">log</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">info</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"开始统计...\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">total</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">total</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-7\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">log</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">info</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"total : \"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">categorySet</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">trainSet</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getCategorySet</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">featureSet</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">forEach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">f</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">f</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getCategoryTermCounter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">forEach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">count</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setTermCount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTermCount</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">count</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-11\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-12\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-13\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">NaiveBayesKnowledgeBase </span><span class=\"crayon-e\">build</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">knowledgeBase</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setCategories</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">createCategorySummaries</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">categorySet</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-15\"><span class=\"crayon-h\">        </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">knowledgeBase</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setFeatures</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">createFeatureSummaries</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">featureSet</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">categorySet</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-16\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">knowledgeBase</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-17\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-18\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Map </span><span class=\"crayon-e\">createFeatureSummaries</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Set </span><span class=\"crayon-v\">featureSet</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Set </span><span class=\"crayon-v\">categorySet</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">featureSet</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">parallelStream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-21\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">map</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">f</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">knowledgeBase</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">createFeatureSummary</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">f</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">getPconditions</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">f</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">categorySet</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-22\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">collect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">toMap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">NaiveBayesKnowledgeBase</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">FeatureSummary</span><span class=\"crayon-o\">::</span><span class=\"crayon-v\">getWord</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">Function</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">identity</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-23\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-24\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-25\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Map </span><span class=\"crayon-e\">createCategorySummaries</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Set </span><span class=\"crayon-v\">categorySet</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">categorySet</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">stream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">collect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">toMap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Category</span><span class=\"crayon-o\">::</span><span class=\"crayon-v\">getName</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">model</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Pprior</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">total</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-27\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-28\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Map </span><span class=\"crayon-e\">getPconditions</span><span class=\"crayon-sy\">(</span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Feature </span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Set </span><span class=\"crayon-v\">categorySet</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-30\"><span class=\"crayon-h\">        </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">double</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">smoothing</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">smoothing</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-31\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">categorySet</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">stream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-32\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">collect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">toMap</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Category</span><span class=\"crayon-o\">::</span><span class=\"crayon-v\">getName</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">model</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Pcondition</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">feature</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">smoothing</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-33\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-34\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-35\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">total</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-36\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">model</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Multinomial</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-37\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">featureSet</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">parallelStream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">map</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Feature</span><span class=\"crayon-o\">::</span><span class=\"crayon-v\">getTerm</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">mapToInt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Term</span><span class=\"crayon-o\">::</span><span class=\"crayon-v\">getTf</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sum</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//总词频数</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-38\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">model</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Bernoulli</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-39\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">trainSet</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTotalDoc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">//总文档数</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-40\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-41\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-42\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-43\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">double</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">smoothing</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-44\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">model</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Multinomial</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-45\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">featureSet</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">size</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-46\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">model</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Bernoulli</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-47\"><span class=\"crayon-h\">            </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2.0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-48\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0.0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-49\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-50\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-51\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">String</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">args</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-52\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">TrainSet </span><span class=\"crayon-v\">trainSet</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TrainSet</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getProperty</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"user.dir\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"/trainset/\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-53\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-54\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">log</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">info</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"特征选择开始...\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-55\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">FeatureSelection </span><span class=\"crayon-v\">featureSelection</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">FeatureSelection</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ChiSquaredStrategy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">trainSet</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getCategorySet</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">trainSet</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getTotalDoc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-56\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">List </span><span class=\"crayon-v\">features</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">featureSelection</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">select</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">trainSet</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getDocs</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-57\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">log</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">info</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"特征选择完成,特征数:[\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">features</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">size</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"]\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-58\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-59\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">NaiveBayesModels </span><span class=\"crayon-v\">model</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NaiveBayesModels</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Multinomial</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-60\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">NaiveBayesLearner </span><span class=\"crayon-v\">learner</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">NaiveBayesLearner</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">model</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">trainSet</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Sets</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">newHashSet</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">features</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-61\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">learner</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">statistics</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">build</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">model</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getModelPath</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-62\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">log</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">info</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"模型文件写入完成,路径:\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">model</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getModelPath</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2e9182895414-63\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2e9182895414-64\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0137 seconds] -->\r\n<p>在main函数中执行整个训练过程，首先执行特征选择，这里使用卡方检验法，然后将得到特征空间，朴素贝叶斯模型（多项式模型），以及训练集TrainSet对象作为参数，初始化训练器，接着训练器开始进行统计的工作，事实上有一部分的统计工作，在初始化训练集对象时，就已经完成了，例如总文档数，每个类别下的文档数等，这些可以直接拿过来使用，最终将数据都装载到NaiveBayesKnowledgeBase对象当中去，并写入文件，格式为第一行是不同类别的先验概率，余下每一行对应一个特征项，每一列对应不同类别的条件概率值。</p>\n<h1>六，测试模型</h1>\n<p>分类器预测过程就相对于比较简单了，通过NaiveBayesKnowledgeBase读入数据，然后将指定的文本进行分词，匹配特征项，然后计算在不同类别下的后验概率，返回取得最大值对应的那个类别。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ce4a7e2ef811463807\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\npublic class NaiveBayesClassifier {\r\n    ……\r\n    private final Model model;\r\n\r\n    private final NaiveBayesKnowledgeBase knowledgeBase;\r\n\r\n    public NaiveBayesClassifier(Model model) {\r\n        this.model = model;\r\n        this.knowledgeBase = new NaiveBayesKnowledgeBase(model.getModelPath());\r\n    }\r\n\r\n    public String predict(String content) {\r\n        Set allFeatures = knowledgeBase.getFeatures().keySet();\r\n        List terms = NLPTools.instance().segment(content).stream()\r\n                .filter(t -&gt; allFeatures.contains(t.getWord())).distinct().collect(toList());\r\n\r\n        @AllArgsConstructor\r\n        class Result {\r\n            final String category;\r\n            final double probability;\r\n        }\r\n\r\n        Result result = knowledgeBase.getCategories().keySet().stream()\r\n                .map(c -&gt; new Result(c, Calculator.Ppost(knowledgeBase.getCategoryProbability(c),\r\n                        model.getConditionProbability(c, terms, knowledgeBase))))\r\n                .max(Comparator.comparingDouble(r -&gt; r.probability)).get();\r\n        return result.category;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce4a7e2ef811463807-29\">29</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">NaiveBayesClassifier</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2ef811463807-2\"><span class=\"crayon-h\">    </span>……</div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Model </span><span class=\"crayon-v\">model</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2ef811463807-4\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">NaiveBayesKnowledgeBase </span><span class=\"crayon-v\">knowledgeBase</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2ef811463807-6\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-7\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">NaiveBayesClassifier</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">Model </span><span class=\"crayon-v\">model</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2ef811463807-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">model</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">model</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">knowledgeBase</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">NaiveBayesKnowledgeBase</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">model</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getModelPath</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2ef811463807-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-11\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2ef811463807-12\"><span class=\"crayon-h\">    </span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">String</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">predict</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">String</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-13\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">Set </span><span class=\"crayon-v\">allFeatures</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">knowledgeBase</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getFeatures</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">keySet</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2ef811463807-14\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">List </span><span class=\"crayon-v\">terms</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NLPTools</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">instance</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">segment</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">stream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-15\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">filter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">allFeatures</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">contains</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getWord</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">distinct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">collect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">toList</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2ef811463807-16\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-17\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">AllArgsConstructor</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2ef811463807-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Result</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-19\"><span class=\"crayon-h\">            </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">String</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2ef811463807-20\"><span class=\"crayon-h\">            </span><span class=\"crayon-m\">final</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">double</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">probability</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2ef811463807-22\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">Result </span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">knowledgeBase</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getCategories</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">keySet</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">stream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2ef811463807-24\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">map</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">c</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Result</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Calculator</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Ppost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">knowledgeBase</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getCategoryProbability</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-25\"><span class=\"crayon-h\">                        </span><span class=\"crayon-v\">model</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getConditionProbability</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">c</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">terms</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">knowledgeBase</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2ef811463807-26\"><span class=\"crayon-h\">                </span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">max</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Comparator</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">comparingDouble</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">r</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">r</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">probability</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">category</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce4a7e2ef811463807-28\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5ad3ce4a7e2ef811463807-29\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0057 seconds] -->\r\n<p>在实际测试时，我们又单独抓取了搜狗微信搜索网站上的文章，按照100篇一组，一共30组进行分类的测试，最终结果每一组的准确率均在90%以上，最高达98%，效果良好。当然正规的评测需要同时评估准确率和召回率，这里就偷懒不做了。</p>\n<p>另外还需要说明一点的是，由于训练集是来源于搜狗微信搜索网站的文章，类别仅限于这20个，这不足以覆盖所有微信公众号文章的类别，因此在测试其他来源的微信文章准确率一定会有所影响。当然如果有更加丰富的微信文章训练集的话，也可以利用这个模型重新训练，那么效果也会越来越好。</p>\n<h1>七、参考文献与引用</h1>\n<ol>\n<li>宗成庆. 统计自然语言处理[M]. 清华大学出版社, 2013.</li>\n<li>T.M.Mitchell. 机器学习[M]. 机械工业出版社, 2003.</li>\n<li>吴军. 数学之美[M]. 人民邮电出版社, 2012.</li>\n<li>Raoul-Gabriel Urma, Mario Fusco, Alan Mycroft. Java 8 实战[M]. 人民邮电出版社, 2016.</li>\n<li>Ansj中文分词器，<a href=\"https://github.com/NLPchina/ansj_seg\">https://github.com/NLPchina/a…</a></li>\n<li>HanLP中文分词器，<a href=\"https://github.com/hankcs/HanLP\">https://github.com/hankcs/HanLP</a></li>\n</ol>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113691\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113691votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113691\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/2653yy\">fullstackyang</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/2653yy\">\r\n\t\t\t<img src=\"http://tp2.sinaimg.cn/2233098320/180/0/1\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            会当凌绝顶，一览众山小——全栈之路        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/2653yy\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/2653yy/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/2653yy/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 7</a> · <a title=\"我的网站\" target=\"_blank\" href=\"http://www.fullstackyang.com\"><i class=\"fa fa-link\"></i></a> <a title=\"微博主页\" target=\"_blank\" href=\"http://weibo.com/2653yy\"><i class=\"fa fa-weibo\"></i></a>         </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/9a51fcef743ae4aca8b8c39bcc18e02a01782e9c.jpg"}{"url_object_id": "942003ecbc643f51f276927739872b18", "title": "计算机语言的巨变", "url": "http://blog.jobbole.com/113828/", "created_date": "2018/04/08", "front_image_url": ["https://dn-linuxcn.qbox.me/data/attachment/album/201804/01/123903dpmgspk0trmlpkwl.jpg"], "praise_nums": "2", "comments_nums": 0, "fav_nums": 5, "tags": "IT技术,语言", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"http://esr.ibiblio.org/?p=7724\">Eric Raymond</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-9503-1.html\">Linux中国/name1e5s</a>   </div><p>我的上一篇博文《<a href=\"http://blog.jobbole.com/113538/\">与 C 语言长别离</a>》引来了我的老朋友，一位 C++ 专家的评论。在评论里，他推荐把 C++ 作为 C 的替代品。这是不可能发生的，如果 C++ 代替 C 是趋势的话，那么 Go 和 Rust 也就不会出现了。</p>\n<p class=\"article_img\"><img class=\"aligncenter\" src=\"https://dn-linuxcn.qbox.me/data/attachment/album/201804/01/123903dpmgspk0trmlpkwl.jpg\" alt=\"\"></p>\n<p>但是我不能只给我的读者一个光秃秃的看法（LCTT 译注：此处是双关语）。所以，在这篇文章中，我来讲述一下为什么我不再碰 C++ 的故事。这是关于计算机语言设计经济学专题文章的起始点。这篇文章会讨论为什么一些真心不好的决策会被做出来，然后进入语言的基础设计之中，以及我们该如何修正这些问题。</p>\n<p>在这篇文章中，我会一点一点的指出人们（当然也包括我）自从 20 世纪 80 年代以来就存在的关于未来的编程语言的预见失误。直到最近，我们才找到了证明我们错了的证据。</p>\n<p>我记得我第一次学习 C++ 是因为我需要使用 GNU eqn 输出 MathXML，而 eqn 是使用 C++ 写的。那个项目不错。在那之后，21 世纪初，我在韦诺之战Battle For Wesnoth那边当了多年的资深开发人生，并且与 C++ 相处甚欢。</p>\n<p>在那之后啊，有一天我们发现一个不小心被我们授予提交权限的人已经把游戏的 AI 核心搞崩掉了。显然，在团队中只有我是不那么害怕查看代码的。最终，我把一切都恢复正常了 —— 我折腾了整整两周。再那之后，我就发誓我再也不靠近 C++ 了。</p>\n<p>在那次经历过后，我发现这个语言的问题就是它在尝试使得本来就复杂的东西更加复杂，来粗陋补上因为基础概念的缺失造成的漏洞。对于裸指针这样东西，它说“别这样做”，这没有问题。对于小规模的个人项目（比如我的魔改版 eqn），遵守这些规定没有问题。</p>\n<p>但是对于大型项目，或者开发者水平参差不齐的多人项目（这是我经常要处理的情况）就不能这样。随着时间的推移以及代码行数的增加，有的人就会捅篓子。当别人指出有 BUG 时，因为诸如 STL 之类的东西给你增加了一层复杂度，你处理这种问题所需要的精力就比处理同等规模的 C 语言的问题就要难上很多。我在韦诺之战时，我就知道了，处理这种问题真的相当棘手。</p>\n<p>我给 Stell Heller（我的老朋友，C++ 的支持者）写代码时不会发生的问题在我与非 Heller 们合作时就被放大了，我和他们合作的结局可能就是我得给他们擦屁股。所以我就不用 C++ ，我觉得不值得为了其花时间。 C 是有缺陷的，但是 C 有 C++ 没有的优点 —— 如果你能在脑内模拟出硬件，那么你就能很简单的看出程序是怎么运行的。如果 C++ 真的能解决 C 的问题（也就是说，C++ 是类型安全以及内存安全的），那么失去其透明性也是值得的。但是，C++ 并没有这样。</p>\n<p>我们判断 C++ 做的还不够的方法之一是想象一个 C++ 已经搞得不错的世界。在那个世界里，老旧的 C 语言项目会被迁移到 C++ 上来。主流的操作系统内核会是 C++ 写就，而现存的内核实现，比如 Linux 会渐渐升级成那样。在现实世界，这些都没有发生。C++ 不仅没有打消语言设计者设想像 D、Go 以及 Rust 那样的新语言的想法，它甚至都没有取代它的前辈。不改变 C++ 的核心思想，它就没有未来，也因此，C++ 的抽象泄露leaky abstraction也不会消失。</p>\n<p>既然我刚刚提到了 D 语言，那我就说说为什么我不把 D 视为一个够格的 C 语言竞争者的原因吧。尽管它比 Rust 早出现了八年（和 Rust 相比是九年）Walter Bright 早在那时就有了构建那样一个语言的想法。但是在 2001 年，以 Python 和 Perl 为首的语言的出现已经确定了，专有语言能和开源语言抗衡的时代已经过去。官方 D 语言库/运行时和 Tangle 的无谓纷争也打击了其发展。它从未修正这些错误。</p>\n<p>然后就是 Go 语言（我本来想说“以及 Rust”。但是如前文所述，我认为 Rust 还需要几年时间才能有竞争力）。它<em>的确是</em>类型安全以及内存安全的（好吧，是在大多数时候是这样，但是如果你要使用接口的话就不是如此了，但是自找麻烦可不是正常人的做法）。我的一位好友，Mark Atwood，曾指出过 Go 语言是脾气暴躁的老头子因为愤怒而创造出的语言，主要是 <em>C 语言的作者之一</em>（Ken Thompson） 因为 C++ 的混乱臃肿造成的愤怒，我深以为然。</p>\n<p>我能理解 Ken 恼火的原因。这几十年来我就一直认为 C++ 搞错了需要解决的问题。C 语言的后继者有两条路可走。其一就是 C++ 那样，接受 C 的抽象泄漏、裸指针等等，以保证兼容性。然后以此为基础，构建一个最先进的语言。还有一条道路，就是从根源上解决问题 —— <em>修正</em> C语言的抽象泄露。这一来就会破环其兼容性，但是也会杜绝 C/C++ 现有的问题。</p>\n<p>对于第二条道路，第一次严谨的尝试就是 1995 年出现的 Java。Java 搞得不错，但是在语言解释器上构建这门语言使其不适合系统编程。这就在系统编程那留下一个巨大的洞，在 Go 以及 Rust 出现之前的 15 年里，都没有语言来填补这个空白。这也就是我的 GPSD 和 NTPsec 等软件在 2017 年仍然主要用 C 写成的原因，尽管 C 的问题也很多。</p>\n<p>在许多方面这都是很糟糕的情况。尽管由于缺少足够多样化的选择，我们很难认识到 C/C++ 做的不够好的地方。我们都认为在软件里面出现缺陷以及基于安全方面考虑的妥协是理所当然的，而不是想想这其中多少是真的由于语言的设计问题导致的，就像缓存区溢出漏洞一样。</p>\n<p>所以，为什么我们花了这么长时间才开始解决这个问题？从 C 1972 年面世到 Go 2009 年出现，这其中隔了 37 年；Rust 也是在其仅仅一年之前出现。我想根本原因还是经济。</p>\n<p>从最早的计算机语言开始，人们就已经知道，每种语言的设计都体现了程序员时间与机器资源的相对价值的权衡。在机器这端，就是汇编语言，以及之后的 C 语言，这些语言以牺牲开发人员的时间为代价来提高性能。 另一方面，像 Lisp 和（之后的）Python 这样的语言则试图自动处理尽可能多的细节，但这是以牺牲机器性能为代价的。</p>\n<p>广义地说，这两端的语言的最重要的区别就是有没有自动内存管理。这与经验一致，内存管理缺陷是以机器为中心的语言中最常见的一类缺陷，程序员需要手动管理资源。</p>\n<p>当相对价值断言与软件开发在某个特定领域的实际成本动因相匹配时，这个语言就是在经济上可行的。语言设计者通过设计一个适合处理现在或者不远的将来出现的情况的语言，而不是使用现有的语言来解决他们遇到的问题。</p>\n<p>随着时间的推移，时兴的编程语言已经渐渐从需要手动管理内存的语言变为带有自动内存管理以及垃圾回收（GC）机制的语言。这种变化对应了摩尔定律导致的计算机硬件成本的降低，使得程序员的时间与之前相比更加的宝贵。但是，除了程序员的时间以及机器效率的变化之外，至少还有两个维度与这种变化相关。</p>\n<p>其一就是距离底层硬件的距离。底层软件（内核与服务代码）的低效率会被成倍地扩大。因此我们可以发现，以机器为中心的语言向底层推进，而以程序员为中心的语言向着高级发展。因为大多数情况下面向用户的语言仅仅需要以人类的反应速度（0.1 秒）做出回应即可。</p>\n<p>另一个维度就是项目的规模。由于程序员抽象发生的问题的漏洞以及自身的疏忽，任何语言都会有可预期的每千行代码的出错率。这个比率在以机器为中心的语言上很高，而在程序员为中心的带有 GC 的语言里就大大降低。随着项目规模的增大，带有 GC 的语言作为一个防止出错率不堪入目的策略就显得愈发重要起来。</p>\n<p>当我们使用这三种维度来看当今的编程语言的形势 —— C 语言在底层，蓬勃发展的带有 GC 的语言在上层，我们会发现这基本上很合理。但是还有一些看似不合理的是 —— C 语言的应用不合理地广泛。</p>\n<p>我为什么这么说？想想那些经典的 Unix 命令行工具吧。那些小程序通常都可以使用带有完整的 POSIX 支持的脚本语言快速实现出来。重新编码那些程序将使得它们调试、维护和拓展起来都会更加简单。</p>\n<p>但是为什么还是使用 C （或者某些像 eqn 的项目，使用 C++）？因为有转换成本。就算是把相当小、相当简单的程序使用新的语言重写并且确认你已经忠实地保留了所有非错误行为都是相当困难的。笼统地说，在任何一个领域的应用编程或者系统编程在一种语言的权衡过时之后，仍然坚持使用它。</p>\n<p>这就是我和其他预测者犯的大错。 我们认为，降低机器资源成本（增加程序员时间的相对成本）本身就足以取代 C 语言（以及没有 GC 的语言）。 在这个过程中，我们有一部分或者甚至一大部分都是错误的 —— 自 20 世纪 90 年代初以来，脚本语言、Java 以及像 Node.js 这样的东西的兴起显然都是这样兴起的。</p>\n<p>但是，竞争系统编程语言的新浪潮并非如此。 Rust 和 Go 都明确地回应了<em>增加项目规模</em> 这一需求。 脚本语言是先是作为编写小程序的有效途径，并逐渐扩大规模，而 Rust 和 Go 从一开始就定位为减少<em>大型项目</em>中的缺陷率。 比如 Google 的搜索服务和 Facebook 的实时聊天复用。</p>\n<p>我认为这就是对 “为什么不再早点儿” 这个问题的回答。Rust 和 Go 实际上并不算晚，它们相对迅速地回应了一个直到最近才被发现低估的成本动因问题。</p>\n<p>好，说了这么多理论上的问题。按照这些理论我们能预言什么？它告诉我们在 C 之后会出现什么？</p>\n<p>推动 GC 语言发展的趋势还没有扭转，也不要期待其扭转。这是大势所趋。因此：最终我们<em>将</em>拥有具有足够低延迟的 GC 技术，可用于内核和底层固件，这些技术将以语言实现方式被提供。 这些才是真正结束 C 长期统治的语言应有的特性。</p>\n<p>我们能从 Go 语言开发团队的工作文件中发现端倪，他们正朝着这个方向前进 —— 可参见关于并发 GC 的学术研究 —— 从未停止研究。 如果 Go 语言自己没有选择这么做，其他的语言设计师也会这样。 但我认为他们会这么做 —— 谷歌推动他们的项目的能力是显而易见的（我们从 “Android 的发展”就能看出来）。</p>\n<p>在我们拥有那么理想的 GC 之前，我把能替换 C 语言的赌注押在 Go 语言上。因为其 GC 的开销是可以接受的 —— 也就是说不只是应用，甚至是大部分内核外的服务都可以使用。原因很简单： C 的出错率无药可医，转化成本还很高。</p>\n<p>上周我尝试将 C 语言项目转化到 Go 语言上，我发现了两件事。其一就是这活很简单， C 的语言和 Go 对应的很好。还有就是写出的代码相当简单。由于 GC 的存在以及把集合视为首要的数据结构，人们会预期代码减少，但是我意识到我写的代码比我最初期望的减少的更多，比例约为 2:1 —— 和 C 转 Python 类似。</p>\n<p>抱歉呐，Rust 粉们。你们在内核以及底层固件上有着美好的未来，但是你们在别的 C 领域被 Go 压的很惨。没有 GC ，再加上难以从 C 语言转化过来，还有就是 API 的标准部分还是不够完善。（我的 <code>select(2)</code> 又哪去了啊？）。</p>\n<p>对你们来说，唯一的安慰就是，C++ 粉比你们更糟糕 —— 如果这算是安慰的话。至少 Rust 还可以在 Go 顾及不到的 C 领域内大展宏图。C++ 可不能。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113828\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113828votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113828\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 5 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/8441f8e55bb24a2a5052ec2c163397dfd0b0cdfb.jpg"}{"url_object_id": "fcc6df41d82a46e2ff4b2aa2b977da7e", "title": "SQL 入门", "url": "http://blog.jobbole.com/113879/", "created_date": "2018/04/14", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2016/01/970c5be7812066919173f6ec5ab052ce.png"], "praise_nums": "1", "comments_nums": 0, "fav_nums": 0, "tags": "IT技术,数据库", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://opensource.com/article/18/2/getting-started-sql\">Aaron Cocker</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-9537-1.html\">Linux中国/MjSeven</a>   </div><blockquote><p>使用 SQL 构建一个关系数据库比你想的更容易。</p></blockquote>\n<p>使用 SQL 构建数据库比大多数人想象得要简单。实际上，你甚至不需要成为一个有经验的程序员就可以使用 SQL 创建数据库。在本文中，我将解释如何使用 MySQL 5.6 来创建简单的关系型数据库管理系统（RDMS）。在开始之前，我想顺便感谢一下 <a href=\"http://sqlfiddle.com\">SQL Fiddle</a>，这是我用来运行脚本的工具。它提供了一个用于测试简单脚本的有用的沙箱。</p>\n<p>在本教程中，我将构建一个使用如下实体关系图（ERD）中显示的简单架构的数据库。数据库列出了学生和正在学习的课程。为了保持简单，我使用了两个实体（即表），只有一种关系和依赖。这两个实体称为 <code>dbo_students</code> 和 <code>dbo_courses</code>。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2018/04/1281ca5e31c38cb7a7c9a46ad9a1ce04.png\" alt=\"\"></p>\n<p>数据库的多样性是一对多的，因为每门课程可以包含很多学生，但每个学生只能学习一门课程。</p>\n<p>关于术语的快速说明：</p>\n<ol>\n<li>一张表称为一个实体。</li>\n<li>一个字段称为一个属性。</li>\n<li>一条记录称为一个元组。</li>\n<li>用于构建数据库的脚本称为架构。</li>\n</ol>\n<h3 id=\"toc_1\">构建架构</h3>\n<p>要构建数据库，使用 <code>CREATE TABLE &lt;表名&gt; </code> 命令，然后定义每个字段的名称和数据类型。数据库使用 <code>VARCHAR(n)</code> （字符串）和 <code>INT(n)</code> （整数），其中 <code>n</code> 表示可以存储的值的长度。例如 <code>INT(2)</code> 可以是 <code>01</code>。</p>\n<p>这是用于创建两个表的代码：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad406586cdc0198006902\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nCREATE TABLE dbo_students\r\n(\r\n  student_id INT(2) AUTO_INCREMENT NOT NULL,\r\n  student_name VARCHAR(50),\r\n  course_studied INT(2),\r\n  PRIMARY KEY (student_id)\r\n);\r\n\r\nCREATE TABLE dbo_courses\r\n(\r\n  course_id INT(2) AUTO_INCREMENT NOT NULL,\r\n  course_name VARCHAR(30),\r\n  PRIMARY KEY (course_id)\r\n);\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdc0198006902-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdc0198006902-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdc0198006902-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdc0198006902-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdc0198006902-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdc0198006902-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdc0198006902-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdc0198006902-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdc0198006902-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdc0198006902-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdc0198006902-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdc0198006902-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdc0198006902-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdc0198006902-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdc0198006902-15\">15</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad406586cdc0198006902-1\"><span class=\"crayon-e\">CREATE </span><span class=\"crayon-e\">TABLE </span><span class=\"crayon-e\">dbo_students</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdc0198006902-2\"><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdc0198006902-3\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">student_id </span><span class=\"crayon-t\">INT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AUTO_INCREMENT </span><span class=\"crayon-st\">NOT</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdc0198006902-4\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">student_name </span><span class=\"crayon-e\">VARCHAR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">50</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdc0198006902-5\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">course_studied </span><span class=\"crayon-t\">INT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdc0198006902-6\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">PRIMARY </span><span class=\"crayon-e\">KEY</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">student_id</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdc0198006902-7\"><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdc0198006902-8\"> </div><div class=\"crayon-line\" id=\"crayon-5ad406586cdc0198006902-9\"><span class=\"crayon-e\">CREATE </span><span class=\"crayon-e\">TABLE </span><span class=\"crayon-e\">dbo_courses</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdc0198006902-10\"><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdc0198006902-11\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">course_id </span><span class=\"crayon-t\">INT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AUTO_INCREMENT </span><span class=\"crayon-st\">NOT</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdc0198006902-12\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">course_name </span><span class=\"crayon-e\">VARCHAR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">30</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdc0198006902-13\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">PRIMARY </span><span class=\"crayon-e\">KEY</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">course_id</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdc0198006902-14\"><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdc0198006902-15\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p><code>NOT NULL</code> 意味着字段不能为空，<code>AUTO_INCREMENT</code> 意味着当一个新的元组被添加时，ID 号将自动生成，是对先前存储的 ID 号加 1，以强化各实体之间的完整参照性。 <code>PRIMARY KEY</code> 是每个表的惟一标识符属性。这意味着每个元组都有自己的不同的标识。</p>\n<h3 id=\"toc_2\">关系作为一种约束</h3>\n<p>就目前来看，这两张表格是独立存在的，没有任何联系或关系。要连接它们，必须标识一个外键。在 <code>dbo_students</code> 中，外键是 <code>course_studied</code>，其来源在 <code>dbo_courses</code> 中，意味着该字段被引用。SQL 中的特定命令为 <code>CONSTRAINT</code>，并且将使用另一个名为 <code>ALTER TABLE</code> 的命令添加这种关系，这样即使在架构构建完毕后，也可以编辑表。</p>\n<p>以下代码将关系添加到数据库构造脚本中：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad406586cdcb775993652\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nALTER TABLE dbo_students\r\nADD CONSTRAINT FK_course_studied\r\nFOREIGN KEY (course_studied) REFERENCES dbo_courses(course_id);\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdcb775993652-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdcb775993652-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdcb775993652-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdcb775993652-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad406586cdcb775993652-1\"><span class=\"crayon-e\">ALTER </span><span class=\"crayon-e\">TABLE </span><span class=\"crayon-e\">dbo_students</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdcb775993652-2\"><span class=\"crayon-e\">ADD </span><span class=\"crayon-e\">CONSTRAINT </span><span class=\"crayon-e\">FK_course_studied</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdcb775993652-3\"><span class=\"crayon-e\">FOREIGN </span><span class=\"crayon-e\">KEY</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">course_studied</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">REFERENCES </span><span class=\"crayon-e\">dbo_courses</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">course_id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdcb775993652-4\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>使用 <code>CONSTRAINT</code> 命令实际上并不是必要的，但这是一个好习惯，因为它意味着约束可以被命名并且使维护更容易。现在数据库已经完成了，是时候添加一些数据了。</p>\n<h3 id=\"toc_3\">将数据添加到数据库</h3>\n<p><code>INSERT INTO &lt;表名&gt; </code> 是用于直接选择要添加哪些属性（即字段）数据的命令。首先声明实体名称，然后声明属性，下边是添加到实体的数据，从而创建一个元组。如果指定了 <code>NOT NULL</code>，这表示该属性不能留空。以下代码将展示如何向表中添加记录：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad406586cdcf808514673\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nINSERT INTO dbo_courses(course_id,course_name)\r\nVALUES(001,'Software Engineering');\r\nINSERT INTO dbo_courses(course_id,course_name)\r\nVALUES(002,'Computer Science');\r\nINSERT INTO dbo_courses(course_id,course_name)\r\nVALUES(003,'Computing');\r\n\r\nINSERT INTO dbo_students(student_id,student_name,course_studied)\r\nVALUES(001,'student1',001);\r\nINSERT INTO dbo_students(student_id,student_name,course_studied)\r\nVALUES(002,'student2',002);\r\nINSERT INTO dbo_students(student_id,student_name,course_studied)\r\nVALUES(003,'student3',002);\r\nINSERT INTO dbo_students(student_id,student_name,course_studied)\r\nVALUES(004,'student4',003);\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdcf808514673-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdcf808514673-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdcf808514673-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdcf808514673-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdcf808514673-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdcf808514673-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdcf808514673-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdcf808514673-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdcf808514673-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdcf808514673-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdcf808514673-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdcf808514673-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdcf808514673-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdcf808514673-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdcf808514673-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdcf808514673-16\">16</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad406586cdcf808514673-1\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">dbo_courses</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">course_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">course_name</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdcf808514673-2\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">001</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">'Software Engineering'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdcf808514673-3\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">dbo_courses</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">course_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">course_name</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdcf808514673-4\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">002</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">'Computer Science'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdcf808514673-5\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">dbo_courses</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">course_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">course_name</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdcf808514673-6\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">003</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">'Computing'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdcf808514673-7\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdcf808514673-8\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">dbo_students</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">student_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">student_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">course_studied</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdcf808514673-9\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">001</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">'student1'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">001</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdcf808514673-10\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">dbo_students</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">student_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">student_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">course_studied</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdcf808514673-11\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">002</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">'student2'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">002</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdcf808514673-12\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">dbo_students</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">student_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">student_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">course_studied</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdcf808514673-13\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">003</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">'student3'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">002</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdcf808514673-14\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">dbo_students</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">student_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">student_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">course_studied</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdcf808514673-15\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">004</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">'student4'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">003</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdcf808514673-16\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0027 seconds] -->\r\n<p>现在数据库架构已经完成并添加了数据，现在是时候在数据库上运行查询了。</p>\n<h3 id=\"toc_4\">查询</h3>\n<p>查询遵循使用以下命令的集合结构：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad406586cdd3125650308\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT &lt;attributes&gt;\r\nFROM &lt;entity&gt;\r\nWHERE &lt;condition&gt;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdd3125650308-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdd3125650308-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdd3125650308-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad406586cdd3125650308-1\"><span class=\"crayon-v\">SELECT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">attributes</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdd3125650308-2\"><span class=\"crayon-v\">FROM</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">entity</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdd3125650308-3\"><span class=\"crayon-v\">WHERE</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">condition</span><span class=\"crayon-o\">&gt;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>要显示 <code>dbo_courses</code> 实体内的所有记录并显示课程代码和课程名称，请使用 <code>*</code> 。 这是一个通配符，它消除了键入所有属性名称的需要。（在生产数据库中不建议使用它。）此处查询的代码是：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad406586cdd7970836955\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSELECT *\r\nFROM dbo_courses\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdd7970836955-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdd7970836955-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdd7970836955-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad406586cdd7970836955-1\"><span class=\"crayon-e \">SELECT *</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdd7970836955-2\"><span class=\"crayon-e\">FROM </span><span class=\"crayon-v\">dbo</span><span class=\"crayon-sy\">_</span>courses</div><div class=\"crayon-line\" id=\"crayon-5ad406586cdd7970836955-3\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>此处查询的输出显示表中的所有元组，因此可显示所有可用课程：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad406586cdda507724167\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n| course_id |          course_name |\r\n|-----------|----------------------|\r\n|         1 | Software Engineering |\r\n|         2 |     Computer Science |\r\n|         3 |            Computing |\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdda507724167-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdda507724167-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdda507724167-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdda507724167-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cdda507724167-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cdda507724167-6\">6</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad406586cdda507724167-1\"><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">course_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-v\">course_name</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdda507724167-2\"><span class=\"crayon-o\">|</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdda507724167-3\"><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Software </span><span class=\"crayon-v\">Engineering</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdda507724167-4\"><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span><span class=\"crayon-e\">Computer </span><span class=\"crayon-v\">Science</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cdda507724167-5\"><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span> <span class=\"crayon-v\">Computing</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cdda507724167-6\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0018 seconds] -->\r\n<p>在后面的文章中，我将使用三种类型的连接之一来解释更复杂的查询：内连接、外连接和交叉连接。</p>\n<p>这是完整的脚本：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad406586cddd665954019\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nCREATE TABLE dbo_students\r\n(\r\n  student_id INT(2) AUTO_INCREMENT NOT NULL,\r\n  student_name VARCHAR(50),\r\n  course_studied INT(2),\r\n  PRIMARY KEY (student_id)\r\n);\r\n\r\nCREATE TABLE dbo_courses\r\n(\r\n  course_id INT(2) AUTO_INCREMENT NOT NULL,\r\n  course_name VARCHAR(30),\r\n  PRIMARY KEY (course_id)\r\n);\r\n\r\nALTER TABLE dbo_students\r\nADD CONSTRAINT FK_course_studied\r\nFOREIGN KEY (course_studied) REFERENCES dbo_courses(course_id);\r\n\r\nINSERT INTO dbo_courses(course_id,course_name)\r\nVALUES(001,'Software Engineering');\r\nINSERT INTO dbo_courses(course_id,course_name)\r\nVALUES(002,'Computer Science');\r\nINSERT INTO dbo_courses(course_id,course_name)\r\nVALUES(003,'Computing');\r\n\r\nINSERT INTO dbo_students(student_id,student_name,course_studied)\r\nVALUES(001,'student1',001);\r\nINSERT INTO dbo_students(student_id,student_name,course_studied)\r\nVALUES(002,'student2',002);\r\nINSERT INTO dbo_students(student_id,student_name,course_studied)\r\nVALUES(003,'student3',002);\r\nINSERT INTO dbo_students(student_id,student_name,course_studied)\r\nVALUES(004,'student4',003);\r\n\r\nSELECT *\r\nFROM dbo_courses\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5ad406586cddd665954019-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad406586cddd665954019-38\">38</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-1\"><span class=\"crayon-e\">CREATE </span><span class=\"crayon-e\">TABLE </span><span class=\"crayon-e\">dbo_students</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-2\"><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-3\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">student_id </span><span class=\"crayon-t\">INT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AUTO_INCREMENT </span><span class=\"crayon-st\">NOT</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-4\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">student_name </span><span class=\"crayon-e\">VARCHAR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">50</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-5\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">course_studied </span><span class=\"crayon-t\">INT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-6\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">PRIMARY </span><span class=\"crayon-e\">KEY</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">student_id</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-7\"><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-8\"> </div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-9\"><span class=\"crayon-e\">CREATE </span><span class=\"crayon-e\">TABLE </span><span class=\"crayon-e\">dbo_courses</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-10\"><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-11\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">course_id </span><span class=\"crayon-t\">INT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AUTO_INCREMENT </span><span class=\"crayon-st\">NOT</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">NULL</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-12\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">course_name </span><span class=\"crayon-e\">VARCHAR</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">30</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-13\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">PRIMARY </span><span class=\"crayon-e\">KEY</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">course_id</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-14\"><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-16\"><span class=\"crayon-e\">ALTER </span><span class=\"crayon-e\">TABLE </span><span class=\"crayon-e\">dbo_students</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-17\"><span class=\"crayon-e\">ADD </span><span class=\"crayon-e\">CONSTRAINT </span><span class=\"crayon-e\">FK_course_studied</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-18\"><span class=\"crayon-e\">FOREIGN </span><span class=\"crayon-e\">KEY</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">course_studied</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">REFERENCES </span><span class=\"crayon-e\">dbo_courses</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">course_id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-19\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-20\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">dbo_courses</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">course_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">course_name</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-21\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">001</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">'Software Engineering'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-22\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">dbo_courses</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">course_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">course_name</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-23\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">002</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">'Computer Science'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-24\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">dbo_courses</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">course_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">course_name</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-25\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">003</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">'Computing'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-26\"> </div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-27\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">dbo_students</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">student_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">student_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">course_studied</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-28\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">001</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">'student1'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">001</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-29\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">dbo_students</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">student_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">student_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">course_studied</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-30\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">002</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">'student2'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">002</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-31\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">dbo_students</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">student_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">student_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">course_studied</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-32\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">003</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">'student3'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">002</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-33\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-e\">INTO </span><span class=\"crayon-e\">dbo_students</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">student_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">student_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-v\">course_studied</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-34\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">004</span><span class=\"crayon-sy\">,</span><span class=\"crayon-s\">'student4'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-cn\">003</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-35\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-36\"><span class=\"crayon-e \">SELECT *</span></div><div class=\"crayon-line\" id=\"crayon-5ad406586cddd665954019-37\"><span class=\"crayon-e\">FROM </span><span class=\"crayon-v\">dbo</span><span class=\"crayon-sy\">_</span>courses</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad406586cddd665954019-38\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0046 seconds] -->\r\n<p></p>\n<h3 id=\"toc_5\">学习更多</h3>\n<p>SQL 并不困难；我认为它比编程简单，并且该语言对于不同的数据库系统是通用的。 请注意，实体关系图中 <code>dbo.&lt;实体&gt;</code> （LCTT 译注：文章中使用的是 <code>dbo_&lt;实体&gt;</code>）不是必需的实体命名约定；我之所以使用，仅仅是因为它是 Microsoft SQL Server 中的标准。</p>\n<p>如果你想了解更多，在网络上这方面的最佳指南是 <a href=\"https://www.w3schools.com/sql/default.asp\">W3Schools.com</a> 中对所有数据库平台的 SQL 综合指南。</p>\n<p>请随意使用我的数据库。另外，如果你有任何建议或疑问，请在评论中回复。</p>\n<p> </p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113879\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113879votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113879\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/0e89c4879b2842f9c58098e98ad64d0a9d218103.jpg"}{"url_object_id": "3ddc63f75c52601a85de2d939777f079", "title": "给初学者的 type 命令教程", "url": "http://blog.jobbole.com/113817/", "created_date": "2018/04/06", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2018/01/1b8322e1daff605d71fc81e724421f17.jpg"], "praise_nums": "1", "comments_nums": 1, "fav_nums": 1, "tags": "IT技术,Linux", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://www.ostechnix.com/the-type-command-tutorial-with-examples-for-beginners/\">SK</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-9519-1.html\">Linux中国/geekpi</a>   </div><p><code>type</code> 命令用于查找 Linux 命令的信息。顾名思义，你可以使用 <code>type</code> 命令轻松找出给定的命令是否是别名、shell 内置命令、文件、函数或关键字。另外，你也可以找到命令的实际路径。为什么有人需要找到命令类型？例如，如果你经常在共享的计算机上工作，则某些人可能会故意或意外地为特定的 Linux 命令创建别名来执行不需要的操作，例如 <code>alias ls = rm -rf /</code>。因此，在发生更糟糕的事情之前检查它们总是一个好主意。这是 <code>type</code> 命令有用的地方。</p>\n<p>让我给你看一些例子。</p>\n<p>不带任何选项运行 <code>type</code> 命令。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3e166c9aad692184920\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ type ls\r\nls is aliased to `ls --color=auto'</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3e166c9aad692184920-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e166c9aad692184920-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3e166c9aad692184920-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">type </span><span class=\"crayon-e\">ls</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e166c9aad692184920-2\"><span class=\"crayon-e\">ls </span><span class=\"crayon-st\">is</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">aliased </span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">ls</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">color</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">auto</span>'</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>正如你在上面的输出中看到的那样，<code>ls</code> 命令已被别名为 <code>ls -color-auto</code>。但是，它是无害的。但只要想想 <code>ls</code> 如果被别名为了其他一些危险的命令。你不想那样，是吗？</p>\n<p>你可以使用 <code>-t</code> 选项仅找出 Linux 命令的类型。例如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3e166c9ab6377537434\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ type -t ls\r\nalias\r\n$ type -t mkdir\r\nfile\r\n$ type -t pwd\r\nbuiltin\r\n$ type -t if\r\nkeyword\r\n$ type -t rvm\r\nfunction</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3e166c9ab6377537434-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e166c9ab6377537434-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e166c9ab6377537434-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e166c9ab6377537434-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e166c9ab6377537434-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e166c9ab6377537434-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e166c9ab6377537434-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e166c9ab6377537434-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e166c9ab6377537434-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e166c9ab6377537434-10\">10</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3e166c9ab6377537434-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ls</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e166c9ab6377537434-2\"><span class=\"crayon-i\">alias</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e166c9ab6377537434-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">mkdir</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e166c9ab6377537434-4\"><span class=\"crayon-i\">file</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e166c9ab6377537434-5\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">pwd</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e166c9ab6377537434-6\"><span class=\"crayon-i\">builtin</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e166c9ab6377537434-7\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e166c9ab6377537434-8\"><span class=\"crayon-i\">keyword</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e166c9ab6377537434-9\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">rvm</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e166c9ab6377537434-10\"><span class=\"crayon-t\">function</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n<p>该命令仅显示命令的类型，例如别名。它不显示被别名的内容。如果该命令找不到，你将在终端中看不到任何内容。</p>\n<p><code>type</code> 命令的另一个有用的地方是我们可以很容易地找出给定 Linux 命令的绝对路径。为此，请使用 <code>-p</code> 选项，如下所示。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3e166c9aba948256137\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ type -p cal\r\n/usr/bin/cal</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3e166c9aba948256137-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e166c9aba948256137-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3e166c9aba948256137-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cal</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e166c9aba948256137-2\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">cal</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>这与 <code>which ls</code> 命令类似。如果给定的命令是别名，则不会打印任何内容。</p>\n<p>要显示命令的所有信息，请使用 <code>-a</code> 选项。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3e166c9abe685189585\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ type -a ls\r\nls is aliased to `ls --color=auto'\r\nls is /usr/bin/ls\r\nls is /bin/ls</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3e166c9abe685189585-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e166c9abe685189585-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e166c9abe685189585-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e166c9abe685189585-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3e166c9abe685189585-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ls</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e166c9abe685189585-2\"><span class=\"crayon-e\">ls </span><span class=\"crayon-st\">is</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">aliased </span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">ls</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">color</span><span class=\"crayon-o\">=</span><span class=\"crayon-i\">auto</span>'</div><div class=\"crayon-line\" id=\"crayon-5ad3e166c9abe685189585-3\"><span class=\"crayon-e\">ls </span><span class=\"crayon-st\">is</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">ls</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e166c9abe685189585-4\"><span class=\"crayon-e\">ls </span><span class=\"crayon-st\">is</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ls</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>如你所见，<code>-a</code> 标志显示给定命令的类型及其绝对路径。有关更多详细信息，请参阅手册页。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3e166c9ac1598133345\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n$ man type</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3e166c9ac1598133345-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3e166c9ac1598133345-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">man </span><span class=\"crayon-v\">type</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n<p>希望这有帮助。会有更多的好东西。请继续访问！</p>\n<p>干杯!</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113817\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113817votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113817\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 1 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/14452eea6b79bce0219227f298ad827f2ba7112d.jpg"}{"url_object_id": "a8bea411b8efb78652e2e1348eb0a11a", "title": "从 Linux 源码看 socket 的阻塞和非阻塞", "url": "http://blog.jobbole.com/113858/", "created_date": "2018/04/12", "front_image_url": ["http://wx2.sinaimg.cn/mw690/63918611gy1fq9n10wguaj20vi0katb1.jpg"], "praise_nums": "1", "comments_nums": 0, "fav_nums": 3, "tags": "IT技术,socket,阻塞,非阻塞", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"https://my.oschina.net/alchemystar/blog/1791017\">无毁的湖光-Al</a>   </div><p>笔者一直觉得如果能知道从应用到框架再到操作系统的每一处代码，是一件Exciting的事情。</p>\n<p>大部分高性能网络框架采用的是非阻塞模式。笔者这次就从linux源码的角度来阐述socket阻塞(block)和非阻塞(non_block)的区别。 本文源码均来自采用Linux-2.6.24内核版本。</p>\n<h2 id=\"h2_1\">一个TCP非阻塞client端简单的例子</h2>\n<p>如果我们要产生一个非阻塞的socket,在C语言中如下代码所示:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5f9f226336089\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div><span class=\"crayon-language\">C</span></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n// 创建socket\r\nint sock_fd = socket(AF_INET, SOCK_STREAM, 0);\r\n...\r\n// 更改socket为nonblock\r\nfcntl(sock_fd, F_SETFL, fdflags | O_NONBLOCK);\r\n// connect\r\n....\r\nwhile(1)  {  \r\n    int recvlen = recv(sock_fd, recvbuf, RECV_BUF_SIZE) ; \r\n    ......\r\n} \r\n...</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5f9f226336089-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5f9f226336089-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5f9f226336089-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5f9f226336089-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5f9f226336089-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5f9f226336089-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5f9f226336089-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5f9f226336089-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5f9f226336089-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5f9f226336089-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5f9f226336089-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5f9f226336089-12\">12</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5f9f226336089-1\"><span class=\"crayon-c\">// 创建socket</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5f9f226336089-2\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sock_fd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">socket</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">AF_INET</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SOCK_STREAM</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5f9f226336089-3\"><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5f9f226336089-4\"><span class=\"crayon-c\">// 更改socket为nonblock</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5f9f226336089-5\"><span class=\"crayon-e\">fcntl</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sock_fd</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">F_SETFL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fdflags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">O_NONBLOCK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5f9f226336089-6\"><span class=\"crayon-c\">// connect</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5f9f226336089-7\"><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5f9f226336089-8\"><span class=\"crayon-st\">while</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\">  </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\">  </span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5f9f226336089-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">recvlen</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">recv</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sock_fd</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">recvbuf</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RECV_BUF_SIZE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5f9f226336089-10\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5f9f226336089-11\"><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5f9f226336089-12\"><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0019 seconds] -->\r\n<p>由于网络协议非常复杂，内核里面用到了大量的面向对象的技巧，所以我们从创建连接开始，一步一步追述到最后代码的调用点。</p>\n<h3 id=\"h3_2\">socket的创建</h3>\n<p>很明显，内核的第一步应该是通过AF_INET、SOCK_STREAM以及最后一个参数0定位到需要创建一个TCP的socket,如下图绿线所示:</p>\n<p><img src=\"http://wx2.sinaimg.cn/mw690/63918611gy1fq9n10wguaj20vi0katb1.jpg\"></p>\n<p>我们跟踪源码调用</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5faa419720601\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsocket(AF_INET, SOCK_STREAM, 0)\r\n\t|-&gt;sys_socket 进入系统调用\r\n\t\t|-&gt;sock_create\r\n\t\t\t|-&gt;__sock_create</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5faa419720601-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5faa419720601-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5faa419720601-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5faa419720601-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5faa419720601-1\"><span class=\"crayon-e\">socket</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">AF_INET</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SOCK_STREAM</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5faa419720601-2\"><span class=\"crayon-h\">\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sys</span><span class=\"crayon-sy\">_</span>socket<span class=\"crayon-h\"> </span>进入系统调用</div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5faa419720601-3\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sock_create</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5faa419720601-4\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">__sock_create</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0562 seconds] -->\r\n<p>进一步分析__sock_create的代码判断:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fae573474007\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div><span class=\"crayon-language\">C</span></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nconst struct net_proto_family *pf;\r\n// RCU(Read-Copy Update)是linux的一种内核同步方法，在此不阐述\r\n// family=INET\r\npf = rcu_dereference(net_families[family]);\r\nerr = pf-&gt;create(net, sock, protocol);</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fae573474007-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fae573474007-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fae573474007-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fae573474007-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fae573474007-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fae573474007-1\"><span class=\"crayon-r\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">net_proto_family</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">pf</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fae573474007-2\"><span class=\"crayon-c\">// RCU(Read-Copy Update)是linux的一种内核同步方法，在此不阐述</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fae573474007-3\"><span class=\"crayon-c\">// family=INET</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fae573474007-4\"><span class=\"crayon-v\">pf</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">rcu_dereference</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">net_families</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">family</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fae573474007-5\"><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">pf</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">create</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">net</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sock</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">protocol</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0307 seconds] -->\r\n<p><span class=\"hljs-keyword\">const</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span></span></span> <span class=\"hljs-title\"><span class=\"hljs-class\"><span class=\"hljs-title\">net_proto_family</span></span></span></span> *pf; <span class=\"hljs-comment\"><span class=\"hljs-comment\">// RCU(Read-Copy Update)是linux的一种内核同步方法，在此不阐述</span></span> <span class=\"hljs-comment\"><span class=\"hljs-comment\">// family=INET</span></span> pf = rcu_dereference(net_families[family]); err = pf-&gt;create(net, sock, protocol);</p>\n<p><img src=\"http://wx3.sinaimg.cn/mw690/63918611gy1fq9n11nhljj20ui0eadi7.jpg\"></p>\n<p>则通过源码可知，由于是AF_INET(PF_INET),所以net_families[PF_INET].create=inet_create(以后我们都用PF_INET表示)，即<br>\npf-&gt;create = inet_create; 进一步追溯调用:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fb3702833669\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div><span class=\"crayon-language\">C</span></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ninet_create(struct net *net, struct socket *sock, int protocol){\r\n\tSock* sock;\r\n\t......\r\n\t// 此处是寻找对应协议处理器的过程\r\nlookup_protocol:\r\n\t// 迭代寻找protocol==answer-&gt;protocol的情况\r\n\tlist_for_each_rcu(p, &amp;inetsw[sock-&gt;type]) answer = list_entry(p, struct inet_protosw, list);\r\n\r\n\t\t/* Check the non-wild match. */\r\n\t\tif (protocol == answer-&gt;protocol) {\r\n\t\t\tif (protocol != IPPROTO_IP)\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t......\r\n\t// 这边answer指的是SOCK_STREAM\r\n\tsock-&gt;ops = answer-&gt;ops;\r\n\tanswer_no_check = answer-&gt;no_check;\r\n\t// 这边sk-&gt;prot就是answer_prot=&gt;tcp_prot\r\n\tsk = sk_alloc(net, PF_INET, GFP_KERNEL, answer_prot);\r\n\tsock_init_data(sock, sk);\r\n\t......\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb3702833669-22\">22</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb3702833669-1\"><span class=\"crayon-e\">inet_create</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">net</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">net</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">socket</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">sock</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">protocol</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb3702833669-2\"><span class=\"crayon-h\">\t</span><span class=\"crayon-v\">Sock</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sock</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb3702833669-3\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb3702833669-4\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// 此处是寻找对应协议处理器的过程</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb3702833669-5\"><span class=\"crayon-v\">lookup_protocol</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb3702833669-6\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// 迭代寻找protocol==answer-&gt;protocol的情况</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb3702833669-7\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">list_for_each_rcu</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">inetsw</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">sock</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">type</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">list_entry</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">p</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">inet_protosw</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">list</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb3702833669-8\"> </div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb3702833669-9\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-c\">/* Check the non-wild match. */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb3702833669-10\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">protocol</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">protocol</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb3702833669-11\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">protocol</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">IPPROTO_IP</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb3702833669-12\"><span class=\"crayon-h\">\t\t\t\t</span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb3702833669-13\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb3702833669-14\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb3702833669-15\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// 这边answer指的是SOCK_STREAM</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb3702833669-16\"><span class=\"crayon-h\">\t</span><span class=\"crayon-v\">sock</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ops</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ops</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb3702833669-17\"><span class=\"crayon-h\">\t</span><span class=\"crayon-v\">answer_no_check</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">no_check</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb3702833669-18\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// 这边sk-&gt;prot就是answer_prot=&gt;tcp_prot</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb3702833669-19\"><span class=\"crayon-h\">\t</span><span class=\"crayon-v\">sk</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_alloc</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">net</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PF_INET</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">GFP_KERNEL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer_prot</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb3702833669-20\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">sock_init_data</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sock</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb3702833669-21\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb3702833669-22\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0374 seconds] -->\r\n<p>上面的代码就是在INET中寻找SOCK_STREAM的过程了 我们再看一下inetsw[SOCK_STREAM]的具体配置:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fb6978013533\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div><span class=\"crayon-language\">C</span></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic struct inet_protosw inetsw_array[] =\r\n{\r\n\t{\r\n\t\t.type =       SOCK_STREAM,\r\n\t\t.protocol =   IPPROTO_TCP,\r\n\t\t.prot =       &amp;tcp_prot,\r\n\t\t.ops =        &amp;inet_stream_ops,\r\n\t\t.capability = -1,\r\n\t\t.no_check =   0,\r\n\t\t.flags =      INET_PROTOSW_PERMANENT |\r\n\t\t\t      INET_PROTOSW_ICSK,\r\n\t},\r\n\t......\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb6978013533-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb6978013533-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb6978013533-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb6978013533-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb6978013533-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb6978013533-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb6978013533-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb6978013533-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb6978013533-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb6978013533-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb6978013533-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb6978013533-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fb6978013533-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fb6978013533-14\">14</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb6978013533-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">inet_protosw </span><span class=\"crayon-v\">inetsw_array</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb6978013533-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb6978013533-3\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb6978013533-4\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\">       </span><span class=\"crayon-v\">SOCK_STREAM</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb6978013533-5\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">protocol</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\">   </span><span class=\"crayon-v\">IPPROTO_TCP</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb6978013533-6\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">prot</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\">       </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">tcp_prot</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb6978013533-7\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ops</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">inet_stream_ops</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb6978013533-8\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">capability</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb6978013533-9\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">no_check</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb6978013533-10\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\">      </span><span class=\"crayon-v\">INET_PROTOSW_PERMANENT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb6978013533-11\"><span class=\"crayon-h\">\t\t\t      </span><span class=\"crayon-v\">INET_PROTOSW_ICSK</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb6978013533-12\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fb6978013533-13\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fb6978013533-14\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0313 seconds] -->\r\n<p>这边也用了重载，AF_INET有TCP、UDP以及Raw三种:</p>\n<p><img src=\"http://wx1.sinaimg.cn/mw690/63918611gy1fq9n12m0pcj20wg0eetbd.jpg\"></p>\n<p>从上述代码，我们可以清楚的发现sock-&gt;ops=&amp;inet_stream_ops;</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fba897492803\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div><span class=\"crayon-language\">C</span></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nconst struct proto_ops inet_stream_ops = {\r\n\t.family\t\t   = PF_INET,\r\n\t.owner\t\t   = THIS_MODULE,\r\n\t......\r\n\t.sendmsg\t   = tcp_sendmsg,\r\n\t.recvmsg\t   = sock_common_recvmsg,\r\n\t......\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fba897492803-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fba897492803-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fba897492803-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fba897492803-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fba897492803-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fba897492803-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fba897492803-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fba897492803-8\">8</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fba897492803-1\"><span class=\"crayon-r\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">proto_ops </span><span class=\"crayon-v\">inet_stream_ops</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fba897492803-2\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">family</span><span class=\"crayon-h\">\t\t   </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PF_INET</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fba897492803-3\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">owner</span><span class=\"crayon-h\">\t\t   </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">THIS_MODULE</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fba897492803-4\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fba897492803-5\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">sendmsg</span><span class=\"crayon-h\">\t   </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tcp_sendmsg</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fba897492803-6\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">recvmsg</span><span class=\"crayon-h\">\t   </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sock_common_recvmsg</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fba897492803-7\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fba897492803-8\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0015 seconds] -->\r\n<p>即sock-&gt;ops-&gt;recvmsg = sock_common_recvmsg;<br>\n同时sock-&gt;sk-&gt;sk_prot = tcp_prot;</p>\n<p>我们再看下tcp_prot中的各个函数重载的定义:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fbd184351741\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div><span class=\"crayon-language\">C</span></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstruct proto tcp_prot = {\r\n\t.name\t\t\t= \"TCP\",\r\n\t.close\t\t\t= tcp_close,\r\n\t.connect\t\t= tcp_v4_connect,\r\n\t.disconnect\t\t= tcp_disconnect,\r\n\t.accept\t\t\t= inet_csk_accept,\r\n\t......\r\n\t// 我们重点考察tcp的读\r\n\t.recvmsg\t\t= tcp_recvmsg,\r\n\t......\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fbd184351741-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fbd184351741-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fbd184351741-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fbd184351741-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fbd184351741-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fbd184351741-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fbd184351741-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fbd184351741-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fbd184351741-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fbd184351741-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fbd184351741-11\">11</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fbd184351741-1\"><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">proto </span><span class=\"crayon-v\">tcp_prot</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fbd184351741-2\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">name</span><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"TCP\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fbd184351741-3\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">close</span><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tcp_close</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fbd184351741-4\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">connect</span><span class=\"crayon-h\">\t\t</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tcp_v4_connect</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fbd184351741-5\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">disconnect</span><span class=\"crayon-h\">\t\t</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tcp_disconnect</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fbd184351741-6\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">accept</span><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">inet_csk_accept</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fbd184351741-7\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fbd184351741-8\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// 我们重点考察tcp的读</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fbd184351741-9\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">recvmsg</span><span class=\"crayon-h\">\t\t</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tcp_recvmsg</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fbd184351741-10\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fbd184351741-11\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0020 seconds] -->\r\n<p></p>\n<h2 id=\"h2_3\">fcntl控制socket的阻塞\\非阻塞状态</h2>\n<p>我们用fcntl修改socket的阻塞\\非阻塞状态。 事实上: fcntl的作用就是将O_NONBLOCK标志位存储在sock_fd对应的filp结构的f_lags里,如下图所示。</p>\n<p><img src=\"http://wx1.sinaimg.cn/mw690/63918611gy1fq9n13is3fj20ws0j4go5.jpg\"></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fc1935755692\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nfcntl(sock_fd, F_SETFL, fdflags | O_NONBLOCK);\r\n\t|-&gt;setfl</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fc1935755692-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fc1935755692-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fc1935755692-1\"><span class=\"crayon-e\">fcntl</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sock_fd</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">F_SETFL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fdflags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">O_NONBLOCK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fc1935755692-2\"><span class=\"crayon-h\">\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">setfl</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>追踪setfl代码:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fc4924470526\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div><span class=\"crayon-language\">C</span></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic int setfl(int fd, struct file * filp, unsigned long arg) {\r\n\t......\r\n\tfilp-&gt;f_flags = (arg &amp; SETFL_MASK) | (filp-&gt;f_flags &amp; ~SETFL_MASK);\r\n\t......\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fc4924470526-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fc4924470526-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fc4924470526-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fc4924470526-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fc4924470526-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fc4924470526-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">setfl</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fd</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">file</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">filp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">arg</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fc4924470526-2\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fc4924470526-3\"><span class=\"crayon-h\">\t</span><span class=\"crayon-v\">filp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">f_flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">arg</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SETFL_MASK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">filp</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">f_flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-v\">SETFL_MASK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fc4924470526-4\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fc4924470526-5\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p>上图中，由sock_fd在task_struct(进程结构体)-&gt;files_struct-&gt;fd_array中找到对应的socket的file描述符，再修改file-&gt;flags</p>\n<h2 id=\"h2_4\">在调用socket.recv的时候</h2>\n<p>我们跟踪源码调用:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fc7231214439\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsocket.recv\r\n\t|-&gt;sys_recv\r\n\t\t|-&gt;sys_recvfrom\r\n\t\t\t|-&gt;sock_recvmsg\r\n\t\t\t\t|-&gt;__sock_recvmsg\r\n\t\t\t\t\t|-&gt;sock-&gt;ops-&gt;recvmsg</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fc7231214439-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fc7231214439-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fc7231214439-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fc7231214439-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fc7231214439-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fc7231214439-6\">6</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fc7231214439-1\"><span class=\"crayon-v\">socket</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">recv</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fc7231214439-2\"><span class=\"crayon-h\">\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sys_recv</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fc7231214439-3\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sys_recvfrom</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fc7231214439-4\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sock_recvmsg</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fc7231214439-5\"><span class=\"crayon-h\">\t\t\t\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">__sock_recvmsg</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fc7231214439-6\"><span class=\"crayon-h\">\t\t\t\t\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sock</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ops</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">recvmsg</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>由上文可知: sock-&gt;ops-&gt;recvmsg = sock_common_recvmsg;</p>\n<h3 id=\"h3_5\">sock</h3>\n<p>值得注意的是,在sock_recmsg中,有对标识O_NONBLOCK的处理</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fcb179855213\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n\tif (sock-&gt;file-&gt;f_flags &amp; O_NONBLOCK)\r\n\t\tflags |= MSG_DONTWAIT;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fcb179855213-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fcb179855213-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fcb179855213-1\"><span class=\"crayon-h\">\t</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sock</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">file</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">f_flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">O_NONBLOCK</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fcb179855213-2\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MSG_DONTWAIT</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>上述代码中sock关联的file中获取其f_flags,如果flags有O_NONBLOCK标识，那么就设置msg_flags为MSG_DONTWAIT(不等待)。<br>\nfcntl与socket就是通过其共同操作File结构关联起来的。</p>\n<h3 id=\"h3_6\">继续跟踪调用</h3>\n<p>sock_common_recvmsg</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fce017112123\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nint sock_common_recvmsg(struct kiocb *iocb, struct socket *sock,\r\n\t\t\tstruct msghdr *msg, size_t size, int flags) {\r\n\t......\r\n\t// 如果flags的MSG_DONTWAIT标识置位，则传给recvmsg的第5个参数为正,否则为0\r\n\terr = sk-&gt;sk_prot-&gt;recvmsg(iocb, sk, msg, size, flags &amp; MSG_DONTWAIT,\r\n\t\t\t\t   flags &amp; ~MSG_DONTWAIT, &amp;addr_len);\r\n\t.....\t\t\t\t   \r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fce017112123-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fce017112123-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fce017112123-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fce017112123-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fce017112123-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fce017112123-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fce017112123-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fce017112123-8\">8</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fce017112123-1\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sock_common_recvmsg</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">kiocb *</span><span class=\"crayon-v\">iocb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">socket *</span><span class=\"crayon-v\">sock</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fce017112123-2\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">msghdr *</span><span class=\"crayon-v\">msg</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">size_t </span><span class=\"crayon-v\">size</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fce017112123-3\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fce017112123-4\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// 如果flags的MSG_DONTWAIT标识置位，则传给recvmsg的第5个参数为正,否则为0</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fce017112123-5\"><span class=\"crayon-h\">\t</span><span class=\"crayon-v\">err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_prot</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">recvmsg</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">iocb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">msg</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">size</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MSG_DONTWAIT</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fce017112123-6\"><span class=\"crayon-h\">\t\t\t\t   </span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">~</span><span class=\"crayon-v\">MSG_DONTWAIT</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">addr_len</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fce017112123-7\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\">\t\t\t\t   </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fce017112123-8\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0021 seconds] -->\r\n<p>由上文可知: sk-&gt;sk_prot-&gt;recvmsg 其中sk_prot=tcp_prot,即最终调用的是tcp_prot-&gt;tcp_recvmsg,<br>\n上面的代码可以看出，如果fcntl(O_NONBLOCK)=&gt;MSG_DONTWAIT置位=&gt;(flags &amp; MSG_DONTWAIT)&gt;0, 再结合tcp_recvmsg的函数签名,即如果设置了O_NONBLOCK的话，设置给tcp_recvmsg的nonblock参数&gt;0,关系如下图所示:</p>\n<p><img src=\"http://wx3.sinaimg.cn/mw690/63918611gy1fq9n14e3v5j212g09wdh9.jpg\"></p>\n<h3 id=\"h3_7\">最终的调用逻辑tcp_recvmsg</h3>\n<p>首先我们看下tcp_recvmsg的函数签名:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fd2231901650\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div><span class=\"crayon-language\">C</span></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nint tcp_recvmsg(struct kiocb *iocb, struct sock *sk, struct msghdr *msg,\r\n\t\tsize_t len, int nonblock, int flags, int *addr_len)</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd2231901650-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd2231901650-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd2231901650-1\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_recvmsg</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">kiocb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">iocb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sock</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">msghdr</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">msg</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd2231901650-2\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-e\">size_t </span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nonblock</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">addr_len</span><span class=\"crayon-sy\">)</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0371 seconds] -->\r\n<p>显然我们关注焦点在(int nonblock这个参数上):</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fd6701481636\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div><span class=\"crayon-language\">C</span></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nint tcp_recvmsg(struct kiocb *iocb, struct sock *sk, struct msghdr *msg,\r\n\t\tsize_t len, int nonblock, int flags, int *addr_len){\r\n\t......\t\r\n\t// copied是指向用户空间拷贝了多少字节，即读了多少\r\n\tint copied;\r\n\t// target指的是期望多少字节\r\n\tint target;\r\n\t// 等效为timo = noblock ? 0 : sk-&gt;sk_rcvtimeo;\r\n\ttimeo = sock_rcvtimeo(sk, nonblock);\r\n\t......\t\r\n\t// 如果设置了MSG_WAITALL标识target=需要读的长度\r\n\t// 如果未设置，则为最低低水位值\r\n\ttarget = sock_rcvlowat(sk, flags &amp; MSG_WAITALL, len);\r\n\t......\r\n\r\n\tdo{\r\n\t\t// 表明读到数据\r\n\t\tif (copied) {\r\n\t\t\t// 注意，这边只要!timeo，即nonblock设置了就会跳出循环\r\n\t\t\tif (sk-&gt;sk_err ||\r\n\t\t\t    sk-&gt;sk_state == TCP_CLOSE ||\r\n\t\t\t    (sk-&gt;sk_shutdown &amp; RCV_SHUTDOWN) ||\r\n\t\t\t    !timeo ||\r\n\t\t\t    signal_pending(current) ||\r\n\t\t\t    (flags &amp; MSG_PEEK))\r\n\t\t\tbreak;\r\n\t\t}else{\r\n\t\t\t// 到这里，表明没有读到任何数据\r\n\t\t\t// 且nonblock设置了导致timeo=0，则返回-EAGAIN,符合我们的预期\r\n\t\t\tif (!timeo) {\r\n\t\t\t\tcopied = -EAGAIN;\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\t// 这边如果堵到了期望的数据，继续，否则当前进程阻塞在sk_wait_data上\r\n\t\tif (copied &gt;= target) {\r\n\t\t\t/* Do not sleep, just process backlog. */\r\n\t\t\trelease_sock(sk);\r\n\t\t\tlock_sock(sk);\r\n\t\t} else\r\n\t\t\tsk_wait_data(sk, &amp;timeo);\r\n\t} while (len &gt; 0);\t\t\r\n\t......\r\n\treturn copied\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fd6701481636-44\">44</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-1\"><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">tcp_recvmsg</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">kiocb</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">iocb</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sock</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">msghdr</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">msg</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-2\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-e\">size_t </span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nonblock</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">addr_len</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-3\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\">\t</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-4\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// copied是指向用户空间拷贝了多少字节，即读了多少</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-5\"><span class=\"crayon-h\">\t</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-6\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// target指的是期望多少字节</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-7\"><span class=\"crayon-h\">\t</span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">target</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-8\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// 等效为timo = noblock ? 0 : sk-&gt;sk_rcvtimeo;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-9\"><span class=\"crayon-h\">\t</span><span class=\"crayon-v\">timeo</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sock_rcvtimeo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nonblock</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-10\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\">\t</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-11\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// 如果设置了MSG_WAITALL标识target=需要读的长度</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-12\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// 如果未设置，则为最低低水位值</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-13\"><span class=\"crayon-h\">\t</span><span class=\"crayon-v\">target</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sock_rcvlowat</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MSG_WAITALL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">len</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-14\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-16\"><span class=\"crayon-h\">\t</span><span class=\"crayon-st\">do</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-17\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-c\">// 表明读到数据</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-18\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copied</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-19\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-c\">// 注意，这边只要!timeo，即nonblock设置了就会跳出循环</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-20\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_err</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-21\"><span class=\"crayon-h\">\t\t\t    </span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_state</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TCP_CLOSE</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-22\"><span class=\"crayon-h\">\t\t\t    </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_shutdown</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RCV_SHUTDOWN</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-23\"><span class=\"crayon-h\">\t\t\t    </span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">timeo</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-24\"><span class=\"crayon-h\">\t\t\t    </span><span class=\"crayon-e\">signal_pending</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">current</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-25\"><span class=\"crayon-h\">\t\t\t    </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">flags</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MSG_PEEK</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-26\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-27\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-sy\">}</span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-28\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-c\">// 到这里，表明没有读到任何数据</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-29\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-c\">// 且nonblock设置了导致timeo=0，则返回-EAGAIN,符合我们的预期</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-30\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">timeo</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-31\"><span class=\"crayon-h\">\t\t\t\t</span><span class=\"crayon-v\">copied</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">EAGAIN</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-32\"><span class=\"crayon-h\">\t\t\t\t</span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-33\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-34\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-c\">// 这边如果堵到了期望的数据，继续，否则当前进程阻塞在sk_wait_data上</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-35\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">copied</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">target</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-36\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-c\">/* Do not sleep, just process backlog. */</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-37\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-e\">release_sock</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-38\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-e\">lock_sock</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-39\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-40\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-e\">sk_wait_data</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">timeo</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-41\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">len</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">\t\t</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-42\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fd6701481636-43\"><span class=\"crayon-h\">\t</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">copied</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fd6701481636-44\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0359 seconds] -->\r\n<p>上面的逻辑归结起来就是：<br>\n(1)在设置了nonblock的时候，如果copied&gt;0,则返回读了多少字节,如果copied=0，则返回-EAGAIN,提示应用重复调用。<br>\n(2)如果没有设置nonblock，如果读取的数据&gt;=期望，则返回读取了多少字节。如果没有则用sk_wait_data将当前进程等待。<br>\n如下流程图所示:</p>\n<p><img src=\"http://wx1.sinaimg.cn/mw690/63918611gy1fq9n15gvtaj20z60k8acz.jpg\"></p>\n<h3 id=\"h3_8\">阻塞函数sk_wait_data</h3>\n<p>sk_wait_data代码-函数为:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fda571541709\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div><span class=\"crayon-language\">C</span></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n\t// 将进程状态设置为可打断INTERRUPTIBLE\r\n\tprepare_to_wait(sk-&gt;sk_sleep, &amp;wait, TASK_INTERRUPTIBLE);\r\n\tset_bit(SOCK_ASYNC_WAITDATA, &amp;sk-&gt;sk_socket-&gt;flags);\r\n\t// 通过调用schedule_timeout让出CPU，然后进行睡眠\r\n\trc = sk_wait_event(sk, timeo, !skb_queue_empty(&amp;sk-&gt;sk_receive_queue));\r\n\t// 到这里的时候，有网络事件或超时事件唤醒了此进程，继续运行\r\n\tclear_bit(SOCK_ASYNC_WAITDATA, &amp;sk-&gt;sk_socket-&gt;flags);\r\n\tfinish_wait(sk-&gt;sk_sleep, &amp;wait);</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fda571541709-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fda571541709-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fda571541709-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fda571541709-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fda571541709-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fda571541709-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fda571541709-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fda571541709-8\">8</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fda571541709-1\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// 将进程状态设置为可打断INTERRUPTIBLE</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fda571541709-2\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">prepare_to_wait</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_sleep</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">wait</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TASK_INTERRUPTIBLE</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fda571541709-3\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">set_bit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">SOCK_ASYNC_WAITDATA</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_socket</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fda571541709-4\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// 通过调用schedule_timeout让出CPU，然后进行睡眠</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fda571541709-5\"><span class=\"crayon-h\">\t</span><span class=\"crayon-v\">rc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sk_wait_event</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">timeo</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">skb_queue_empty</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_receive_queue</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fda571541709-6\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// 到这里的时候，有网络事件或超时事件唤醒了此进程，继续运行</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fda571541709-7\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">clear_bit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">SOCK_ASYNC_WAITDATA</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_socket</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">flags</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fda571541709-8\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">finish_wait</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_sleep</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">wait</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0162 seconds] -->\r\n<p>该函数调用schedule_timeout进入睡眠，其进一步调用了schedule函数，首先从运行队列删除，其次加入到等待队列，最后调用和体系结构相关的switch_to宏来完成进程间的切换。<br>\n如下图所示:</p>\n<p><img src=\"http://wx3.sinaimg.cn/mw690/63918611gy1fq9n16qg5xj21540rw43a.jpg\"></p>\n<h3 id=\"h3_9\">阻塞后什么时候恢复运行呢</h3>\n<h4 id=\"h4_10\">情况1:有对应的网络数据到来</h4>\n<p>首先我们看下网络分组到来的内核路径，网卡发起中断后调用netif_rx将事件挂入CPU的等待队列，并唤起软中断(soft_irq)，再通过linux的软中断机制调用net_rx_action，如下图所示:</p>\n<p><img src=\"http://wx4.sinaimg.cn/mw690/63918611gy1fq9n17pdxbj213s0oc0vh.jpg\"></p>\n<p>注:上图来自PLKA(&lt;&lt;深入Linux内核架构&gt;&gt;)<br>\n紧接着跟踪next_rx_action</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fde030572796\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nnext_rx_action\r\n\t|-process_backlog\r\n\t\t......\r\n\t\t\t|-&gt;packet_type-&gt;func 在这里我们考虑ip_rcv\r\n\t\t\t\t\t|-&gt;ipprot-&gt;handler 在这里ipprot重载为tcp_protocol\r\n\t\t\t\t\t\t(handler 即为tcp_v4_rcv)</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fde030572796-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fde030572796-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fde030572796-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fde030572796-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fde030572796-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fde030572796-6\">6</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fde030572796-1\"><span class=\"crayon-v\">next_rx_action</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fde030572796-2\"><span class=\"crayon-h\">\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">_</span>backlog</div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fde030572796-3\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fde030572796-4\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">packet_type</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-i\">func</span><span class=\"crayon-h\"> </span>在这里我们考虑<span class=\"crayon-v\">ip_rcv</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fde030572796-5\"><span class=\"crayon-h\">\t\t\t\t\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ipprot</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-i\">handler</span><span class=\"crayon-h\"> </span>在这里<span class=\"crayon-i\">ipprot</span>重载为<span class=\"crayon-e\">tcp_protocol</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fde030572796-6\"><span class=\"crayon-h\">\t\t\t\t\t\t</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">handler</span><span class=\"crayon-h\"> </span>即为<span class=\"crayon-v\">tcp_v4_rcv</span><span class=\"crayon-sy\">)</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0015 seconds] -->\r\n<p>紧接着tcp_v4_rcv:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fe1411328300\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntcp_input.c\r\ntcp_v4_rcv\r\n\t|-tcp_v4_do_rcv\r\n\t\t|-tcp_rcv_state_process\r\n\t\t\t|-tcp_data_queue\r\n\t\t\t\t|-sk-&gt;sk_data_ready=sock_def_readable\r\n\t\t\t\t\t|-wake_up_interruptible\r\n\t\t\t\t\t\t|-__wake_up\r\n\t\t\t\t\t\t\t|-__wake_up_common</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fe1411328300-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fe1411328300-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fe1411328300-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fe1411328300-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fe1411328300-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fe1411328300-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fe1411328300-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fe1411328300-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fe1411328300-9\">9</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fe1411328300-1\"><span class=\"crayon-v\">tcp_input</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">c</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fe1411328300-2\"><span class=\"crayon-v\">tcp_v4_rcv</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fe1411328300-3\"><span class=\"crayon-h\">\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">tcp_v4_do_rcv</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fe1411328300-4\"><span class=\"crayon-h\">\t\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">tcp_rcv_state_process</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fe1411328300-5\"><span class=\"crayon-h\">\t\t\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">tcp_data_queue</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fe1411328300-6\"><span class=\"crayon-h\">\t\t\t\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">sk</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">sk_data_ready</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">sock_def_readable</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fe1411328300-7\"><span class=\"crayon-h\">\t\t\t\t\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">wake_up_interruptible</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fe1411328300-8\"><span class=\"crayon-h\">\t\t\t\t\t\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">__wake_up</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fe1411328300-9\"><span class=\"crayon-h\">\t\t\t\t\t\t\t</span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">__wake_up_common</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0012 seconds] -->\r\n<p>在这里__wake_up_common将停在当前wait_queue_head_t中的进程唤醒，即状态改为task_running，等待CFS调度以进行下一步的动作,如下图所示。</p>\n<p><img src=\"http://wx2.sinaimg.cn/mw690/63918611gy1fq9n18hqx2j20zq0kigng.jpg\"></p>\n<h4 id=\"h4_11\">情况2:设定的超时时间到来</h4>\n<p>在前面调用sk_wait_event中调用了schedule_timeout</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fe5676244713\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div><span class=\"crayon-language\">C</span></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nfastcall signed long __sched schedule_timeout(signed long timeout) {\r\n\t......\r\n\t// 设定超时的回掉函数为process_timeout\r\n\tsetup_timer(&amp;timer, process_timeout, (unsigned long)current);\r\n\t__mod_timer(&amp;timer, expire);\r\n\t// 这边让出CPU\r\n\tschedule();\r\n\tdel_singleshot_timer_sync(&amp;timer);\r\n\ttimeout = expire - jiffies;\r\n out:\r\n \t// 返回经过了多长事件\r\n\treturn timeout &lt; 0 ? 0 : timeout;\t\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fe5676244713-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fe5676244713-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fe5676244713-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fe5676244713-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fe5676244713-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fe5676244713-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fe5676244713-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fe5676244713-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fe5676244713-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fe5676244713-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fe5676244713-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fe5676244713-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fe5676244713-13\">13</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fe5676244713-1\"><span class=\"crayon-e\">fastcall </span><span class=\"crayon-t\">signed</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__sched </span><span class=\"crayon-e\">schedule_timeout</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">signed</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">timeout</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fe5676244713-2\"><span class=\"crayon-h\">\t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fe5676244713-3\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// 设定超时的回掉函数为process_timeout</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fe5676244713-4\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">setup_timer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">timer</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process_timeout</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">long</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">current</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fe5676244713-5\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">__mod_timer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">timer</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">expire</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fe5676244713-6\"><span class=\"crayon-h\">\t</span><span class=\"crayon-c\">// 这边让出CPU</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fe5676244713-7\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">schedule</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fe5676244713-8\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">del_singleshot_timer_sync</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">&amp;</span><span class=\"crayon-v\">timer</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fe5676244713-9\"><span class=\"crayon-h\">\t</span><span class=\"crayon-v\">timeout</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">expire</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jiffies</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fe5676244713-10\"><span class=\"crayon-h\"> </span><span class=\"crayon-v\">out</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fe5676244713-11\"><span class=\"crayon-h\"> \t</span><span class=\"crayon-c\">// 返回经过了多长事件</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fe5676244713-12\"><span class=\"crayon-h\">\t</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">timeout</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">timeout</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\">\t</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fe5676244713-13\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0391 seconds] -->\r\n<p>process_timeout函数即是将此进程重新唤醒</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3f0aca5fe8417657504\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div><span class=\"crayon-language\">C</span></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstatic void process_timeout(unsigned long __data)\r\n{\r\n\twake_up_process((struct task_struct *)__data);\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fe8417657504-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fe8417657504-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3f0aca5fe8417657504-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3f0aca5fe8417657504-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fe8417657504-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">process_timeout</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">unsigned</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">__data</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fe8417657504-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5ad3f0aca5fe8417657504-3\"><span class=\"crayon-h\">\t</span><span class=\"crayon-e\">wake_up_process</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">task_struct</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">__data</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3f0aca5fe8417657504-4\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0310 seconds] -->\r\n<p></p>\n<h2 id=\"h2_12\">总结</h2>\n<p>linux内核源代码博大精深，阅读其代码很费周折。希望笔者这篇文章能帮助到阅读linux网络协议栈代码的人。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113858\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113858votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113858\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/83781eed2f7e726b14e5d4ca2e1a602b8b53d469.jpg"}{"url_object_id": "5916e51b19bf349342b376e0f581f950", "title": "为初学者准备的 ln 命令教程（5 个示例）", "url": "http://blog.jobbole.com/113800/", "created_date": "2018/04/02", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2018/01/1b8322e1daff605d71fc81e724421f17.jpg"], "praise_nums": "1", "comments_nums": 0, "fav_nums": 0, "tags": "IT技术,Linux", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://www.howtoforge.com/linux-ln-command/\">Himanshu Arora</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-9501-1.html\">Linux中国/ChenYi</a>   </div><p>当我们在命令行上工作时，您可能需要在文件之间创建链接。这时，您可以可以借助一个专用命令，<code>ln</code>。本教程中，我们将通过一些简单易理解的例子来讨论此工具的基础知识。在此之前，值得一提的是，本教程所有例子都已在 Ubuntu 16.04 上测试通过。</p>\n<h3 id=\"toc_1\">Linux ln 命令</h3>\n<p>正如你现在所了解的，<code>ln</code> 命令能够让您在文件之间创建链接。下面就是 <code>ln</code> 工具的语法（或者使用其他一些可行的语法）。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ce37e545a323953625\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nln [OPTION]... [-T] TARGET LINK_NAME （第一种形式）\r\nln [OPTION]... TARGET （第二种形式）\r\nln [OPTION]... TARGET... DIRECTORY （第三种形式）\r\nln [OPTION]... -t DIRECTORY TARGET... （第四种形式）\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ce37e545a323953625-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce37e545a323953625-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce37e545a323953625-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce37e545a323953625-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3ce37e545a323953625-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ce37e545a323953625-1\"><span class=\"crayon-i\">ln</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">OPTION</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">T</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TARGET </span><span class=\"crayon-v\">LINK</span><span class=\"crayon-sy\">_</span>NAME<span class=\"crayon-h\"> </span>（第一种形式）</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce37e545a323953625-2\"><span class=\"crayon-i\">ln</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">OPTION</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">TARGET</span><span class=\"crayon-h\"> </span>（第二种形式）</div><div class=\"crayon-line\" id=\"crayon-5ad3ce37e545a323953625-3\"><span class=\"crayon-i\">ln</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">OPTION</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TARGET</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">DIRECTORY</span><span class=\"crayon-h\"> </span>（第三种形式）</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce37e545a323953625-4\"><span class=\"crayon-i\">ln</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">OPTION</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DIRECTORY </span><span class=\"crayon-v\">TARGET</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span>（第四种形式）</div><div class=\"crayon-line\" id=\"crayon-5ad3ce37e545a323953625-5\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0017 seconds] -->\r\n<p>下面是 <code>ln</code> 工具 man 文档描述的内容：</p>\n<blockquote><p>在第一种形式下，为目标位置（TARGET）创建一个叫 LINK_NAME 的链接。在第二种形式下，为目标位置（TARGET）在当前目录下创建一个链接（LCTT 译注：创建的为同名链接）。在第三和第四种形式中，在 DIRECTORY 目录下为每一个目标位置（TARGET）创建链接。默认创建硬链接，符号链接需要 <code>--symbolic</code> 选项。默认创建的每一个创建的链接（新链接的名字）都不能已经存在。当创建硬链接时，目标位置（TARGET）文件必须存在；符号链接可以保存任意文本，如果之后解析，相对链接的解析与其父目录有关。</p></blockquote>\n<p>通过下面问答风格的例子，可能会给你更好的理解。但是在此之前，建议您先了解 <a href=\"https://medium.com/meatandmachines/explaining-the-difference-between-hard-links-symbolic-links-using-bruce-lee-32828832e8d3\">硬链接和软链接的区别</a>.</p>\n<h3 id=\"toc_2\">Q1. 如何使用 ln 命令创建硬链接？</h3>\n<p>这很简单，你只需要像下面使用 <code>ln</code> 命令：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ce37e5466021463971\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nln [file] [hard-link-to-file]\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ce37e5466021463971-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce37e5466021463971-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ce37e5466021463971-1\"><span class=\"crayon-i\">ln</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">file</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">hard</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">link</span><span class=\"crayon-o\">-</span><span class=\"crayon-st\">to</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">file</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce37e5466021463971-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>例如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ce37e546a730876186\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nln test.txt test_hard_link.txt\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ce37e546a730876186-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce37e546a730876186-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ce37e546a730876186-1\"><span class=\"crayon-e\">ln </span><span class=\"crayon-v\">test</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">txt </span><span class=\"crayon-v\">test_hard_link</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">txt</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce37e546a730876186-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p><a href=\"https://www.howtoforge.com/images/command-tutorial/big/ln-hard-link.png\"><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2018/04/01298effe75946f995e7917f557462d5.png\" alt=\"如何使用 ln 命令创建硬链接\"></a></p>\n<p>如此，您便可以看见一个已经创建好的，名为 <code>test_hard_link.txt</code> 的硬链接。</p>\n<h3 id=\"toc_3\">Q2. 如何使用 ln 命令创建软/符号链接？</h3>\n<p>使用 <code>-s</code> 命令行选项：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ce37e546e880073958\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nln -s [file] [soft-link-to-file]\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ce37e546e880073958-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce37e546e880073958-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ce37e546e880073958-1\"><span class=\"crayon-v\">ln</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">s</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">file</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">soft</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">link</span><span class=\"crayon-o\">-</span><span class=\"crayon-st\">to</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">file</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce37e546e880073958-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>例如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ce37e5472487499932\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nln -s test.txt test_soft_link.txt\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ce37e5472487499932-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce37e5472487499932-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ce37e5472487499932-1\"><span class=\"crayon-v\">ln</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">s</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">test</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">txt </span><span class=\"crayon-v\">test_soft_link</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">txt</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce37e5472487499932-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p><a href=\"https://www.howtoforge.com/images/command-tutorial/big/ln-soft-link.png\"><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2018/04/50c704a6f945d0c923e4e0537f8c8074.png\" alt=\"如何使用 ln 命令创建软/符号链接\"></a></p>\n<p><code>test_soft_link.txt</code> 文件就是一个软/符号链接，以天蓝色文本 <a href=\"https://askubuntu.com/questions/17299/what-do-the-different-colors-mean-in-ls\">标识</a>。</p>\n<h3 id=\"toc_4\">Q3. 如何使用 ln 命令删除既存的同名目标文件？</h3>\n<p>默认情况下，<code>ln</code> 不允许您在目标目录下创建已存在的链接。</p>\n<p><a href=\"https://www.howtoforge.com/images/command-tutorial/big/ln-file-exists.png\"><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2018/04/e0fd2f36a9b21dba7e12ac1cb09ade9d.png\" alt=\"ln 命令示例\"></a></p>\n<p>然而，如果一定要这么做，您可以使用 <code>-f</code> 命令行选项覆盖此行为。</p>\n<p><a href=\"https://www.howtoforge.com/images/command-tutorial/big/ln-f-option.png\"><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2018/04/50acf4e490700767594928b22cfe2699.png\" alt=\"如何使用 ln 命令创建软/符号链接\"></a></p>\n<p>提示：如果您想在此删除过程中有所交互，您可以使用 <code>-i</code> 选项。</p>\n<h3 id=\"toc_5\">Q4. 如何使用 ln 命令创建现有文件的同名备份？</h3>\n<p>如果您不想 <code>ln</code> 删除同名的现有文件，您可以为这些文件创建备份。使用 <code>-b</code> 即可实现此效果，以这种方式创建的备份文件，会在其文件名结尾处包含一个波浪号（<code>~</code>）。</p>\n<p><a href=\"https://www.howtoforge.com/images/command-tutorial/big/ln-b-option.png\"><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2018/04/4c82e6ffb43f28c1e41aa82208cb755a.png\" alt=\"如何使用 ln 命令创建现有文件的同名备份\"></a></p>\n<h3 id=\"toc_6\">Q5. 如何在当前目录以外的其它目录创建链接？</h3>\n<p>使用 <code>-t</code> 选项指定一个文件目录（除了当前目录）。比如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3ce37e5476288941790\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nls test* | xargs ln -s -t /home/himanshu/Desktop/\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3ce37e5476288941790-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3ce37e5476288941790-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3ce37e5476288941790-1\"><span class=\"crayon-e\">ls </span><span class=\"crayon-e \">test*</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">xargs </span><span class=\"crayon-v\">ln</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">s</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">home</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">himanshu</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">Desktop</span><span class=\"crayon-o\">/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3ce37e5476288941790-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>上述命令会为（当前目录下的）所有 <code>test*</code> 文件创建链接，并放到桌面目录下。</p>\n<h3 id=\"toc_7\">总结</h3>\n<p>当然，尤其对于新手来说，<code>ln</code> 并不是日常必备命令。但是，这是一个有用的命令，因为你永远不知道它什么时候能够节省你一天的时间。对于这个命令，我们已经讨论了一些实用的选项，如果你已经完成了这些，可以查询 <a href=\"https://linux.die.net/man/1/ln\">man 文档</a> 来了解更多详情。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113800\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113800votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113800\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/14452eea6b79bce0219227f298ad827f2ba7112d.jpg"}{"url_object_id": "ab0322e9007276c76fe370fbf4a95a33", "title": "Linux 中的“大内存页”（hugepage）是个什么？", "url": "http://blog.jobbole.com/113782/", "created_date": "2018/03/24", "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2018/01/1b8322e1daff605d71fc81e724421f17.jpg"], "praise_nums": "1", "comments_nums": 0, "fav_nums": 1, "tags": "IT技术,Linux", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://kerneltalks.com/services/what-is-huge-pages-in-linux/\">Shrikant Lavhate</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-9450-1.html\">Linux中国/DarkSun</a>   </div><blockquote><p>学习 Linux 中的大内存页hugepage。理解什么是“大内存页”，如何进行配置，如何查看当前状态以及如何禁用它。</p></blockquote>\n<p>本文中我们会详细介绍大内存页huge page，让你能够回答：Linux 中的“大内存页”是什么？在 RHEL6、RHEL7、Ubuntu 等 Linux 中，如何启用/禁用“大内存页”？如何查看“大内存页”的当前值？</p>\n<p>首先让我们从“大内存页”的基础知识开始讲起。</p>\n<h3 id=\"toc_1\">Linux 中的“大内存页”是个什么玩意？</h3>\n<p>“大内存页”有助于 Linux 系统进行虚拟内存管理。顾名思义，除了标准的 4KB 大小的页面外，它们还能帮助管理内存中的巨大的页面。使用“大内存页”，你最大可以定义 1GB 的页面大小。</p>\n<p>在系统启动期间，你能用“大内存页”为应用程序预留一部分内存。这部分内存，即被“大内存页”占用的这些存储器永远不会被交换出内存。它会一直保留其中，除非你修改了配置。这会极大地提高像 Oracle 数据库这样的需要海量内存的应用程序的性能。</p>\n<h3 id=\"toc_2\">为什么使用“大内存页”？</h3>\n<p>在虚拟内存管理中，内核维护一个将虚拟内存地址映射到物理地址的表，对于每个页面操作，内核都需要加载相关的映射。如果你的内存页很小，那么你需要加载的页就会很多，导致内核会加载更多的映射表。而这会降低性能。</p>\n<p>使用“大内存页”，意味着所需要的页变少了。从而大大减少由内核加载的映射表的数量。这提高了内核级别的性能最终有利于应用程序的性能。</p>\n<p>简而言之，通过启用“大内存页”，系统具只需要处理较少的页面映射表，从而减少访问/维护它们的开销！</p>\n<h3 id=\"toc_3\">如何配置“大内存页”？</h3>\n<p>运行下面命令来查看当前“大内存页”的详细内容。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3e00b70575064777651\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nroot@kerneltalks # grep Huge /proc/meminfo\r\nAnonHugePages:         0 kB\r\nHugePages_Total:       0\r\nHugePages_Free:        0\r\nHugePages_Rsvd:        0\r\nHugePages_Surp:        0\r\nHugepagesize:       2048 kB\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b70575064777651-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b70575064777651-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b70575064777651-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b70575064777651-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b70575064777651-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b70575064777651-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b70575064777651-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b70575064777651-8\">8</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3e00b70575064777651-1\"><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">kerneltalks</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\"># grep Huge /proc/meminfo</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b70575064777651-2\"><span class=\"crayon-v\">AnonHugePages</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">         </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">kB</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b70575064777651-3\"><span class=\"crayon-v\">HugePages_Total</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b70575064777651-4\"><span class=\"crayon-v\">HugePages_Free</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b70575064777651-5\"><span class=\"crayon-v\">HugePages_Rsvd</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b70575064777651-6\"><span class=\"crayon-v\">HugePages_Surp</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b70575064777651-7\"><span class=\"crayon-v\">Hugepagesize</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">2048</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">kB</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b70575064777651-8\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p>从上面输出可以看到，每个页的大小为 2MB（<code>Hugepagesize</code>），并且系统中目前有 <code>0</code> 个“大内存页”（<code>HugePages_Total</code>）。这里“大内存页”的大小可以从 <code>2MB</code> 增加到 <code>1GB</code>。</p>\n<p>运行下面的脚本可以知道系统当前需要多少个巨大页。该脚本取之于 Oracle。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3e00b7057f079143081\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#!/bin/bash\r\n#\r\n# hugepages_settings.sh\r\n#\r\n# Linux bash script to compute values for the\r\n# recommended HugePages/HugeTLB configuration\r\n#\r\n# Note: This script does calculation for all shared memory\r\n# segments available when the script is run, no matter it\r\n# is an Oracle RDBMS shared memory segment or not.\r\n# Check for the kernel version\r\nKERN=`uname -r | awk -F. '{ printf(\"%d.%d\\n\",$1,$2); }'`\r\n# Find out the HugePage size\r\nHPG_SZ=`grep Hugepagesize /proc/meminfo | awk {'print $2'}`\r\n# Start from 1 pages to be on the safe side and guarantee 1 free HugePage\r\nNUM_PG=1\r\n# Cumulative number of pages required to handle the running shared memory segments\r\nfor SEG_BYTES in `ipcs -m | awk {'print $5'} | grep \"[0-9][0-9]*\"`\r\ndo\r\n   MIN_PG=`echo \"$SEG_BYTES/($HPG_SZ*1024)\" | bc -q`\r\n   if [ $MIN_PG -gt 0 ]; then\r\n      NUM_PG=`echo \"$NUM_PG+$MIN_PG+1\" | bc -q`\r\n   fi\r\ndone\r\n# Finish with results\r\ncase $KERN in\r\n   '2.4') HUGETLB_POOL=`echo \"$NUM_PG*$HPG_SZ/1024\" | bc -q`;\r\n          echo \"Recommended setting: vm.hugetlb_pool = $HUGETLB_POOL\" ;;\r\n   '2.6' | '3.8' | '3.10' | '4.1' ) echo \"Recommended setting: vm.nr_hugepages = $NUM_PG\" ;;\r\n    *) echo \"Unrecognized kernel version $KERN. Exiting.\" ;;\r\nesac\r\n# End\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7057f079143081-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7057f079143081-33\">33</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-1\"><span class=\"crayon-p\">#!/bin/bash</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-2\"><span class=\"crayon-p\">#</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-3\"><span class=\"crayon-p\"># hugepages_settings.sh</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-4\"><span class=\"crayon-p\">#</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-5\"><span class=\"crayon-p\"># Linux bash script to compute values for the</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-6\"><span class=\"crayon-p\"># recommended HugePages/HugeTLB configuration</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-7\"><span class=\"crayon-p\">#</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-8\"><span class=\"crayon-p\"># Note: This script does calculation for all shared memory</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-9\"><span class=\"crayon-p\"># segments available when the script is run, no matter it</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-10\"><span class=\"crayon-p\"># is an Oracle RDBMS shared memory segment or not.</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-11\"><span class=\"crayon-p\"># Check for the kernel version</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-12\"><span class=\"crayon-v\">KERN</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">uname</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">r</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">awk</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">F</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'{ printf(\"%d.%d\\n\",$1,$2); }'</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-13\"><span class=\"crayon-p\"># Find out the HugePage size</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-14\"><span class=\"crayon-v\">HPG_SZ</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-e\">grep </span><span class=\"crayon-v\">Hugepagesize</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">proc</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">meminfo</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">awk</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-s\">'print $2'</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-15\"><span class=\"crayon-p\"># Start from 1 pages to be on the safe side and guarantee 1 free HugePage</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-16\"><span class=\"crayon-v\">NUM_PG</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-17\"><span class=\"crayon-p\"># Cumulative number of pages required to handle the running shared memory segments</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-18\"><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SEG_BYTES </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">ipcs</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">m</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">awk</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-s\">'print $5'</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">grep</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"[0-9][0-9]*\"</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-19\"><span class=\"crayon-st\">do</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-20\"><span class=\"crayon-h\">   </span><span class=\"crayon-v\">MIN_PG</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"$SEG_BYTES/($HPG_SZ*1024)\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">bc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">q</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-21\"><span class=\"crayon-h\">   </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">MIN_PG</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">gt</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">then</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-22\"><span class=\"crayon-h\">      </span><span class=\"crayon-v\">NUM_PG</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"$NUM_PG+$MIN_PG+1\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">bc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">q</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-23\"><span class=\"crayon-h\">   </span><span class=\"crayon-e\">fi</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-24\"><span class=\"crayon-v\">done</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-25\"><span class=\"crayon-p\"># Finish with results</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-26\"><span class=\"crayon-st\">case</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-e\">KERN </span><span class=\"crayon-st\">in</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-27\"><span class=\"crayon-h\">   </span><span class=\"crayon-s\">'2.4'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">HUGETLB_POOL</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"$NUM_PG*$HPG_SZ/1024\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">bc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">q</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-28\"><span class=\"crayon-h\">          </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Recommended setting: vm.hugetlb_pool = $HUGETLB_POOL\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">;</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-29\"><span class=\"crayon-h\">   </span><span class=\"crayon-s\">'2.6'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'3.8'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'3.10'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'4.1'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Recommended setting: vm.nr_hugepages = $NUM_PG\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">;</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-30\"><span class=\"crayon-h\">    </span><span class=\"crayon-o\">*</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Unrecognized kernel version $KERN. Exiting.\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">;</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-31\"><span class=\"crayon-v\">esac</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7057f079143081-32\"><span class=\"crayon-p\"># End</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7057f079143081-33\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0043 seconds] -->\r\n<p>将它以 <code>hugepages_settings.sh</code> 为名保存到 <code>/tmp</code> 中，然后运行之：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3e00b70585701269806\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nroot@kerneltalks # sh /tmp/hugepages_settings.sh\r\nRecommended setting: vm.nr_hugepages = 124\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b70585701269806-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b70585701269806-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b70585701269806-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3e00b70585701269806-1\"><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">kerneltalks</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\"># sh /tmp/hugepages_settings.sh</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b70585701269806-2\"><span class=\"crayon-e\">Recommended </span><span class=\"crayon-v\">setting</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">vm</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">nr_hugepages</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">124</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b70585701269806-3\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>你的输出类似如上结果，只是数字会有一些出入。</p>\n<p>这意味着，你系统需要 124 个每个 2MB 的“大内存页”！若你设置页面大小为 4MB，则结果就变成了 62。你明白了吧？</p>\n<h3 id=\"toc_4\">配置内核中的“大内存页”</h3>\n<p>本文最后一部分内容是配置上面提到的 <a href=\"https://kerneltalks.com/linux/how-to-tune-kernel-parameters-in-linux/\">内核参数 </a> ，然后重新加载。将下面内容添加到 <code>/etc/sysctl.conf</code> 中，然后输入 <code>sysctl -p</code> 命令重新加载配置。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3e00b70589475893076\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nvm.nr_hugepages=126\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b70589475893076-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b70589475893076-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3e00b70589475893076-1\"><span class=\"crayon-v\">vm</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">nr_hugepages</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">126</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b70589475893076-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>注意我们这里多加了两个额外的页，因为我们希望在实际需要的页面数量之外多一些额外的空闲页。</p>\n<p>现在，内核已经配置好了，但是要让应用能够使用这些“大内存页”还需要提高内存的使用阀值。新的内存阀值应该为 126 个页 x 每个页 2 MB = 252 MB，也就是 258048 KB。</p>\n<p>你需要编辑 <code>/etc/security/limits.conf</code> 中的如下配置：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5ad3e00b7058d353566581\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsoft memlock 258048\r\nhard memlock 258048\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7058d353566581-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5ad3e00b7058d353566581-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5ad3e00b7058d353566581-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5ad3e00b7058d353566581-1\"><span class=\"crayon-e\">soft </span><span class=\"crayon-i\">memlock</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">258048</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5ad3e00b7058d353566581-2\"><span class=\"crayon-e\">hard </span><span class=\"crayon-i\">memlock</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">258048</span></div><div class=\"crayon-line\" id=\"crayon-5ad3e00b7058d353566581-3\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>某些情况下，这些设置是在指定应用的文件中配置的，比如 Oracle DB 就是在 <code>/etc/security/limits.d/99-grid-oracle-limits.conf</code> 中配置的。</p>\n<p>这就完成了！你可能还需要重启应用来让应用来使用这些新的巨大页。</p>\n<p>（LCTT 译注：此外原文有误，“透明大内存页”和“大内存页”不同，而且，在 Redhat 系统中，“大内存页” 不是默认启用的，而“透明大内存页”是启用的。因此这个段落删除了。）</p>\n<p> </p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113782\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113782votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113782\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "front_image_path": "full/14452eea6b79bce0219227f298ad827f2ba7112d.jpg"}